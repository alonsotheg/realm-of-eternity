<!DOCTYPE html>
<!-- Cache bust: 2026-01-18 -->
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Realm of Eternity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    /* ============================================
       DARK FANTASY COLOR SCHEME - CSS VARIABLES
       ============================================ */
    :root {
      /* Background Colors - darkened page, brightened panels for depth */
      --bg-page: #161619;
      --bg-page-gradient: linear-gradient(145deg, #1a1a20 0%, #121215 50%, #161619 100%);
      --bg-panel: rgba(32, 32, 38, 0.95);
      --bg-panel-dark: rgba(22, 22, 26, 0.98);
      --bg-panel-light: rgba(42, 42, 50, 0.9);

      /* Border Colors */
      --border-dark: #0d0d0f;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-panel: #252528;

      /* Text Colors - optimized for readability */
      --text-primary: #e8e8ec;
      --text-secondary: #a8a8b0;
      --text-muted: #68686f;
      --text-heading: #f4f4f6;

      /* Accent Colors - warmer gold, cooler blue */
      --accent-gold: #daa520;
      --accent-gold-bright: #f4c430;
      --accent-gold-dim: #a67c00;
      --accent-red: #c45050;
      --accent-red-bright: #e06060;
      --accent-red-dim: #8a3030;
      --accent-green: #50a060;
      --accent-green-bright: #60c070;
      --accent-blue: #4a7fad;
      --accent-blue-bright: #5a9fd0;
      --accent-blue-dim: #355a7a;
      
      /* UI Element Colors */
      --btn-bg: linear-gradient(180deg, #3a3a42 0%, #2a2a32 100%);
      --btn-bg-hover: linear-gradient(180deg, #454550 0%, #353540 100%);
      --btn-border: #1a1a1e;
      --input-bg: rgba(20, 20, 24, 0.8);
    }

    /* ============================================
       BASE STYLES
       ============================================ */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      background: var(--bg-page);
      background-image: 
        /* Subtle noise texture via gradient */
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.03) 2px,
          rgba(0, 0, 0, 0.03) 4px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.03) 2px,
          rgba(0, 0, 0, 0.03) 4px
        ),
        /* Main gradient */
        var(--bg-page-gradient);
      background-attachment: fixed;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* Vignette effect */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at center, transparent 40%, rgba(0, 0, 0, 0.4) 100%);
      z-index: 9999;
    }

    /* Text defaults */
    body, p, span, div, button, select, option, input, textarea, label,
    h1, h2, h3, h4, h5, h6, small {
      text-decoration: none;
    }

    a, a:visited, a:hover, a:active {
      color: inherit;
      text-decoration: none !important;
    }

    .no-underline, .no-underline * {
      text-decoration: none !important;
    }

    /* Headings */
    h1, h2, h3, .font-heading {
      font-family: 'Outfit', sans-serif;
      color: var(--text-heading);
    }

    /* Focus styles */
    :focus-visible {
      outline: 2px solid var(--accent-gold-dim);
      outline-offset: 2px;
    }

    input:focus, select:focus, button:focus {
      outline: 2px solid var(--accent-gold-dim);
      outline-offset: 1px;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ============================================
       PANEL / CARD STYLES
       ============================================ */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-panel);
      border-radius: 4px;
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .panel-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.15);
    }

    .panel-body {
      padding: 12px;
    }

    /* Legacy glass-card support */
    .glass-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-panel);
      border-radius: 4px;
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .glass-card:hover {
      border-color: var(--border-panel);
    }

    .glass-card::before {
      display: none;
    }

    /* ============================================
       INVENTORY GRID
       ============================================ */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 64px);
      gap: 4px;
      padding: 4px;
    }

    .inventory-grid-compact {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
      gap: 3px;
      padding: 4px;
    }

    .inventory-grid::-webkit-scrollbar,
    .inventory-grid-compact::-webkit-scrollbar {
      width: 4px;
    }

    .inventory-grid::-webkit-scrollbar-thumb,
    .inventory-grid-compact::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 2px;
    }

    /* ============================================
       PROGRESS / STAT BARS
       ============================================ */
    .stat-bar {
      height: 6px;
      border-radius: 2px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border-dark);
      overflow: hidden;
    }

    .stat-fill {
      height: 100%;
      border-radius: 1px;
      transition: width 0.2s ease-out;
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn-action {
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      border-radius: 3px;
      color: var(--text-primary);
      transition: all 0.15s ease;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .btn-action:hover:not(:disabled) {
      background: var(--btn-bg-hover);
      border-color: var(--border-panel);
      filter: brightness(1.1);
      box-shadow:
        0 3px 6px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .btn-action:active:not(:disabled) {
      transform: translateY(1px);
      filter: brightness(0.95);
    }

    .btn-action:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
      border: 1px solid var(--accent-gold-dim);
      color: #000;
      font-weight: 700;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.3),
        0 0 12px rgba(218, 165, 32, 0.25);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(180deg, var(--accent-gold-bright) 0%, var(--accent-gold) 100%);
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.3),
        0 0 18px rgba(244, 196, 48, 0.35);
    }

    /* ============================================
       SEMANTIC TEXT COLOR UTILITIES
       ============================================ */
    .text-gold { color: var(--accent-gold); }
    .text-gold-bright { color: var(--accent-gold-bright); }
    .text-danger { color: var(--accent-red); }
    .text-danger-bright { color: var(--accent-red-bright); }
    .text-success { color: var(--accent-green); }
    .text-success-bright { color: var(--accent-green-bright); }
    .text-nav { color: var(--accent-blue); }
    .text-nav-bright { color: var(--accent-blue-bright); }
    .text-muted-custom { color: var(--text-muted); }

    /* ============================================
       LAYOUT - DESKTOP (3-COLUMN)
       ============================================ */
    #root {
      width: 100%;
      min-height: 100vh;
    }

    .game-root {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
    }

    /* Top Navigation Bar */
    .top-bar {
      flex-shrink: 0;
      background: var(--bg-panel-dark);
      border-bottom: 1px solid var(--border-panel);
      padding: 8px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Main 3-column layout */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .main-content {
        display: grid;
        grid-template-columns: 260px 1fr 300px;
        gap: 12px;
        padding: 12px;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
      }

      .col-left,
      .col-center,
      .col-right {
        overflow-y: auto;
        overflow-x: hidden;
        max-height: calc(100vh - 60px);
      }

      .mobile-grid-2col {
        grid-template-columns: 1fr;
      }

      .mobile-grid-2col > * {
        min-width: 250px;
      }
    }

    /* Mobile stacked layout */
    @media (max-width: 1023px) {
      .main-content {
        padding: 8px;
        gap: 8px;
      }

      .col-left,
      .col-center,
      .col-right {
        width: 100%;
      }

      .mobile-side-by-side {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }

      .mobile-side-by-side > * {
        min-width: 0;
      }

      .mobile-side-by-side-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .mobile-side-by-side-2col > * {
        min-width: 0;
      }

      .mobile-side-by-side-2col > .panel {
        min-height: 650px;
        max-height: 650px;
      }

      .mobile-grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
      }

      .home-inv-section {
        min-height: 350px;
      }

      .home-inv-section .inventory-grid {
        max-height: 320px;
      }
    }

    .home-panel {
      min-height: 550px;
    }

    .scrollable-col {
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fadeIn 0.25s ease-out forwards;
    }

    /* ============================================
       SECTION-SPECIFIC STYLES
       ============================================ */
    /* Combat section red accent with atmosphere */
    .combat-panel {
      border-color: var(--accent-red-dim);
      background: linear-gradient(180deg, rgba(138, 48, 48, 0.08) 0%, transparent 100%), var(--bg-panel);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(196, 80, 80, 0.08),
        inset 0 1px 0 rgba(196, 80, 80, 0.1);
    }

    /* Skilling panel - gold accent with atmosphere */
    .panel-skilling {
      border-left: 2px solid var(--accent-gold-dim);
      background: linear-gradient(180deg, rgba(218, 165, 32, 0.05) 0%, transparent 100%), var(--bg-panel);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 0 15px rgba(218, 165, 32, 0.06),
        inset 0 1px 0 rgba(218, 165, 32, 0.08);
    }

    /* Navigation/Travel panel - blue accent with atmosphere */
    .panel-navigation {
      border-left: 2px solid var(--accent-blue);
      background: linear-gradient(180deg, rgba(74, 127, 173, 0.06) 0%, transparent 100%), var(--bg-panel);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 0 15px rgba(74, 127, 173, 0.06),
        inset 0 1px 0 rgba(74, 127, 173, 0.08);
    }

    /* Shop panel - gold accent with atmosphere */
    .panel-shop {
      border-left: 2px solid var(--accent-gold-dim);
      background: linear-gradient(180deg, rgba(218, 165, 32, 0.05) 0%, transparent 100%), var(--bg-panel);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 0 15px rgba(218, 165, 32, 0.06),
        inset 0 1px 0 rgba(218, 165, 32, 0.08);
    }

    /* HP bar colors */
    .hp-bar-player { background: var(--accent-red); }
    .hp-bar-enemy { background: var(--accent-red-dim); }

    /* XP bar gold */
    .xp-bar { background: var(--accent-gold); }

    /* Section titles */
    .section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      padding-bottom: 6px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border-subtle);
    }

    /* Item slot styling */
    .item-slot {
      aspect-ratio: 1;
      background: var(--bg-panel-light);
      border: 2px solid var(--border-dark);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.15s ease;
    }

    /* White center glow effect for item slots */
    .item-slot::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      height: 90%;
      background: radial-gradient(ellipse, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.3) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 80%);
      pointer-events: none;
      z-index: 0;
    }

    .item-slot > * {
      position: relative;
      z-index: 1;
    }

    /* SCENE IMAGE CENTERING FIX */
    .scene-panel {
      width: 100%;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .scene-image-container {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scene-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center center;
    }

    /* ============================================
       MAP NAVIGATION STYLES
       ============================================ */

    /* Island map container */
    .island-map {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      max-width: 236px;
      margin: 0 auto;
      border-radius: 50%;
      overflow: hidden;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
        radial-gradient(ellipse 70% 65% at 50% 50%,
          rgba(34, 197, 94, 0.25) 0%,
          rgba(34, 197, 94, 0.15) 40%,
          rgba(59, 130, 246, 0.2) 60%,
          rgba(30, 64, 175, 0.3) 100%
        ),
        linear-gradient(180deg, #1e3a5f 0%, #1e40af33 100%);
      border: 2px solid rgba(59, 130, 246, 0.3);
      box-shadow:
        inset 0 0 30px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(59, 130, 246, 0.2);
    }

    /* Location node base */
    .map-node {
      position: absolute;
      transform: translate(-50%, -50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      background: rgba(28, 28, 32, 0.9);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    /* Touch-friendly sizing */
    @media (pointer: coarse) {
      .map-node {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
    }

    /* Current location - glowing highlight (warmer gold) */
    .map-node-current {
      border-color: var(--accent-gold);
      box-shadow:
        0 0 0 3px rgba(218, 165, 32, 0.35),
        0 0 20px rgba(218, 165, 32, 0.6),
        0 2px 8px rgba(0, 0, 0, 0.4);
      animation: pulse-gold 2s ease-in-out infinite;
    }

    @keyframes pulse-gold {
      0%, 100% { box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.35), 0 0 20px rgba(218, 165, 32, 0.6); }
      50% { box-shadow: 0 0 0 5px rgba(218, 165, 32, 0.25), 0 0 30px rgba(218, 165, 32, 0.7); }
    }

    /* Adjacent location - clickable */
    .map-node-adjacent {
      border-color: rgba(74, 222, 128, 0.6);
      cursor: pointer;
    }

    .map-node-adjacent:hover {
      border-color: rgba(74, 222, 128, 1);
      transform: translate(-50%, -50%) scale(1.15);
      box-shadow:
        0 0 0 3px rgba(74, 222, 128, 0.3),
        0 0 12px rgba(74, 222, 128, 0.4),
        0 4px 12px rgba(0, 0, 0, 0.5);
    }

    /* Non-adjacent location - disabled */
    .map-node-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      filter: grayscale(50%);
    }

    /* Traveling destination - pulsing cool blue */
    .map-node-destination {
      border-color: rgba(90, 159, 208, 0.8);
      box-shadow:
        0 0 0 3px rgba(90, 159, 208, 0.3),
        0 0 18px rgba(90, 159, 208, 0.5);
      animation: pulse-blue 1s ease-in-out infinite;
    }

    @keyframes pulse-blue {
      0%, 100% { box-shadow: 0 0 0 3px rgba(90, 159, 208, 0.3), 0 0 18px rgba(90, 159, 208, 0.5); }
      50% { box-shadow: 0 0 0 6px rgba(90, 159, 208, 0.2), 0 0 28px rgba(90, 159, 208, 0.7); }
    }

    /* Traveling state - all nodes except destination are dimmed */
    .map-node-traveling {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Location name tooltip */
    .map-node-label {
      position: absolute;
      bottom: -22px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.85);
      color: #e2e2e6;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 10;
    }

    .map-node:hover .map-node-label,
    .map-node-current .map-node-label {
      opacity: 1;
    }

    /* Connection lines between adjacent locations */
    .map-connections {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .map-connection-line {
      stroke: rgba(255, 255, 255, 0.15);
      stroke-width: 1.5;
      stroke-dasharray: 4, 4;
    }

    .map-connection-line-active {
      stroke: rgba(74, 222, 128, 0.4);
      stroke-width: 2;
    }

    .item-slot:hover {
      border-color: var(--text-muted);
      background: rgba(50, 50, 58, 0.9);
    }

    /* INVENTORY DRAG & DROP */
    .item-slot[draggable="true"] {
      cursor: grab;
    }
    .item-slot.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .item-slot.drag-over {
      border-color: #fbbf24 !important;
      background: rgba(251, 191, 36, 0.2) !important;
    }

    /* Compact text utilities */
    .text-xs-compact { font-size: 10px; line-height: 1.3; }
    .text-xxs { font-size: 9px; line-height: 1.2; }

    /* Legacy application-root support */
    .application-root {
      display: contents;
    }

    /* Game layout legacy support - redirects to new system */
    .game-layout {
      display: contents;
    }
  </style>
</head>

<body class="text-white">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TABLE OF CONTENTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

       1. CONSTANTS & CONFIGURATION
          - Training/travel durations, skill lists, combat multipliers

       2. GAME DATA
          - Item Images (PNG paths)
          - Items Data (stats, icons, requirements, heal values)
          - Loot Chests (chest drop tables)
          - Resource Tiers (gathering skills: mining, woodcutting, fishing)
          - Cooking Recipes
          - Crafting Recipes (smithing)
          - Locations, Enemies & Drop Tables

       3. HELPER FUNCTIONS
          - getItemName() - Format item names

       4. REACT COMPONENTS
          - ItemIcon - Displays PNG or emoji fallback

       5. MAIN GAME COMPONENT
          - State Management
          - Game Logic Functions (combat, skills, inventory, etc.)
          - UI Rendering

       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const { useState, useEffect, useRef } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONSTANTS & CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const TRAIN_DURATION = 5000;
    // TRAVEL TIMER LOGIC - Fixed travel duration constant
    const TRAVEL_DURATION = 8000; // 8 seconds, no scaling or modifiers

    // LOCATION ADJACENCY GRAPH - Defines which locations are connected for map navigation
    const LOCATION_ADJACENCY = {
      "starter-village": ["forest", "cave", "fishing-pond", "blacksmith"],
      "blacksmith": ["starter-village"],
      "forest": ["starter-village", "mountains"],
      "cave": ["starter-village", "volcanic-plain"],
      "fishing-pond": ["starter-village", "volcanic-plain"],
      "volcanic-plain": ["cave", "fishing-pond", "mountains"],
      "mountains": ["forest", "volcanic-plain"]
    };

    // MAP NODE POSITIONS AND ICONS - Geographic layout for island map
    const LOCATION_MAP_DATA = {
      "starter-village": { icon: "ğŸ˜ï¸", name: "Starter Village", position: { top: "50%", left: "45%" } },
      "blacksmith": { icon: "ğŸ”¨", name: "Blacksmith", position: { top: "55%", left: "30%" } },
      "forest": { icon: "ğŸŒ²", name: "Forest", position: { top: "20%", left: "55%" } },
      "cave": { icon: "ğŸ•³ï¸", name: "Cave", position: { top: "45%", left: "75%" } },
      "fishing-pond": { icon: "ğŸ£", name: "Fishing Pond", position: { top: "70%", left: "65%" } },
      "volcanic-plain": { icon: "ğŸŒ‹", name: "Volcanic Plain", position: { top: "85%", left: "40%" } },
      "mountains": { icon: "â›°ï¸", name: "Mountains", position: { top: "15%", left: "25%" } }
    };

    // SCENE IMAGE CONFIGURATION
    // Add your image paths here. Images should be placed in assets/scenes/ folder
    // Set to null or remove entry to use gradient fallback
    const SCENE_IMAGES = {
      // Location idle images - shown when standing in a location
      locations: {
        "starter-village": "assets/scenes/village.png",
        "forest": "assets/scenes/forest.png",
        "cave": "assets/scenes/cave.png",
        "blacksmith": "assets/scenes/blacksmith.png",
        "fishing-pond": "assets/scenes/fishing_pond.png",
        "mountains": "assets/scenes/mountains.png",
        "volcanic-plain": "assets/scenes/volcanic_plain.png"
      },
      // Traveling images - shown during travel animation
      traveling: {
        "default": "assets/scenes/traveling.png"
      },
      // Combat images - shown when fighting enemies
      combat: {
        "default": "assets/scenes/combat.png",
        // All enemy types
        "Goblin": "assets/scenes/combat_goblin.png",
        "Goblin Captain": "assets/scenes/combat_goblin_captain.png",
        "Goblin General": "assets/scenes/combat_goblin_general.png",
        "Bat": "assets/scenes/combat_bat.png",
        "Wolf": "assets/scenes/combat_wolf.png",
        "Ogre": "assets/scenes/combat_ogre.png",
        "Giant Frog": "assets/scenes/combat_giant_frog.png",
        "Rock Crab": "assets/scenes/combat_rock_crab.png",
        "Ash Drake Whelp": "assets/scenes/combat_ash_drake_whelp.png",
        "Ash Drake": "assets/scenes/combat_ash_drake.png",
        "Golem": "assets/scenes/combat_golem.png",
        "Dragon": "assets/scenes/combat_dragon.png",
        "Elder Dragon": "assets/scenes/combat_elder_dragon.png"
      },
      // Skilling images - shown when training skills
      skilling: {
        "mining": "assets/scenes/mining.png",
        "woodcutting": "assets/scenes/woodcutting.png",
        "fishing": "assets/scenes/fishing.png",
        "cooking": "assets/scenes/cooking.png",
        "smithing": "assets/scenes/smithing.png",
        "herblore": "assets/scenes/herblore.png"
      }
    };

    const ALL_SKILLS = ["mining", "woodcutting", "fishing", "cooking", "strength", "smithing", "herblore", "farming"];
    const COMBAT_STATS = ["health", "attack", "defense"];
    // Multiplier controlling how effective equipment defense is (1.0 = full, 0.5 = half effectiveness)
    const EQUIP_DEFENSE_MULT = 0.5;
    // Attack variance percentages (min, max). Values are fractions of the attack stat.
    const PLAYER_ATTACK_MIN_PCT = 0.8;
    const PLAYER_ATTACK_MAX_PCT = 1.0;
    const ENEMY_ATTACK_MIN_PCT = 0.8;
    const ENEMY_ATTACK_MAX_PCT = 1.0;
    const ALL_PLAYER_SKILLS = [...ALL_SKILLS, ...COMBAT_STATS];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - ITEM IMAGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Items with custom PNG images
    const ITEM_IMAGES = {
      // Weapons
      "sword": "assets/items/sword.png",
      "iron_sword": "assets/items/iron_sword.png",
      "dragon_sword": "assets/items/dragon_sword.png",
      "elder_sword": "assets/items/elder_sword.png",
      // Armor - Head
      "bronze_helmet": "assets/items/bronze_helmet.png",
      "iron_helmet": "assets/items/iron_helmet.png",
      "steel_helmet": "assets/items/steel_helmet.png",
      // Armor - Body
      "bronze_platebody": "assets/items/bronze_platebody.png",
      "iron_platebody": "assets/items/iron_platebody.png",
      "platebody": "assets/items/bronze_platebody.png",
      "steel_platebody": "assets/items/steel_platebody.png",
      "steel_armor": "assets/items/steel_platebody.png",
      // Armor - Legs
      "bronze_platelegs": "assets/items/bronze_platelegs.png",
      "iron_platelegs": "assets/items/iron_platelegs.png",
      "steel_platelegs": "assets/items/steel_platelegs.png",
      "legs": "assets/items/bronze_platelegs.png",
      // Armor - Boots
      "leather_boots": "assets/items/leather_boots.png",
      "bronze_boots": "assets/items/bronze_boots.png",
      "iron_boots": "assets/items/iron_boots.png",
      "steel_boots": "assets/items/steel_boots.png",
      // Offhand
      "bronze_shield": "assets/items/bronze_shield.png",
      "iron_shield": "assets/items/iron_shield.png",
      "steel_shield": "assets/items/steel_shield.png",
      "shield": "assets/items/bronze_shield.png",
      // Accessories
      "ring": "assets/items/ring.png",
      "dragon_amulet": "assets/items/dragon_amulet.png",
      // Tools
      "bronze_pickaxe": "assets/items/bronze_pickaxe.png",
      "iron_pickaxe": "assets/items/iron_pickaxe.png",
      "steel_pickaxe": "assets/items/steel_pickaxe.png",
      "bronze_axe": "assets/items/bronze_axe.png",
      "iron_axe": "assets/items/iron_axe.png",
      "steel_axe": "assets/items/steel_axe.png",
      // Resources
      "copper": "assets/items/copper.png",
      "iron": "assets/items/iron.png",
      "coal": "assets/items/coal.png",
      "wood": "assets/items/wood.png",
      "greenleaf": "assets/items/greenleaf.png",
      // Fish
      "shrimp": "assets/items/shrimp.png",
      "trout": "assets/items/trout.png",
      "salmon": "assets/items/salmon.png",
      "cooked_shrimp": "assets/items/cooked_shrimp.png",
      "cooked_trout": "assets/items/cooked_trout.png",
      "cooked_salmon": "assets/items/cooked_salmon.png",
      // Consumables
      "minor_healing_potion": "assets/items/minor_healing_potion.png",
      // Rare Drops
      "golden_leaf": "assets/items/golden_leaf.png",
      "pearl": "assets/items/pearl.png",
      "diamond": "assets/items/diamond.png",
      "gem": "assets/items/diamond.png",
      // Monster Drops
      "dragon_scale": "assets/items/dragon_scale.png",
      "elder_scale": "assets/items/elder_scale.png",
      "wolf_pelt": "assets/items/wolf_pelt.png",
      "frog_legs": "assets/items/frog_legs.png",
      "cooked_frog_legs": "assets/items/cooked_frog_legs.png",
      "rock_shell": "assets/items/rock_shell.png",
      "onyx": "assets/items/onyx.png",
      "ember_gem": "assets/items/onyx.png",
      "ash_powder": "assets/items/ash_powder.png",
      // Blueprints
      "dragon_sword_blueprint": "assets/items/dragon_sword_blueprint.png",
      "elder_sword_blueprint": "assets/items/elder_sword_blueprint.png",
      "amulet_blueprint": "assets/items/amulet_blueprint.png",
      // Familiars
      "stone_familiar": "assets/items/stone_familiar.png",
      "dragon_familiar": "assets/items/dragon_familiar.png",
      "elder_familiar": "assets/items/elder_familiar.png",
      // Loot Chests
      "wooden_chest": "assets/items/wooden_chest.png",
      "iron_chest": "assets/items/iron_chest.png",
      "golden_chest": "assets/items/golden_chest.png",
      // Blueprints
      "dragon_sword_blueprint": "assets/items/dragon_sword_blueprint.png",
      "elder_sword_blueprint": "assets/items/elder_sword_blueprint.png",
      "amulet_blueprint": "assets/items/amulet_blueprint.png",
      // Axes
      "bronze_axe": "assets/items/bronze_axe.png",
      "iron_axe": "assets/items/iron_axe.png",
      "steel_axe": "assets/items/steel_axe.png",
      // Herbs (Herblore)
      "swiftgrass": "assets/items/swiftgrass.png",
      "earthweed": "assets/items/earthweed.png",
      "bloodroot": "assets/items/bloodroot.png",
      "glowcap": "assets/items/glowcap.png",
      "ironleaf": "assets/items/ironleaf.png",
      "silverleaf": "assets/items/silverleaf.png",
      "emberleaf": "assets/items/emberleaf.png",
      "nightshade_bloom": "assets/items/nightshade_bloom.png",
      "spirit_moss": "assets/items/spirit_moss.png",
      "astral_lotus": "assets/items/astral_lotus.png",
      "chronoweed": "assets/items/chronoweed.png",
      "moonpetal": "assets/items/moonpetal.png",
      // Potions - Healing
      "greater_healing_potion": "assets/items/greater_healing_potion.png",
      "superior_healing_potion": "assets/items/superior_healing_potion.png",
      // Potions - Combat Buffs
      "minor_attack_potion": "assets/items/minor_attack_potion.png",
      "greater_attack_potion": "assets/items/greater_attack_potion.png",
      "attack_elixir": "assets/items/attack_elixir.png",
      "minor_defense_potion": "assets/items/minor_defense_potion.png",
      "greater_defense_potion": "assets/items/greater_defense_potion.png",
      "defense_elixir": "assets/items/defense_elixir.png",
      "battle_tonic": "assets/items/battle_tonic.png",
      "berserker_draught": "assets/items/berserker_draught.png",
      "vitality_potion": "assets/items/vitality_potion.png",
      // Potions - Skilling Buffs
      "minor_haste_potion": "assets/items/minor_haste_potion.png",
      "haste_potion": "assets/items/haste_potion.png",
      "superior_haste_potion": "assets/items/superior_haste_potion.png",
      "skilling_focus_potion": "assets/items/skilling_focus_potion.png",
      "efficient_worker_potion": "assets/items/efficient_worker_potion.png",
      // Potions - Loot & Utility
      "fortune_potion": "assets/items/fortune_potion.png",
      "endurance_potion": "assets/items/endurance_potion.png",
      "focus_draught": "assets/items/focus_draught.png",
      // Farming Seeds
      "strawberry_seed": "assets/items/strawberry_seed.png",
      "blueberry_seed": "assets/items/blueberry_seed.png",
      "raspberry_seed": "assets/items/raspberry_seed.png",
      "blackberry_seed": "assets/items/blackberry_seed.png",
      "lettuce_seed": "assets/items/lettuce_seed.png",
      "radish_seed": "assets/items/radish_seed.png",
      "tomato_seed": "assets/items/tomato_seed.png",
      "cucumber_seed": "assets/items/cucumber_seed.png",
      "squash_seed": "assets/items/squash_seed.png",
      // Farming Crops
      "strawberry": "assets/items/strawberry.png",
      "blueberry": "assets/items/blueberry.png",
      "raspberry": "assets/items/raspberry.png",
      "blackberry": "assets/items/blackberry.png",
      "lettuce": "assets/items/lettuce.png",
      "radish": "assets/items/radish.png",
      "tomato": "assets/items/tomato.png",
      "cucumber": "assets/items/cucumber.png",
      "squash": "assets/items/squash.png"
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - ITEMS (Stats, icons, requirements, heal values)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ITEMS_DATA = {
      "sword": { slot: "weapon", attack: 50, value: 20, icon: "assets/items/sword.png", reqAtk: 1, name: "Bronze Sword" },
      "bronze_shield": { slot: "offhand", defense: 30, value: 25, icon: "assets/items/bronze_shield.png", reqDef: 1, name: "Bronze Shield" },
      "iron_shield": { slot: "offhand", defense: 60, value: 60, icon: "assets/items/iron_shield.png", reqDef: 5, name: "Iron Shield" },
      "steel_shield": { slot: "offhand", defense: 100, value: 120, icon: "assets/items/steel_shield.png", reqDef: 10, name: "Steel Shield" },
      "bronze_helmet": { slot: "head", defense: 20, value: 15, icon: "assets/items/bronze_helmet.png", reqDef: 1, name: "Bronze Helmet" },
      "iron_helmet": { slot: "head", defense: 40, value: 45, icon: "assets/items/iron_helmet.png", reqDef: 5, name: "Iron Helmet" },
      "steel_helmet": { slot: "head", defense: 60, value: 80, icon: "assets/items/steel_helmet.png", reqDef: 10, name: "Steel Helmet" },
      "bronze_platebody": { slot: "body", defense: 80, value: 50, icon: "assets/items/bronze_platebody.png", reqDef: 5, name: "Bronze Platebody" },
      "iron_platebody": { slot: "body", defense: 120, value: 120, icon: "assets/items/iron_platebody.png", reqDef: 10, name: "Iron Platebody" },
      "bronze_platelegs": { slot: "legs", defense: 50, value: 40, icon: "assets/items/bronze_platelegs.png", reqDef: 1, name: "Bronze Platelegs" },
      "iron_platelegs": { slot: "legs", defense: 80, value: 90, icon: "assets/items/iron_platelegs.png", reqDef: 8, name: "Iron Platelegs" },
      "steel_platelegs": { slot: "legs", defense: 120, value: 180, icon: "assets/items/steel_platelegs.png", reqDef: 12, name: "Steel Platelegs" },
      "ring": { slot: "accessory", attack: 300, defense: 100, value: 100, icon: "assets/items/ring.png", name: "Ring" },
      "copper": { slot: null, value: 1, icon: "assets/items/copper.png", name: "Copper", type: "material", category: "mining" },
      "iron": { slot: null, value: 5, icon: "assets/items/iron.png", name: "Iron", type: "material", category: "mining" },
      "coal": { slot: null, value: 3, icon: "assets/items/coal.png", name: "Coal", type: "material", category: "mining" },
      "wood": { slot: null, value: 1, icon: "assets/items/wood.png", name: "Wood", type: "material", category: "woodcutting" },
      "shrimp": { slot: null, value: 2, icon: "assets/items/shrimp.png", name: "Shrimp", type: "material", category: "fishing" },
      "trout": { slot: null, value: 10, icon: "assets/items/trout.png", name: "Trout", type: "material", category: "fishing" },
      "salmon": { slot: null, value: 20, icon: "assets/items/salmon.png", name: "Salmon", type: "material", category: "fishing" },
      "cooked_shrimp": { slot: null, value: 5, heal: 200, icon: "assets/items/cooked_shrimp.png", name: "Cooked Shrimp", type: "food", category: "cooking" },
      "cooked_trout": { slot: null, value: 30, heal: 500, icon: "assets/items/cooked_trout.png", name: "Cooked Trout", type: "food", category: "cooking" },
      "cooked_salmon": { slot: null, value: 60, heal: 1000, icon: "assets/items/cooked_salmon.png", name: "Cooked Salmon", type: "food", category: "cooking" },
      "minor_healing_potion": { slot: null, value: 10, heal: 500, icon: "assets/items/minor_healing_potion.png", name: "Minor Healing Potion", type: "potion", category: "herblore" },
      "potions": { slot: null, value: 10, heal: 500, icon: "assets/items/minor_healing_potion.png", name: "Potions", type: "food" },
      // New Items
      "iron_sword": { slot: "weapon", attack: 100, value: 100, icon: "assets/items/iron_sword.png", reqAtk: 10, name: "Iron Sword" },
      "steel_platebody": { slot: "body", defense: 150, value: 250, icon: "assets/items/steel_platebody.png", reqDef: 15, name: "Steel Platebody" },
      "dragon_scale": { slot: null, value: 500, icon: "assets/items/dragon_scale.png", name: "Dragon Scale" },
      "dragon_sword": { slot: "weapon", attack: 350, value: 2500, icon: "assets/items/dragon_sword.png", reqAtk: 10, name: "Dragon Sword" },
      "dragon_sword_blueprint": { slot: null, value: 200, icon: "assets/items/dragon_sword_blueprint.png", name: "Dragon Sword Blueprint" },
      "elder_scale": { slot: null, value: 800, icon: "assets/items/elder_scale.png", name: "Elder Scale" },
      "elder_sword_blueprint": { slot: null, value: 500, icon: "assets/items/elder_sword_blueprint.png", name: "Elder Sword Blueprint" },
      "elder_sword": { slot: "weapon", attack: 500, value: 1200, icon: "assets/items/elder_sword.png", reqAtk: 15, name: "Elder Sword" },
      "dragon_amulet": { slot: "accessory", attack: 500, value: 3000, icon: "assets/items/dragon_amulet.png", name: "Dragon Amulet" },
      "amulet_blueprint": { slot: null, value: 300, icon: "assets/items/amulet_blueprint.png", name: "Amulet Blueprint" },
      // Tools
      "bronze_pickaxe": { slot: "tool", value: 50, icon: "assets/items/bronze_pickaxe.png", bonus: { skill: "mining", multiplier: 0.9 }, name: "Bronze Pickaxe" },
      "iron_pickaxe": { slot: "tool", value: 200, icon: "assets/items/iron_pickaxe.png", reqSkill: { mining: 15 }, bonus: { skill: "mining", multiplier: 0.8 }, name: "Iron Pickaxe" },
      "steel_pickaxe": { slot: "tool", value: 450, icon: "assets/items/steel_pickaxe.png", reqSkill: { mining: 25 }, bonus: { skill: "mining", multiplier: 0.75 }, name: "Steel Pickaxe" },
      "bronze_axe": { slot: "tool", value: 50, icon: "ğŸª“", bonus: { skill: "woodcutting", multiplier: 0.9 }, name: "Bronze Axe" },
      "iron_axe": { slot: "tool", value: 200, icon: "ğŸª“", reqSkill: { woodcutting: 15 }, bonus: { skill: "woodcutting", multiplier: 0.8 }, name: "Iron Axe" },
      "steel_axe": { slot: "tool", value: 450, icon: "ğŸª“", reqSkill: { woodcutting: 25 }, bonus: { skill: "woodcutting", multiplier: 0.75 }, name: "Steel Axe" },
      // Expansion: Logs

      // Expansion: Rare Drops
      "golden_leaf": { slot: null, value: 100, icon: "ğŸ‚", name: "Golden Leaf" },
      "pearl": { slot: null, value: 250, icon: "âšª", name: "Pearl" },
      "diamond": { slot: null, value: 150, icon: "assets/items/diamond.png", name: "Diamond" },
      // Expansion: Mob Drops
      "wolf_pelt": { slot: null, value: 30, icon: "assets/items/wolf_pelt.png", name: "Wolf Pelt" },
      "frog_legs": { slot: null, value: 20, icon: "assets/items/frog_legs.png", name: "Frog Legs" },
        "cooked_frog_legs": { slot: null, value: 45, heal: 800, icon: "assets/items/cooked_frog_legs.png", name: "Cooked Frog Legs", type: "food", category: "cooking" },
      "rock_shell": { slot: null, value: 50, icon: "assets/items/rock_shell.png", name: "Rock Shell" },
      "leather_boots": { slot: "boots", defense: 10, value: 30, icon: "assets/items/leather_boots.png", reqDef: 1, name: "Leather Boots" },
      "bronze_boots": { slot: "boots", defense: 30, value: 80, icon: "assets/items/bronze_boots.png", reqDef: 5, name: "Bronze Boots" },
      "iron_boots": { slot: "boots", defense: 60, value: 200, icon: "assets/items/iron_boots.png", reqDef: 10, name: "Iron Boots" },
      "steel_boots": { slot: "boots", defense: 100, value: 350, icon: "assets/items/steel_boots.png", reqDef: 15, name: "Steel Boots" },
      // Familiars
      "stone_familiar": { slot: "familiar", attack: 300, value: 500, icon: "assets/items/stone_familiar.png", name: "Stone Familiar" },
      "dragon_familiar": { slot: "familiar", attack: 500, value: 1500, icon: "assets/items/dragon_familiar.png", name: "Dragon Familiar" },
      "elder_familiar": { slot: "familiar", attack: 1000, value: 10000, icon: "assets/items/elder_familiar.png", name: "Elder Familiar" },
      // Loot Chests
      "wooden_chest": { slot: null, value: 25, icon: "assets/items/wooden_chest.png", name: "Wooden Chest", isChest: true },
      "iron_chest": { slot: null, value: 75, icon: "assets/items/iron_chest.png", name: "Iron Chest", isChest: true },
      "golden_chest": { slot: null, value: 250, icon: "assets/items/golden_chest.png", name: "Golden Chest", isChest: true }
    };

    // New mob drops items
    ITEMS_DATA["onyx"] = { slot: null, value: 150, icon: "assets/items/onyx.png", name: "Onyx" };
    ITEMS_DATA["ember_gem"] = { slot: null, value: 150, icon: "ğŸ’", name: "Onyx" };
    ITEMS_DATA["ash_powder"] = { slot: null, value: 20, icon: "assets/items/ash_powder.png", name: "Ash Powder" };

    // Herbs (Herblore gathering)
    ITEMS_DATA["greenleaf"] = { slot: null, value: 5, icon: "assets/items/greenleaf.png", name: "Greenleaf" };
    ITEMS_DATA["swiftgrass"] = { slot: null, value: 8, icon: "assets/items/swiftgrass.png", name: "Swiftgrass" };
    ITEMS_DATA["earthweed"] = { slot: null, value: 10, icon: "assets/items/earthweed.png", name: "Earthweed" };
    ITEMS_DATA["bloodroot"] = { slot: null, value: 15, icon: "assets/items/bloodroot.png", name: "Bloodroot" };
    ITEMS_DATA["glowcap"] = { slot: null, value: 20, icon: "assets/items/glowcap.png", name: "Glowcap" };
    ITEMS_DATA["ironleaf"] = { slot: null, value: 25, icon: "assets/items/ironleaf.png", name: "Ironleaf" };
    ITEMS_DATA["silverleaf"] = { slot: null, value: 30, icon: "assets/items/silverleaf.png", name: "Silverleaf" };
    ITEMS_DATA["emberleaf"] = { slot: null, value: 40, icon: "assets/items/emberleaf.png", name: "Emberleaf" };
    ITEMS_DATA["nightshade_bloom"] = { slot: null, value: 60, icon: "assets/items/nightshade_bloom.png", name: "Nightshade Bloom" };
    ITEMS_DATA["spirit_moss"] = { slot: null, value: 70, icon: "assets/items/spirit_moss.png", name: "Spirit Moss" };
    ITEMS_DATA["astral_lotus"] = { slot: null, value: 80, icon: "assets/items/astral_lotus.png", name: "Astral Lotus" };
    ITEMS_DATA["chronoweed"] = { slot: null, value: 100, icon: "assets/items/chronoweed.png", name: "Chronoweed" };
    ITEMS_DATA["moonpetal"] = { slot: null, value: 50, icon: "ğŸŒ¸", name: "Moonpetal" };
    ITEMS_DATA["golden_leaf"] = { slot: null, value: 35, icon: "assets/items/golden_leaf.png", name: "Golden Leaf" };
    ITEMS_DATA["pearl"] = { slot: null, value: 90, icon: "assets/items/pearl.png", name: "Pearl" };

    // Healing Potions (instant HP restore)
    ITEMS_DATA["greater_healing_potion"] = { slot: null, value: 150, icon: "assets/items/greater_healing_potion.png", heal: 1500, name: "Greater Healing Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["superior_healing_potion"] = { slot: null, value: 300, icon: "assets/items/superior_healing_potion.png", heal: 3000, name: "Superior Healing Potion", type: "potion", category: "herblore" };

    // Combat Buff Potions (time-based effects)
    ITEMS_DATA["minor_attack_potion"] = { slot: null, value: 50, icon: "assets/items/minor_attack_potion.png", name: "Minor Attack Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["greater_attack_potion"] = { slot: null, value: 120, icon: "assets/items/greater_attack_potion.png", name: "Greater Attack Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["attack_elixir"] = { slot: null, value: 250, icon: "assets/items/attack_elixir.png", name: "Attack Elixir", type: "potion", category: "herblore" };
    ITEMS_DATA["minor_defense_potion"] = { slot: null, value: 50, icon: "assets/items/minor_defense_potion.png", name: "Minor Defense Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["greater_defense_potion"] = { slot: null, value: 120, icon: "assets/items/greater_defense_potion.png", name: "Greater Defense Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["defense_elixir"] = { slot: null, value: 250, icon: "assets/items/defense_elixir.png", name: "Defense Elixir", type: "potion", category: "herblore" };
    ITEMS_DATA["battle_tonic"] = { slot: null, value: 180, icon: "assets/items/battle_tonic.png", name: "Battle Tonic", type: "potion", category: "herblore" };
    ITEMS_DATA["berserker_draught"] = { slot: null, value: 350, icon: "assets/items/berserker_draught.png", name: "Berserker Draught", type: "potion", category: "herblore" };
    ITEMS_DATA["vitality_potion"] = { slot: null, value: 200, icon: "assets/items/vitality_potion.png", name: "Vitality Potion", type: "potion", category: "herblore" };

    // Skilling Buff Potions
    ITEMS_DATA["minor_haste_potion"] = { slot: null, value: 60, icon: "assets/items/minor_haste_potion.png", name: "Minor Haste Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["haste_potion"] = { slot: null, value: 140, icon: "assets/items/haste_potion.png", name: "Haste Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["superior_haste_potion"] = { slot: null, value: 280, icon: "assets/items/superior_haste_potion.png", name: "Superior Haste Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["skilling_focus_potion"] = { slot: null, value: 150, icon: "assets/items/skilling_focus_potion.png", name: "Skilling Focus Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["efficient_worker_potion"] = { slot: null, value: 220, icon: "assets/items/efficient_worker_potion.png", name: "Efficient Worker Potion", type: "potion", category: "herblore" };

    // Loot & Utility Potions
    ITEMS_DATA["fortune_potion"] = { slot: null, value: 300, icon: "assets/items/fortune_potion.png", name: "Fortune Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["endurance_potion"] = { slot: null, value: 100, icon: "assets/items/endurance_potion.png", name: "Endurance Potion", type: "potion", category: "herblore" };
    ITEMS_DATA["focus_draught"] = { slot: null, value: 180, icon: "assets/items/focus_draught.png", name: "Focus Draught", type: "potion", category: "herblore" };

    // Farming Seeds
    ITEMS_DATA["strawberry_seed"] = { slot: null, value: 5, icon: "assets/items/strawberry_seed.png", name: "Strawberry Seed", type: "seed", category: "farming" };
    ITEMS_DATA["blueberry_seed"] = { slot: null, value: 5, icon: "assets/items/blueberry_seed.png", name: "Blueberry Seed", type: "seed", category: "farming" };
    ITEMS_DATA["raspberry_seed"] = { slot: null, value: 8, icon: "assets/items/raspberry_seed.png", name: "Raspberry Seed", type: "seed", category: "farming" };
    ITEMS_DATA["blackberry_seed"] = { slot: null, value: 8, icon: "assets/items/blackberry_seed.png", name: "Blackberry Seed", type: "seed", category: "farming" };
    ITEMS_DATA["lettuce_seed"] = { slot: null, value: 10, icon: "assets/items/lettuce_seed.png", name: "Lettuce Seed", type: "seed", category: "farming" };
    ITEMS_DATA["radish_seed"] = { slot: null, value: 12, icon: "assets/items/radish_seed.png", name: "Radish Seed", type: "seed", category: "farming" };
    ITEMS_DATA["tomato_seed"] = { slot: null, value: 18, icon: "assets/items/tomato_seed.png", name: "Tomato Seed", type: "seed", category: "farming" };
    ITEMS_DATA["cucumber_seed"] = { slot: null, value: 18, icon: "assets/items/cucumber_seed.png", name: "Cucumber Seed", type: "seed", category: "farming" };
    ITEMS_DATA["squash_seed"] = { slot: null, value: 35, icon: "assets/items/squash_seed.png", name: "Squash Seed", type: "seed", category: "farming" };

    // Farming Crops (consumable food items)
    ITEMS_DATA["strawberry"] = { slot: null, value: 15, icon: "ğŸ“", name: "Strawberry", heal: 150, type: "food", category: "farming" };
    ITEMS_DATA["blueberry"] = { slot: null, value: 15, icon: "ğŸ«", name: "Blueberry", heal: 150, type: "food", category: "farming" };
    ITEMS_DATA["raspberry"] = { slot: null, value: 22, icon: "ğŸ‡", name: "Raspberry", heal: 250, type: "food", category: "farming" };
    ITEMS_DATA["blackberry"] = { slot: null, value: 22, icon: "ğŸ«’", name: "Blackberry", heal: 250, type: "food", category: "farming" };
    ITEMS_DATA["lettuce"] = { slot: null, value: 30, icon: "ğŸ¥¬", name: "Lettuce", heal: 350, type: "food", category: "farming" };
    ITEMS_DATA["radish"] = { slot: null, value: 38, icon: "ğŸ¥•", name: "Radish", heal: 450, type: "food", category: "farming" };
    ITEMS_DATA["tomato"] = { slot: null, value: 55, icon: "ğŸ…", name: "Tomato", heal: 650, type: "food", category: "farming" };
    ITEMS_DATA["cucumber"] = { slot: null, value: 55, icon: "ğŸ¥’", name: "Cucumber", heal: 650, type: "food", category: "farming" };
    ITEMS_DATA["squash"] = { slot: null, value: 100, icon: "ğŸƒ", name: "Squash", heal: 1200, type: "food", category: "farming" };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - LOOT CHESTS (Chest drop tables)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CHEST_DEFINITIONS = {
      "wooden_chest": {
        id: "wooden_chest",
        name: "Wooden Chest",
        minItems: 1,
        maxItems: 3,
        loot: [
          { item: "copper", weight: 30, min: 2, max: 8 },
          { item: "wood", weight: 25, min: 20, max: 100 },
          { item: "coal", weight: 15, min: 1, max: 4 },
          { item: "shrimp", weight: 10, min: 2, max: 5 },
          { item: "minor_healing_potion", weight: 8, min: 1, max: 2 },
          { item: "greenleaf", weight: 12, min: 1, max: 3 },
          { item: "swiftgrass", weight: 10, min: 1, max: 2 },
          { item: "strawberry_seed", weight: 30, min: 10, max: 30 },
          { item: "blueberry_seed", weight: 30, min: 10, max: 30 },
          { item: "bronze_shield", weight: 5, min: 1, max: 1 },
          { item: "bronze_helmet", weight: 4, min: 1, max: 1 },
          { item: "leather_boots", weight: 3, min: 1, max: 1 }
        ]
      },
      "iron_chest": {
        id: "iron_chest",
        name: "Iron Chest",
        minItems: 2,
        maxItems: 4,
        loot: [
          { item: "iron", weight: 25, min: 2, max: 6 },
          { item: "coal", weight: 20, min: 3, max: 8 },
          { item: "copper", weight: 15, min: 5, max: 15 },
          { item: "minor_healing_potion", weight: 12, min: 2, max: 4 },
          { item: "diamond", weight: 8, min: 1, max: 2 },
          { item: "bloodroot", weight: 10, min: 1, max: 2 },
          { item: "glowcap", weight: 10, min: 1, max: 2 },
          { item: "ironleaf", weight: 8, min: 1, max: 2 },
          { item: "raspberry_seed", weight: 10, min: 10, max: 30 },
          { item: "blackberry_seed", weight: 10, min: 10, max: 30 },
          { item: "lettuce_seed", weight: 6, min: 10, max: 30 },
          { item: "radish_seed", weight: 5, min: 10, max: 30 },
          { item: "greater_healing_potion", weight: 7, min: 1, max: 2 },
          { item: "minor_attack_potion", weight: 6, min: 1, max: 1 },
          { item: "iron_helmet", weight: 6, min: 1, max: 1 },
          { item: "iron_shield", weight: 5, min: 1, max: 1 },
          { item: "iron_boots", weight: 4, min: 1, max: 1 },
          { item: "iron_sword", weight: 3, min: 1, max: 1 },
          { item: "bronze_boots", weight: 2, min: 1, max: 1 }
        ]
      },
      "golden_chest": {
        id: "golden_chest",
        name: "Golden Chest",
        minItems: 3,
        maxItems: 5,
        loot: [
          { item: "iron", weight: 20, min: 5, max: 15 },
          { item: "diamond", weight: 15, min: 2, max: 5 },
          { item: "minor_healing_potion", weight: 12, min: 3, max: 6 },
          { item: "dragon_scale", weight: 10, min: 1, max: 2 },
          { item: "pearl", weight: 8, min: 1, max: 3 },
          { item: "spirit_moss", weight: 12, min: 1, max: 3 },
          { item: "astral_lotus", weight: 10, min: 1, max: 2 },
          { item: "chronoweed", weight: 8, min: 1, max: 2 },
          { item: "nightshade_bloom", weight: 10, min: 1, max: 2 },
          { item: "tomato_seed", weight: 10, min: 10, max: 30 },
          { item: "cucumber_seed", weight: 10, min: 10, max: 30 },
          { item: "squash_seed", weight: 10, min: 10, max: 30 },
          { item: "superior_healing_potion", weight: 10, min: 1, max: 3 },
          { item: "attack_elixir", weight: 7, min: 1, max: 1 },
          { item: "defense_elixir", weight: 7, min: 1, max: 1 },
          { item: "superior_haste_potion", weight: 6, min: 1, max: 1 },
          { item: "fortune_potion", weight: 4, min: 1, max: 1 },
          { item: "steel_platebody", weight: 6, min: 1, max: 1 },
          { item: "steel_boots", weight: 5, min: 1, max: 1 },
          { item: "iron_sword", weight: 5, min: 1, max: 1 },
          { item: "dragon_amulet", weight: 3, min: 1, max: 1 },
          { item: "amulet_blueprint", weight: 2, min: 1, max: 1 },
          { item: "dragon_sword_blueprint", weight: 1, min: 1, max: 1 }
        ]
      }
    };

  // Add iron_pickaxe and iron_axe to golden chest loot
  CHEST_DEFINITIONS["golden_chest"].loot.push(
    { item: "iron_pickaxe", weight: 1, min: 1, max: 1 },
    { item: "iron_axe", weight: 1, min: 1, max: 1 }
  );

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - RESOURCE TIERS (Gathering skills: mining, woodcutting, fishing)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const RESOURCE_TIERS = {
      mining: [
        { id: 'copper', level: 1, xp: 10, interval: 3000, drops: [
          { item: 'copper', chance: 1.0, min: 1, max: 1 },
          { item: 'diamond', chance: 0.01, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.005, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0025, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.00075, min: 1, max: 1 }
        ] },
        { id: 'coal', level: 5, xp: 18, interval: 4000, drops: [
          { item: 'coal', chance: 1.0, min: 1, max: 1 },
          { item: 'diamond', chance: 0.015, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.00375, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.003, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.001, min: 1, max: 1 }
        ] },
        { id: 'iron', level: 7, xp: 25, interval: 5000, drops: [
          { item: 'iron', chance: 1.0, min: 1, max: 1 },
          { item: 'diamond', chance: 0.02, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.0025, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0045, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.00125, min: 1, max: 1 }
        ] }
      ],
      fishing: [
        { id: 'shrimp', name: 'Shrimp', level: 1, xp: 10, interval: 3000, drops: [
          { item: 'shrimp', chance: 1.0, min: 1, max: 2 },
          { item: 'pearl', chance: 0.01, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.005, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0025, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.00075, min: 1, max: 1 }
        ] },
        { id: 'trout', name: 'trout', level: 5, xp: 30, interval: 5000, drops: [
          { item: 'trout', chance: 1.0, min: 1, max: 2 },
          { item: 'pearl', chance: 0.02, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.00375, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.003, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.001, min: 1, max: 1 }
        ] },
        { id: 'salmon', name: 'salmon', level: 7, xp: 70, interval: 8000, drops: [
          { item: 'salmon', chance: 1.0, min: 1, max: 3 },
          { item: 'pearl', chance: 0.03, min: 1, max: 1 },
          { item: 'wooden_chest', chance: 0.0025, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0045, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.00125, min: 1, max: 1 }
        ] }
      ],
      woodcutting: [
        { id: 'wood', resourceName: 'Birch Tree', level: 1, xp: 10, interval: 3000, drops: [
          { item: 'wood', chance: 1.0, min: 1, max: 2 },
          { item: 'golden_leaf', chance: 0.01, min: 1, max: 1 },
          { item: 'strawberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'blueberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'wooden_chest', chance: 0.0125, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0025, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.00075, min: 1, max: 1 }
        ] },
        { id: 'wood', resourceName: 'Oak Tree', level: 5, xp: 25, interval: 5000, drops: [
          { item: 'wood', chance: 1.0, min: 1, max: 4 },
          { item: 'golden_leaf', chance: 0.02, min: 1, max: 1 },
          { item: 'raspberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'blackberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'lettuce_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'wooden_chest', chance: 0.00375, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.003, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.001, min: 1, max: 1 }
        ] },
        { id: 'wood', resourceName: 'Willow Tree', level: 7, xp: 45, interval: 7000, drops: [
          { item: 'wood', chance: 1.0, min: 5, max: 8 },
          { item: 'golden_leaf', chance: 0.03, min: 1, max: 1 },
          { item: 'radish_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'tomato_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'cucumber_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'squash_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'wooden_chest', chance: 0.05, min: 1, max: 1 },
          { item: 'iron_chest', chance: 0.0375, min: 1, max: 1 },
          { item: 'golden_chest', chance: 0.0025, min: 1, max: 1 }
        ] }
      ],
      herblore: [
        { id: 'greenleaf', location: 'forest', level: 1, xp: 12, interval: 3500, drops: [
          { item: 'greenleaf', chance: 1.0, min: 1, max: 2 },
          { item: 'strawberry_seed', chance: 0.24, min: 1, max: 2 },
          { item: 'blueberry_seed', chance: 0.24, min: 1, max: 2 }
        ] },
        { id: 'swiftgrass', location: 'forest', level: 3, xp: 18, interval: 4000, drops: [
          { item: 'swiftgrass', chance: 1.0, min: 1, max: 2 },
          { item: 'strawberry_seed', chance: 0.24, min: 1, max: 2 },
          { item: 'blueberry_seed', chance: 0.24, min: 1, max: 2 }
        ] },
        { id: 'earthweed', location: 'fishing-pond', level: 5, xp: 25, interval: 4500, drops: [
          { item: 'earthweed', chance: 1.0, min: 1, max: 2 },
          { item: 'raspberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'lettuce_seed', chance: 0.40, min: 1, max: 2 }
        ] },
        { id: 'bloodroot', location: 'fishing-pond', level: 7, xp: 35, interval: 5000, drops: [
          { item: 'bloodroot', chance: 1.0, min: 1, max: 2 },
          { item: 'blackberry_seed', chance: 0.40, min: 1, max: 2 },
          { item: 'radish_seed', chance: 0.40, min: 1, max: 2 }
        ] },
        { id: 'glowcap', location: 'cave', level: 10, xp: 45, interval: 5500, drops: [
          { item: 'glowcap', chance: 1.0, min: 1, max: 2 },
          { item: 'tomato_seed', chance: 0.20, min: 1, max: 2 },
          { item: 'cucumber_seed', chance: 0.20, min: 1, max: 2 }
        ] },
        { id: 'ironleaf', location: 'mountains', level: 13, xp: 60, interval: 6000, drops: [
          { item: 'ironleaf', chance: 1.0, min: 1, max: 1 },
          { item: 'tomato_seed', chance: 0.20, min: 1, max: 2 },
          { item: 'cucumber_seed', chance: 0.20, min: 1, max: 2 }
        ] },
        { id: 'silverleaf', location: 'mountains', level: 16, xp: 75, interval: 6500, drops: [
          { item: 'silverleaf', chance: 1.0, min: 1, max: 1 },
          { item: 'squash_seed', chance: 0.20, min: 1, max: 2 }
        ] },
        { id: 'emberleaf', location: 'volcanic-plain', level: 20, xp: 95, interval: 7000, drops: [
          { item: 'emberleaf', chance: 1.0, min: 1, max: 1 },
          { item: 'squash_seed', chance: 0.20, min: 1, max: 2 }
        ] },
        { id: 'nightshade_bloom', location: 'mountains', level: 25, xp: 120, interval: 8000, drops: [
          { item: 'nightshade_bloom', chance: 1.0, min: 1, max: 1 },
          { item: 'squash_seed', chance: 0.16, min: 1, max: 2 }
        ] },
        { id: 'spirit_moss', location: 'mountains', level: 30, xp: 150, interval: 9000, drops: [
          { item: 'spirit_moss', chance: 1.0, min: 1, max: 1 }
        ] },
        { id: 'astral_lotus', location: 'mountains', level: 35, xp: 200, interval: 10000, drops: [
          { item: 'astral_lotus', chance: 1.0, min: 1, max: 1 }
        ] },
        { id: 'chronoweed', location: 'mountains', level: 40, xp: 250, interval: 12000, drops: [
          { item: 'chronoweed', chance: 1.0, min: 1, max: 1 }
        ] }
      ]
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - COOKING RECIPES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const COOKING_RECIPES = [
      { raw: 'shrimp', cooked: 'cooked_shrimp', level: 1, xp: 10, cost: { wood: 1, shrimp: 1 } },
      { raw: 'trout', cooked: 'cooked_trout', level: 5, xp: 30, cost: { wood: 1, trout: 1 } },
      { raw: 'salmon', cooked: 'cooked_salmon', level: 7, xp: 70, cost: { wood: 1, salmon: 1 } },
      { raw: 'frog_legs', cooked: 'cooked_frog_legs', level: 6, xp: 50, cost: { wood: 1, frog_legs: 1 } }
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - CRAFTING RECIPES (Smithing)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CRAFTING_RECIPES = [
      { name: "sword", type: "sword", cost: { copper: 5 }, level: 1, xp: 60 },
      { name: "bronze_shield", type: "shield", cost: { copper: 5 }, level: 1, xp: 60 },
      { name: "iron_shield", type: "shield", cost: { iron: 5 }, level: 5, xp: 150 },
      { name: "steel_shield", type: "shield", cost: { iron: 8, coal: 4 }, level: 10, xp: 350 },
      { name: "bronze_helmet", type: "head", cost: { copper: 3 }, level: 2, xp: 90 },
      { name: "iron_helmet", type: "head", cost: { iron: 3 }, level: 5, xp: 150 },
      { name: "steel_helmet", type: "head", cost: { iron: 5, coal: 2 }, level: 10, xp: 300 },
      { name: "bronze_platebody", type: "chest", cost: { copper: 10 }, level: 5, xp: 150 },
      { name: "iron_platebody", type: "chest", cost: { iron: 10 }, level: 8, xp: 300 },
      { name: "bronze_platelegs", type: "legs", cost: { copper: 7 }, level: 3, xp: 120 },
      { name: "iron_platelegs", type: "legs", cost: { iron: 7 }, level: 6, xp: 200 },
      { name: "steel_platelegs", type: "legs", cost: { iron: 12, coal: 5 }, level: 12, xp: 500 },
      { name: "iron_sword", type: "sword", cost: { iron: 5, wood: 2 }, level: 7, xp: 300 },
      { name: "steel_platebody", type: "chest", cost: { iron: 10, coal: 5 }, level: 7, xp: 600 },
      { name: "dragon_sword", type: "sword", cost: { dragon_scale: 3, wood: 1, dragon_sword_blueprint: 1 }, level: 7, xp: 1500 },
      { name: "elder_sword", type: "sword", cost: { elder_scale: 2, wood: 1, elder_sword_blueprint: 1 }, level: 10, xp: 800 },
      { name: "bronze_pickaxe", type: "tool", cost: { copper: 1, wood: 1 }, level: 1, xp: 45 },
      { name: "bronze_axe", type: "tool", cost: { copper: 1, wood: 1 }, level: 1, xp: 45 },
      { name: "leather_boots", type: "boots", cost: { wood: 5 }, level: 1, xp: 40 },
      { name: "bronze_boots", type: "boots", cost: { copper: 8, wood: 2 }, level: 3, xp: 100 },
      { name: "iron_boots", type: "boots", cost: { iron: 8, wood: 3 }, level: 8, xp: 250 },
      { name: "steel_boots", type: "boots", cost: { iron: 12, coal: 4 }, level: 12, xp: 450 },
      { name: "dragon_amulet", type: "amulet", cost: { diamond: 5, dragon_scale: 1, amulet_blueprint: 1 }, level: 9, xp: 900 }
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - POTION RECIPES (Herblore)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Potion types: "healing" (instant HP restore) or "buff" (time-based effect)
    // Buff categories ensure only one potion per category can be active at once
    const POTION_RECIPES = [
      // INSTANT HEALING POTIONS
      { name: "minor_healing_potion", type: "healing", cost: { greenleaf: 1 }, level: 1, xp: 20 },
      { name: "greater_healing_potion", type: "healing", cost: { greenleaf: 2, wolf_pelt: 1 }, level: 5, xp: 50 },
      { name: "superior_healing_potion", type: "healing", cost: { silverleaf: 2, bloodroot: 1 }, level: 15, xp: 150 },

      // COMBAT - ATTACK (category: attack)
      { name: "minor_attack_potion", type: "buff", category: "attack", cost: { greenleaf: 1, wolf_pelt: 1 }, level: 3, xp: 30,
        effect: { type: "combat_flat", stat: "attack", value: 20 }, duration: 120000 }, // 2 min
      { name: "greater_attack_potion", type: "buff", category: "attack", cost: { silverleaf: 1, frog_legs: 1 }, level: 12, xp: 80,
        effect: { type: "combat_flat", stat: "attack", value: 50 }, duration: 300000 }, // 5 min
      { name: "attack_elixir", type: "buff", category: "attack", cost: { emberleaf: 1, ember_gem: 1 }, level: 22, xp: 150,
        effect: { type: "combat_percent", stat: "attack", value: 15 }, duration: 120000 }, // 2 min

      // COMBAT - DEFENSE (category: defense)
      { name: "minor_defense_potion", type: "buff", category: "defense", cost: { earthweed: 1, rock_shell: 1 }, level: 6, xp: 40,
        effect: { type: "combat_flat", stat: "defense", value: 20 }, duration: 120000 }, // 2 min
      { name: "greater_defense_potion", type: "buff", category: "defense", cost: { ironleaf: 1, rock_shell: 1 }, level: 14, xp: 90,
        effect: { type: "combat_flat", stat: "defense", value: 50 }, duration: 300000 }, // 5 min
      { name: "defense_elixir", type: "buff", category: "defense", cost: { spirit_moss: 1, pearl: 1 }, level: 32, xp: 200,
        effect: { type: "damage_reduction", value: 10 }, duration: 120000 }, // 2 min, 10% reduction (capped)

      // HYBRID COMBAT (category: hybrid)
      { name: "battle_tonic", type: "buff", category: "hybrid", cost: { bloodroot: 1, wolf_pelt: 1 }, level: 8, xp: 60,
        effect: { type: "combat_multi", attack: 15, defense: 15 }, duration: 300000 }, // 5 min
      { name: "berserker_draught", type: "buff", category: "hybrid", cost: { nightshade_bloom: 1, frog_legs: 1 }, level: 26, xp: 170,
        effect: { type: "combat_multi", attackPercent: 20, defense: -30 }, duration: 120000 }, // 2 min

      // SURVIVAL (category: survival)
      { name: "vitality_potion", type: "buff", category: "survival", cost: { moonpetal: 1, pearl: 1 }, level: 18, xp: 110,
        effect: { type: "max_hp", value: 500 }, duration: 300000 }, // 5 min

      // SKILLING - SPEED (category: skill_speed)
      { name: "minor_haste_potion", type: "buff", category: "skill_speed", cost: { swiftgrass: 1, frog_legs: 1 }, level: 4, xp: 35,
        effect: { type: "skill_speed", value: 10 }, duration: 1800000 }, // 30 min, -10% time
      { name: "haste_potion", type: "buff", category: "skill_speed", cost: { glowcap: 1, golden_leaf: 1 }, level: 11, xp: 75,
        effect: { type: "skill_speed", value: 15 }, duration: 2700000 }, // 45 min, -15% time
      { name: "superior_haste_potion", type: "buff", category: "skill_speed", cost: { chronoweed: 1, pearl: 1 }, level: 40, xp: 300,
        effect: { type: "skill_speed", value: 25 }, duration: 1800000 }, // 30 min, -25% time

      // SKILLING - XP / EFFICIENCY (category: skill_xp / skill_efficiency)
      { name: "skilling_focus_potion", type: "buff", category: "skill_xp", cost: { silverleaf: 1, golden_leaf: 1 }, level: 16, xp: 100,
        effect: { type: "skill_xp", value: 20 }, duration: 2700000 }, // 45 min, +20% XP
      { name: "efficient_worker_potion", type: "buff", category: "skill_efficiency", cost: { ironleaf: 1, wolf_pelt: 1 }, level: 13, xp: 85,
        effect: { type: "extra_resource", value: 15 }, duration: 2700000 }, // 45 min, +15% extra resource chance

      // LOOT & ECONOMY (category: loot)
      { name: "fortune_potion", type: "buff", category: "loot", cost: { astral_lotus: 1, pearl: 1 }, level: 36, xp: 250,
        effect: { type: "drop_chance", value: 5 }, duration: 120000 }, // 2 min, +5% drop chance (low cap)

      // UTILITY / SPECIAL (category: utility)
      { name: "endurance_potion", type: "buff", category: "utility", cost: { spirit_moss: 1, golden_leaf: 1 }, level: 30, xp: 190,
        effect: { type: "afk_extension", value: 300000 }, duration: 0 }, // +5 minutes AFK cap, one-time
      { name: "focus_draught", type: "buff", category: "utility", cost: { nightshade_bloom: 1, ember_gem: 1 }, level: 28, xp: 180,
        effect: { type: "prevent_interrupt", value: 1 }, duration: 0 } // Prevent next AFK interruption, consumed on trigger
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - FARMING CROPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const FARMING_CROPS = [
      { seedId: "strawberry_seed", cropId: "strawberry", level: 1, xp: 15, growthTime: 600000 },   // 10 min
      { seedId: "blueberry_seed", cropId: "blueberry", level: 1, xp: 15, growthTime: 600000 },     // 10 min
      { seedId: "raspberry_seed", cropId: "raspberry", level: 5, xp: 25, growthTime: 900000 },    // 15 min
      { seedId: "blackberry_seed", cropId: "blackberry", level: 5, xp: 25, growthTime: 900000 },  // 15 min
      { seedId: "lettuce_seed", cropId: "lettuce", level: 10, xp: 40, growthTime: 1200000 },      // 20 min
      { seedId: "radish_seed", cropId: "radish", level: 15, xp: 55, growthTime: 1500000 },        // 25 min
      { seedId: "tomato_seed", cropId: "tomato", level: 25, xp: 85, growthTime: 2400000 },        // 40 min
      { seedId: "cucumber_seed", cropId: "cucumber", level: 25, xp: 85, growthTime: 2400000 },    // 40 min
      { seedId: "squash_seed", cropId: "squash", level: 40, xp: 150, growthTime: 5400000 }        // 90 min
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - HOME TIERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const HOME_TIERS = [
      { tier: 1, totalLevelReq: 25, woodCost: 2000, plots: 50, inventorySlots: 25 },
      { tier: 2, totalLevelReq: 50, woodCost: 5000, plots: 100, inventorySlots: 50 },
      { tier: 3, totalLevelReq: 100, woodCost: 10000, plots: 250, inventorySlots: 75 }
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME DATA - LOCATIONS, ENEMIES & DROP TABLES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Each location contains enemies with their stats and drop tables
    // Drop rates: Common (0.20-0.50), Rare (0.05-0.15), Ultra Rare (0.01-0.05)
    const locations = {
      "starter-village": {
        skills: [],
        enemies: [
          { name: "Goblin", icon: "ğŸ‘º", level: 2, hp: 440, attack: 80, gold: 4, exp: 10, drops: [
            // Common drops
            { item: "copper", chance: 0.35, min: 1, max: 5 },
            { item: "wood", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_shrimp", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 1 },
            { item: "greenleaf", chance: 0.20, min: 1, max: 2 },
            // Seed drops
            { item: "strawberry_seed", chance: 0.04, min: 1, max: 1 },
            { item: "blueberry_seed", chance: 0.04, min: 1, max: 1 },
            // Rare drops
            { item: "bronze_shield", chance: 0.08, min: 1, max: 1 },
            { item: "sword", chance: 0.06, min: 1, max: 1 },
            // Ultra rare drops
            { item: "wooden_chest", chance: 0.05, min: 1, max: 1 }
          ] },
          { name: "Bat", icon: "ğŸ¦‡", level: 2, hp: 360, attack: 100, gold: 3, exp: 10, drops: [
            // Common drops
            { item: "wood", chance: 0.30, min: 1, max: 2 },
            { item: "cooked_shrimp", chance: 0.25, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 1 },
            // Rare drops
            { item: "leather_boots", chance: 0.05, min: 1, max: 1 },
            // Ultra rare drops
            { item: "wooden_chest", chance: 0.03, min: 1, max: 1 }
          ] },
          { name: "Wolf", icon: "ğŸº", level: 3, hp: 560, attack: 140, gold: 6, exp: 15, drops: [
            // Common drops
            { item: "wolf_pelt", chance: 0.35, min: 1, max: 1 },
            { item: "copper", chance: 0.30, min: 1, max: 6 },
            { item: "cooked_shrimp", chance: 0.25, min: 1, max: 3 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 1 },
            { item: "greenleaf", chance: 0.25, min: 1, max: 2 },
            { item: "swiftgrass", chance: 0.20, min: 1, max: 1 },
            // Rare drops
            { item: "leather_boots", chance: 0.10, min: 1, max: 1 },
            { item: "bronze_shield", chance: 0.07, min: 1, max: 1 },
            // Ultra rare drops
            { item: "wooden_chest", chance: 0.05, min: 1, max: 1 }
          ] }
        ]
      },
      "blacksmith": { skills: [], enemies: [] },
      "forest": {
        skills: ["woodcutting", "herblore"],
        enemies: [
          { name: "Goblin Captain", icon: "ğŸ‘¹", level: 5, hp: 760, attack: 200, gold: 10, exp: 25, drops: [
            // Common drops
            { item: "copper", chance: 0.40, min: 2, max: 8 },
            { item: "iron", chance: 0.30, min: 1, max: 3 },
            { item: "wood", chance: 0.35, min: 2, max: 5 },
            { item: "cooked_shrimp", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_trout", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 2 },
            { item: "greenleaf", chance: 0.30, min: 1, max: 3 },
            { item: "swiftgrass", chance: 0.25, min: 1, max: 2 },
            // Seed drops
            { item: "raspberry_seed", chance: 0.05, min: 1, max: 1 },
            { item: "blackberry_seed", chance: 0.05, min: 1, max: 1 },
            // Rare drops
            { item: "bronze_shield", chance: 0.15, min: 1, max: 1 },
            { item: "bronze_helmet", chance: 0.12, min: 1, max: 1 },
            { item: "sword", chance: 0.10, min: 1, max: 1 },
            { item: "greater_healing_potion", chance: 0.08, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.06, min: 1, max: 1 }
          ] },
          { name: "Goblin General", icon: "ğŸ‘‘", level: 7, hp: 1040, attack: 260, gold: 16, exp: 38, drops: [
            // Common drops
            { item: "copper", chance: 0.35, min: 3, max: 10 },
            { item: "iron", chance: 0.30, min: 1, max: 4 },
            { item: "wood", chance: 0.30, min: 3, max: 6 },
            { item: "cooked_trout", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_frog_legs", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.25, min: 1, max: 2 },
            // Rare drops
            { item: "bronze_helmet", chance: 0.18, min: 1, max: 1 },
            { item: "bronze_platebody", chance: 0.12, min: 1, max: 1 },
            { item: "iron_shield", chance: 0.10, min: 1, max: 1 },
            { item: "sword", chance: 0.12, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.08, min: 1, max: 1 },
            { item: "bronze_pickaxe", chance: 0.05, min: 1, max: 1 }
          ] },
          { name: "Wolf", icon: "ğŸº", level: 4, hp: 640, attack: 160, gold: 7, exp: 18, drops: [
            // Common drops
            { item: "wolf_pelt", chance: 0.35, min: 1, max: 2 },
            { item: "copper", chance: 0.30, min: 2, max: 7 },
            { item: "cooked_shrimp", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_trout", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 1 },
            // Rare drops
            { item: "leather_boots", chance: 0.12, min: 1, max: 1 },
            { item: "bronze_shield", chance: 0.08, min: 1, max: 1 },
            // Ultra rare drops
            { item: "wooden_chest", chance: 0.06, min: 1, max: 1 }
          ] }
        ]
      },
      "cave": {
        skills: ["mining", "herblore"],
        enemies: [
          { name: "Ogre", icon: "ğŸ‘¹", level: 10, hp: 1800, attack: 440, gold: 28, exp: 60, drops: [
            // Common drops
            { item: "iron", chance: 0.35, min: 1, max: 5 },
            { item: "copper", chance: 0.35, min: 3, max: 12 },
            { item: "wood", chance: 0.25, min: 2, max: 6 },
            { item: "cooked_frog_legs", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_trout", chance: 0.25, min: 1, max: 3 },
            { item: "minor_healing_potion", chance: 0.30, min: 1, max: 2 },
            { item: "glowcap", chance: 0.25, min: 1, max: 2 },
            { item: "earthweed", chance: 0.20, min: 1, max: 2 },
            // Seed drops
            { item: "lettuce_seed", chance: 0.05, min: 1, max: 1 },
            { item: "radish_seed", chance: 0.05, min: 1, max: 1 },
            { item: "tomato_seed", chance: 0.04, min: 1, max: 1 },
            // Rare drops
            { item: "iron_boots", chance: 0.15, min: 1, max: 1 },
            { item: "iron_shield", chance: 0.12, min: 1, max: 1 },
            { item: "iron_helmet", chance: 0.10, min: 1, max: 1 },
            { item: "bronze_platebody", chance: 0.12, min: 1, max: 1 },
            { item: "greater_healing_potion", chance: 0.10, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.08, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.05, min: 1, max: 1 }
          ] },
          { name: "Rock Crab", icon: "ğŸ¦€", level: 8, hp: 2400, attack: 260, gold: 18, exp: 45, drops: [
            // Common drops
            { item: "rock_shell", chance: 0.40, min: 1, max: 2 },
            { item: "iron", chance: 0.30, min: 1, max: 4 },
            { item: "copper", chance: 0.30, min: 2, max: 10 },
            { item: "cooked_trout", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.25, min: 1, max: 2 },
            // Rare drops
            { item: "bronze_platelegs", chance: 0.12, min: 1, max: 1 },
            { item: "iron_shield", chance: 0.10, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.06, min: 1, max: 1 },
            { item: "iron_pickaxe", chance: 0.04, min: 1, max: 1 }
          ] }
        ]
      },
      "fishing-pond": {
        skills: ["fishing", "herblore"],
        enemies: [
          { name: "Giant Frog", icon: "ğŸ¸", level: 7, hp: 1200, attack: 200, gold: 12, exp: 30, drops: [
            // Common drops
            { item: "frog_legs", chance: 0.45, min: 1, max: 3 },
            { item: "copper", chance: 0.30, min: 2, max: 8 },
            { item: "shrimp", chance: 0.35, min: 2, max: 5 },
            { item: "trout", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_shrimp", chance: 0.20, min: 1, max: 2 },
            { item: "minor_healing_potion", chance: 0.20, min: 1, max: 2 },
            { item: "earthweed", chance: 0.30, min: 1, max: 2 },
            { item: "bloodroot", chance: 0.25, min: 1, max: 2 },
            // Rare drops
            { item: "bronze_platelegs", chance: 0.10, min: 1, max: 1 },
            { item: "leather_boots", chance: 0.12, min: 1, max: 1 },
            { item: "minor_haste_potion", chance: 0.08, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.05, min: 1, max: 1 },
            { item: "bronze_axe", chance: 0.04, min: 1, max: 1 }
          ] }
        ]
      },
      "volcanic-plain": {
        skills: ["herblore"],
        enemies: [
          { name: "Ash Drake Whelp", icon: "ğŸ”¥", level: 11, hp: 1400, attack: 300, gold: 18, exp: 38, drops: [
            // Common drops
            { item: "ash_powder", chance: 0.45, min: 1, max: 3 },
            { item: "emberleaf", chance: 0.20, min: 1, max: 2 },
            { item: "iron", chance: 0.30, min: 2, max: 5 },
            { item: "coal", chance: 0.35, min: 2, max: 6 },
            { item: "copper", chance: 0.30, min: 3, max: 12 },
            { item: "cooked_frog_legs", chance: 0.25, min: 1, max: 3 },
            { item: "cooked_trout", chance: 0.20, min: 1, max: 3 },
            { item: "minor_healing_potion", chance: 0.25, min: 1, max: 2 },
            // Rare drops
            { item: "iron_platebody", chance: 0.10, min: 1, max: 1 },
            { item: "iron_helmet", chance: 0.12, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.10, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.07, min: 1, max: 1 },
            { item: "steel_shield", chance: 0.04, min: 1, max: 1 }
          ] },
          { name: "Ash Drake", icon: "ğŸ”¥", level: 14, hp: 2400, attack: 480, gold: 32, exp: 70, drops: [
            // Common drops
            { item: "onyx", chance: 0.30, min: 1, max: 2 },
            { item: "ash_powder", chance: 0.50, min: 2, max: 4 },
            { item: "emberleaf", chance: 0.28, min: 1, max: 3 },
            { item: "iron", chance: 0.35, min: 2, max: 6 },
            { item: "coal", chance: 0.40, min: 3, max: 8 },
            { item: "copper", chance: 0.30, min: 5, max: 15 },
            { item: "cooked_salmon", chance: 0.20, min: 1, max: 3 },
            { item: "cooked_frog_legs", chance: 0.25, min: 1, max: 4 },
            { item: "minor_healing_potion", chance: 0.30, min: 1, max: 3 },
            // Rare drops
            { item: "iron_platebody", chance: 0.12, min: 1, max: 1 },
            { item: "iron_platelegs", chance: 0.10, min: 1, max: 1 },
            { item: "steel_shield", chance: 0.10, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.12, min: 1, max: 1 },
            // Ultra rare drops
            { item: "iron_chest", chance: 0.08, min: 1, max: 1 },
            { item: "golden_chest", chance: 0.03, min: 1, max: 1 },
            { item: "amulet_blueprint", chance: 0.02, min: 1, max: 1 }
          ] }
        ]
      },
      "mountains": {
        skills: ["herblore"],
        enemies: [
          { name: "Golem", icon: "ğŸ—¿", level: 18, hp: 3600, attack: 560, gold: 40, exp: 110, drops: [
            // Common drops
            { item: "iron", chance: 0.50, min: 3, max: 8 },
            { item: "coal", chance: 0.40, min: 2, max: 7 },
            { item: "copper", chance: 0.35, min: 5, max: 18 },
            { item: "wood", chance: 0.25, min: 3, max: 8 },
            { item: "cooked_salmon", chance: 0.20, min: 1, max: 4 },
            { item: "cooked_frog_legs", chance: 0.25, min: 2, max: 4 },
            { item: "minor_healing_potion", chance: 0.30, min: 1, max: 3 },
            // Seed drops
            { item: "cucumber_seed", chance: 0.05, min: 1, max: 1 },
            { item: "squash_seed", chance: 0.04, min: 1, max: 1 },
            // Rare drops
            { item: "iron_platelegs", chance: 0.12, min: 1, max: 1 },
            { item: "iron_platebody", chance: 0.10, min: 1, max: 1 },
            { item: "steel_helmet", chance: 0.10, min: 1, max: 1 },
            { item: "steel_shield", chance: 0.12, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.14, min: 1, max: 1 },
            { item: "iron_chest", chance: 0.12, min: 1, max: 1 },
            // Ultra rare drops
            { item: "stone_familiar", chance: 0.04, min: 1, max: 1 },
            { item: "golden_chest", chance: 0.05, min: 1, max: 1 },
            { item: "amulet_blueprint", chance: 0.03, min: 1, max: 1 },
            { item: "steel_platebody", chance: 0.02, min: 1, max: 1 }
          ] },
          { name: "Dragon", icon: "ğŸ‰", level: 25, hp: 6400, attack: 760, gold: 120, exp: 1000, drops: [
            // Common drops - Resources & Food
            { item: "dragon_scale", chance: 0.50, min: 1, max: 2 },
            { item: "iron", chance: 0.20, min: 1, max: 6 },
            { item: "coal", chance: 0.35, min: 1, max: 6 },
            { item: "wood", chance: 0.25, min: 5, max: 10 },
            { item: "copper", chance: 0.35, min: 1, max: 10 },
            { item: "cooked_salmon", chance: 0.20, min: 1, max: 5 },
            { item: "cooked_frog_legs", chance: 0.30, min: 1, max: 3 },
            { item: "cooked_trout", chance: 0.20, min: 1, max: 6 },
            { item: "minor_healing_potion", chance: 0.30, min: 1, max: 3 },
            { item: "silverleaf", chance: 0.30, min: 1, max: 3 },
            { item: "ironleaf", chance: 0.25, min: 1, max: 2 },
            { item: "nightshade_bloom", chance: 0.20, min: 1, max: 2 },
            // Seed drops
            { item: "squash_seed", chance: 0.06, min: 1, max: 2 },
            { item: "tomato_seed", chance: 0.05, min: 1, max: 1 },
            { item: "cucumber_seed", chance: 0.05, min: 1, max: 1 },
            // Rare drops - Equipment & Chests
            { item: "steel_platebody", chance: 0.05, min: 1, max: 1 },
            { item: "steel_helmet", chance: 0.08, min: 1, max: 1 },
            { item: "steel_shield", chance: 0.08, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.12, min: 1, max: 1 },
            { item: "iron_chest", chance: 0.10, min: 1, max: 1 },
            { item: "superior_healing_potion", chance: 0.12, min: 1, max: 2 },
            { item: "greater_attack_potion", chance: 0.08, min: 1, max: 1 },
            { item: "greater_defense_potion", chance: 0.08, min: 1, max: 1 },
            // Ultra rare drops - Blueprints, Familiars, Amulets, Chests
            { item: "dragon_sword_blueprint", chance: 0.05, min: 1, max: 1 },
            { item: "amulet_blueprint", chance: 0.05, min: 1, max: 1 },
            { item: "dragon_amulet", chance: 0.02, min: 1, max: 1 },
            { item: "dragon_familiar", chance: 0.03, min: 1, max: 1 },
            { item: "golden_chest", chance: 0.05, min: 1, max: 1 },
            { item: "dragon_sword", chance: 0.01, min: 1, max: 1 },
            { item: "steel_platelegs", chance: 0.03, min: 1, max: 1 }
          ] },
          { name: "Elder Dragon", icon: "ğŸ²", level: 40, hp: 30000, attack: 1200, gold: 1000, exp: 5000, drops: [
            // Common drops - Resources & Food
            { item: "elder_scale", chance: 0.50, min: 1, max: 3 },
            { item: "dragon_scale", chance: 0.50, min: 1, max: 3 },
            { item: "iron", chance: 0.50, min: 5, max: 15 },
            { item: "coal", chance: 0.45, min: 5, max: 12 },
            { item: "wood", chance: 0.40, min: 8, max: 20 },
            { item: "copper", chance: 0.40, min: 10, max: 30 },
            { item: "cooked_salmon", chance: 0.45, min: 3, max: 8 },
            { item: "cooked_frog_legs", chance: 0.40, min: 2, max: 6 },
            { item: "cooked_trout", chance: 0.50, min: 3, max: 8 },
            { item: "minor_healing_potion", chance: 0.50, min: 3, max: 6 },
            { item: "spirit_moss", chance: 0.35, min: 1, max: 3 },
            { item: "astral_lotus", chance: 0.30, min: 1, max: 2 },
            { item: "chronoweed", chance: 0.25, min: 1, max: 2 },
            // Seed drops
            { item: "squash_seed", chance: 0.10, min: 1, max: 3 },
            { item: "tomato_seed", chance: 0.08, min: 1, max: 2 },
            { item: "cucumber_seed", chance: 0.08, min: 1, max: 2 },
            // Rare drops - Equipment & Chests
            { item: "steel_platebody", chance: 0.20, min: 1, max: 1 },
            { item: "steel_platelegs", chance: 0.18, min: 1, max: 1 },
            { item: "steel_helmet", chance: 0.15, min: 1, max: 1 },
            { item: "steel_shield", chance: 0.15, min: 1, max: 1 },
            { item: "iron_sword", chance: 0.20, min: 1, max: 1 },
            { item: "dragon_sword", chance: 0.12, min: 1, max: 1 },
            { item: "iron_chest", chance: 0.18, min: 1, max: 2 },
            { item: "golden_chest", chance: 0.15, min: 1, max: 2 },
            { item: "superior_healing_potion", chance: 0.15, min: 1, max: 3 },
            { item: "attack_elixir", chance: 0.10, min: 1, max: 1 },
            { item: "defense_elixir", chance: 0.10, min: 1, max: 1 },
            { item: "superior_haste_potion", chance: 0.08, min: 1, max: 1 },
            // Ultra rare drops - Blueprints, Familiars, Amulets
            { item: "elder_sword_blueprint", chance: 0.05, min: 1, max: 1 },
            { item: "dragon_sword_blueprint", chance: 0.05, min: 1, max: 1 },
            { item: "amulet_blueprint", chance: 0.05, min: 1, max: 1 },
            { item: "dragon_amulet", chance: 0.05, min: 1, max: 1 },
            { item: "elder_familiar", chance: 0.03, min: 1, max: 1 },
            { item: "dragon_familiar", chance: 0.05, min: 1, max: 1 },
            { item: "elder_sword", chance: 0.03, min: 1, max: 1 },
            { item: "fortune_potion", chance: 0.02, min: 1, max: 1 }
          ] }
        ]
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Helper: prettify item ids to Title Case if name missing
    const getItemName = (itemId) => {
      const data = ITEMS_DATA[itemId];
      const raw = (data && data.name) || itemId || "";
      return raw
        .toString()
        .replace(/[_-]+/g, " ")
        .replace(/\b\w/g, (m) => m.toUpperCase());
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REACT COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ItemIcon component - displays PNG if available, otherwise emoji
    function ItemIcon({ itemId, size = "text-2xl", className = "" }) {
      const imagePath = ITEM_IMAGES[itemId];
      const fallbackIcon = ITEMS_DATA[itemId]?.icon || "â“";
      const [imgError, setImgError] = React.useState(false);
      
      if (imagePath && !imgError) {
        const sizeMap = {
          "text-xs": "16px",
          "text-sm": "20px",
          "text-base": "24px",
          "text-lg": "28px",
          "text-xl": "32px",
          "text-2xl": "40px",
          "text-3xl": "48px",
          "text-4xl": "56px"
        };
        const pixelSize = sizeMap[size] || "40px";
        
        return (
          <img
            src={imagePath}
            alt={itemId}
            style={{
              width: pixelSize,
              height: pixelSize,
              objectFit: "contain",
              imageRendering: "pixelated"
            }}
            className={className}
            onError={() => setImgError(true)}
          />
        );
      }
      
      return <span className={size + " " + className}>{fallbackIcon}</span>;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN GAME COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function Game() {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // STATE MANAGEMENT
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const [player, setPlayer] = useState(() => {
        const saved = localStorage.getItem("player");
        const defaultPlayer = {
          gold: 100, hp: 1000, maxHp: 1000,
          skills: {},
          inventory: { copper: 0, wood: 0, shrimp: 0, cooked_shrimp: 25, sword: 1, bronze_shield: 1 },
          inventoryOrder: [],  // INVENTORY DRAG & DROP - tracks visual order of items
          location: "starter-village",
          homes: {}
        };
        // Initialize equipment slots
        defaultPlayer.equipment = {
          head: null,
          body: null,
          legs: null,
          weapon: null,
          offhand: null,
          boots: null,
          accessory: null,
          tool: null,
          familiar1: null,
          familiar2: null,
          familiar3: null
        };
        ALL_PLAYER_SKILLS.forEach(s => defaultPlayer.skills[s] = { level: 1, exp: 0, expToNext: 50 });
        if (saved) {
          const loaded = JSON.parse(saved);
          // If this save predates the 10x HP bump, scale hp/maxHp by 10 to match new balance
          if (loaded.maxHp && typeof loaded.maxHp === 'number' && loaded.maxHp < defaultPlayer.maxHp) {
            loaded.maxHp = Math.floor(loaded.maxHp * 10);
            if (typeof loaded.hp === 'number') loaded.hp = Math.min(loaded.maxHp, Math.floor((loaded.hp || 0) * 10));
          }
          // Normalize legacy item keys (merge old keys into canonical ones to avoid duplicates)
          const legacyItemAliases = { fish: 'shrimp', cookedFish: 'cooked_shrimp' };
          if (loaded.inventory) {
            Object.keys(legacyItemAliases).forEach(alias => {
              const canon = legacyItemAliases[alias];
              if (loaded.inventory[alias]) {
                loaded.inventory[canon] = (loaded.inventory[canon] || 0) + loaded.inventory[alias];
                delete loaded.inventory[alias];
              }
            });
          }
          const inventory = { ...defaultPlayer.inventory, ...(loaded.inventory || {}) };
          // INVENTORY DRAG & DROP - Merge saved inventory order
          const inventoryOrder = loaded.inventoryOrder || [];
          // Merge saved equipment with default structure to ensure all slots exist
          const equipment = { ...defaultPlayer.equipment, ...(loaded.equipment || {}) };
          // Merge homes and process offline farming growth
          const homes = { ...(loaded.homes || {}) };
          const now = Date.now();
          Object.keys(homes).forEach(locationId => {
            const home = homes[locationId];
            // HOME INVENTORY DRAG & DROP - Ensure inventoryOrder exists for legacy saves
            if (!home.inventoryOrder) {
              home.inventoryOrder = [];
            }
            if (home.plots) {
              home.plots = home.plots.map(plot => {
                if (plot.seedId && plot.plantedAt && !plot.ready) {
                  const elapsed = now - plot.plantedAt;
                  if (elapsed >= plot.growthTime) {
                    return { ...plot, ready: true };
                  }
                }
                return plot;
              });
            }
          });
          return {
            ...defaultPlayer, ...loaded, skills: { ...defaultPlayer.skills, ...(loaded.skills || {}) }, inventory, inventoryOrder, equipment, homes,
            location: locations[loaded.location] ? loaded.location : "starter-village"
          };
        }
        return defaultPlayer;
      });

      // INVENTORY DRAG & DROP STATE
      const [draggedItem, setDraggedItem] = useState(null);
      const [dragOverItem, setDragOverItem] = useState(null);
      // HOME INVENTORY DRAG & DROP STATE
      const [draggedHomeItem, setDraggedHomeItem] = useState(null);
      const [dragOverHomeItem, setDragOverHomeItem] = useState(null);

      const [activeSkill, setActiveSkill] = useState(null);
      const [progress, setProgress] = useState(0);
      const startTime = useRef(null);
      const skillEndTimeRef = useRef(null);
      const [enemy, setEnemy] = useState(null);
      const [combatLog, setCombatLog] = useState(() => {
        const savedLog = localStorage.getItem("combatLog");
        return savedLog ? JSON.parse(savedLog) : [];
      });
      const [selectedCombatSkill, setSelectedCombatSkill] = useState("strength");
      const [activeResource, setActiveResource] = useState(null);
      const [shopQuantity, setShopQuantity] = useState(1);
      const [autoCombatEnabled, setAutoCombatEnabled] = useState(true);
      const [autoEatEnabled, setAutoEatEnabled] = useState(false);
      const [autoEatThreshold, setAutoEatThreshold] = useState(60);
      const [autoEatFood, setAutoEatFood] = useState('cooked_salmon');
      const [activePotions, setActivePotions] = useState(() => {
        const saved = localStorage.getItem("activePotions");
        return saved ? JSON.parse(saved) : [];
      });
      const autoCombatInterval = useRef(null);
      const respawnTimer = useRef(null);
      const countdownTimerRef = useRef(null);
      const [combatProgress, setCombatProgress] = useState(0);
      const combatStartTime = useRef(null);
      const [respawnCountdown, setRespawnCountdown] = useState(0);
      const [activeTab, setActiveTab] = useState('inventory');
      const attackEnemyRef = useRef(null);
      const [craftCategory, setCraftCategory] = useState("sword");

      // TRAVEL TIMER STATE - Minimal travel state variables
      const [isTraveling, setIsTraveling] = useState(false);
      const [travelProgress, setTravelProgress] = useState(0);
      const travelStartTime = useRef(null);
      const travelDestination = useRef(null);

      // HOME & FARMING UI STATE
      const [homeView, setHomeView] = useState("overview"); // "overview" | "inventory" | "farming"
      const [selectedPlotIndex, setSelectedPlotIndex] = useState(null);

      // SKILLS / QUESTS / EQUIPMENT TABS
      const [activeLeftTab, setActiveLeftTab] = useState('skills'); // 'skills' | 'quests' | 'equipment'

      // ADVENTURER PANEL VIEW STATE - Toggle between info and map
      const [adventurerView, setAdventurerView] = useState('info'); // 'info' | 'map'

      // QUEST STATE
      const [quests, setQuests] = useState([
        {
          id: 'goblin_slayer',
          name: 'Goblin Slayer',
          description: 'The Goblin Generals threaten our lands. Hunt them down!',
          objectives: [{ type: 'kill', target: 'Goblin General', current: 0, required: 25 }],
          rewards: { wood: 2000 },
          status: 'available' // available | active | completed | turned_in
        },
        {
          id: 'apprentice_miner',
          name: 'Apprentice Miner',
          description: 'Prove your worth in the mines by gathering copper ore.',
          objectives: [{ type: 'gather', target: 'copper_ore', skill: 'mining', current: 0, required: 150 }],
          rewards: { gold: 1000, exp: { mining: 1000 } },
          status: 'available'
        },
        {
          id: 'master_chef',
          name: 'Master Chef',
          description: 'The village needs a skilled cook. Master the art of cooking!',
          objectives: [{ type: 'skill_level', skill: 'cooking', current: 0, required: 10 }],
          rewards: { items: [{ id: 'cooked_salmon', qty: 100 }] },
          status: 'available'
        }
      ]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUTHENTICATION STATE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const [authToken, setAuthToken] = useState(() => localStorage.getItem("authToken"));
      const [user, setUser] = useState(null);
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [authLoading, setAuthLoading] = useState(true);
      const [authError, setAuthError] = useState(null);
      const [authView, setAuthView] = useState("login"); // "login" | "register"
      const [loginEmail, setLoginEmail] = useState("");
      const [loginPassword, setLoginPassword] = useState("");
      const [registerDisplayName, setRegisterDisplayName] = useState("");
      const [playingOffline, setPlayingOffline] = useState(() => localStorage.getItem("playingOffline") === "true"); // True when user skips login

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SAVE SYSTEM STATE (Debounce for server saves)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const saveTimeoutRef = useRef(null);
      const lastSaveTimeRef = useRef(0);
      const SAVE_DEBOUNCE_MS = 3000; // 3 seconds minimum between server saves
      const pendingReasonRef = useRef(null);         // non-null when a server save is pending
      const justLoadedFromServerRef = useRef(false); // set by loadServerSave to skip next effect

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PLAYERS IN LOCATION STATE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const [playersHere, setPlayersHere] = useState([]);
      const playersRefreshRef = useRef(null);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PLAYER IDENTITY HELPER
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function getPlayerIdentity() {
        const totalLevel = Object.values(player.skills).reduce((sum, s) => sum + s.level, 0);
        const combatLevel = (player.skills.attack?.level || 1) +
                            (player.skills.defense?.level || 1) +
                            (player.skills.strength?.level || 1) +
                            (player.skills.health?.level || 1);
        // Determine current activity
        let currentActivity = "idle";
        if (enemy) currentActivity = `fighting ${enemy.name}`;
        else if (activeSkill) currentActivity = `${activeSkill}`;
        else if (isTraveling) currentActivity = "traveling";

        return {
          playerId: user?.id || null,
          displayName: user?.displayName || "Adventurer",
          totalLevel,
          combatLevel,
          currentLocation: player.location,
          currentActivity,
          lastOnline: Date.now()
        };
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SAVE GAME FUNCTION (with debounce for server saves)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function performServerSave(playerData, reason) {
        lastSaveTimeRef.current = Date.now();
        try {
          const res = await fetch('/api/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              player: playerData,
              playerIdentity: getPlayerIdentity(),
              timestamp: Date.now(),
              reason
            })
          });
          if (!res.ok) {
            console.warn(`Server save failed with status ${res.status} (reason: ${reason})`);
          }
        } catch (err) {
          console.warn("Server save failed, localStorage backup exists:", err);
        }
      }

      function saveGame(reason = "unknown") {
        // Belt-and-suspenders localStorage write; the persist effect (useEffect on
        // [player]) will overwrite with the committed value after the next render.
        localStorage.setItem("player", JSON.stringify(player));

        // Signal the post-render useEffect to perform the server save.
        // Do NOT call performServerSave here â€” player is stale in this closure.
        if (isAuthenticated && authToken) {
          pendingReasonRef.current = reason;
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SERVER LOAD FUNCTION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function loadServerSave(token) {
        try {
          const res = await fetch('/api/load', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (res.ok) {
            const serverData = await res.json();
            if (serverData.player) {
              justLoadedFromServerRef.current = true;
              // Merge server save with existing player state
              setPlayer(prev => {
                return {
                  ...prev,
                  ...serverData.player,
                  skills: { ...prev.skills, ...(serverData.player.skills || {}) },
                  inventory: { ...prev.inventory, ...(serverData.player.inventory || {}) },
                  equipment: { ...prev.equipment, ...(serverData.player.equipment || {}) },
                  homes: { ...prev.homes, ...(serverData.player.homes || {}) }
                };
              });
            }
          }
        } catch (err) {
          console.warn("Server load failed, using localStorage:", err);
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUTHENTICATION FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function handleLogin(email, password) {
        setAuthError(null);
        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          if (!res.ok) {
            const err = await res.json();
            setAuthError(err.message || "Login failed");
            return;
          }
          const { token, user: userData } = await res.json();
          localStorage.setItem("authToken", token);
          setAuthToken(token);
          setUser(userData);
          setIsAuthenticated(true);
          await loadServerSave(token);
        } catch (err) {
          setAuthError("Connection failed. Playing offline.");
        }
      }

      async function handleRegister(email, password, displayName) {
        setAuthError(null);
        try {
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, displayName })
          });
          if (!res.ok) {
            const err = await res.json();
            setAuthError(err.message || "Registration failed");
            return;
          }
          const { token, user: userData } = await res.json();
          localStorage.setItem("authToken", token);
          setAuthToken(token);
          setUser(userData);
          setIsAuthenticated(true);
          // Push current player state to server so it's available on other devices/browsers
          await fetch('/api/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              player,
              playerIdentity: getPlayerIdentity(),
              timestamp: Date.now(),
              reason: "register"
            })
          });
        } catch (err) {
          setAuthError("Connection failed");
        }
      }

      function handleLogout() {
        // Flush any pending server save before auth state is cleared.
        // player and authToken in this closure ARE current: the user just clicked
        // a button, so this handler is from the latest committed render.
        if (pendingReasonRef.current !== null && isAuthenticated && authToken) {
          performServerSave(player, "logout_flush");
          pendingReasonRef.current = null;
        }
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
          saveTimeoutRef.current = null;
        }
        localStorage.removeItem("authToken");
        localStorage.removeItem("playingOffline");
        setAuthToken(null);
        setUser(null);
        setIsAuthenticated(false);
        setPlayingOffline(false);
      }

      function skipLogin() {
        // Allow offline play without login
        localStorage.setItem("playingOffline", "true");
        setPlayingOffline(true);
        setAuthLoading(false);
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUTH VERIFICATION ON MOUNT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      useEffect(() => {
        const verifyAuth = async () => {
          const token = localStorage.getItem("authToken");
          if (!token) {
            setAuthLoading(false);
            return;
          }
          try {
            const res = await fetch('/api/verify', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
              const userData = await res.json();
              setUser(userData);
              setIsAuthenticated(true);
              await loadServerSave(token);
            } else {
              localStorage.removeItem("authToken");
              setAuthToken(null);
            }
          } catch (err) {
            console.warn("Auth verification failed, continuing offline:", err);
          }
          setAuthLoading(false);
        };
        verifyAuth();
      }, []);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // TAB VISIBILITY HANDLER - Catch up progress when returning to tab
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (!document.hidden) {
            // Tab became visible - force state update to trigger re-renders
            // This ensures progress bars and timers update immediately
            setProgress(prev => prev);
            setTravelProgress(prev => prev);
            setCombatProgress(prev => prev);
          }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, []);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FETCH PLAYERS AT CURRENT LOCATION (every 30 seconds)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      useEffect(() => {
        const fetchPlayers = async () => {
          if (!isAuthenticated) {
            setPlayersHere([]);
            return;
          }
          try {
            const res = await fetch(`/api/location/players?location=${player.location}`, {
              headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (res.ok) {
              const data = await res.json();
              setPlayersHere(data.players || []);
            }
          } catch (err) {
            console.warn("Failed to fetch players:", err);
          }
        };

        fetchPlayers(); // Initial fetch
        playersRefreshRef.current = setInterval(fetchPlayers, 30000); // Every 30s

        return () => {
          if (playersRefreshRef.current) clearInterval(playersRefreshRef.current);
        };
      }, [player.location, isAuthenticated, authToken]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PERSIST STATE TO LOCALSTORAGE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      useEffect(() => localStorage.setItem("player", JSON.stringify(player)), [player]);
      // AUTO SERVER SAVE â€” fires after player is committed by React, so player IS current.
      useEffect(() => {
        // Guard: skip the player change that came from loadServerSave (prevents loop)
        if (justLoadedFromServerRef.current) {
          justLoadedFromServerRef.current = false;
          return;
        }
        // Guard: skip if no saveGame() was called (e.g. farming timer updates)
        if (pendingReasonRef.current === null) return;
        // Guard: skip if not authenticated
        if (!isAuthenticated || !authToken) {
          pendingReasonRef.current = null;
          return;
        }

        const reason = pendingReasonRef.current;
        pendingReasonRef.current = null;

        // Debounce: immediate if enough time passed, otherwise schedule
        const timeSinceLastSave = Date.now() - lastSaveTimeRef.current;
        if (timeSinceLastSave >= SAVE_DEBOUNCE_MS) {
          performServerSave(player, reason);
        } else {
          if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
          saveTimeoutRef.current = setTimeout(() => {
            // Read from localStorage: if farming-timer updates changed player between
            // when this effect ran and now, localStorage (kept in sync by the persist
            // effect above) has the latest value.
            const latestPlayer = JSON.parse(localStorage.getItem("player")) || player;
            performServerSave(latestPlayer, "batched");
            saveTimeoutRef.current = null;
          }, SAVE_DEBOUNCE_MS - timeSinceLastSave);
        }
      }, [player]);
      useEffect(() => localStorage.setItem("combatLog", JSON.stringify(combatLog)), [combatLog]);
      useEffect(() => localStorage.setItem("activePotions", JSON.stringify(activePotions)), [activePotions]);
      useEffect(() => localStorage.setItem("playingOffline", playingOffline ? "true" : "false"), [playingOffline]);
      const currentLocation = locations[player.location] || { skills: [], enemies: [] };

      // FARMING GROWTH TIMER - Check plots every second
      useEffect(() => {
        const interval = setInterval(() => {
          setPlayer(prev => {
            if (!prev.homes || Object.keys(prev.homes).length === 0) return prev;
            const homes = { ...prev.homes };
            let changed = false;
            const now = Date.now();
            Object.keys(homes).forEach(locationId => {
              const home = homes[locationId];
              if (!home.plots) return;
              homes[locationId] = {
                ...home,
                plots: home.plots.map(plot => {
                  if (plot.seedId && plot.plantedAt && !plot.ready) {
                    const elapsed = now - plot.plantedAt;
                    if (elapsed >= plot.growthTime) {
                      changed = true;
                      return { ...plot, ready: true };
                    }
                  }
                  return plot;
                })
              };
            });
            if (changed) {
              return { ...prev, homes };
            }
            return prev;
          });
        }, 1000);
        return () => clearInterval(interval);
      }, []);

      // TRAVEL TIMER LOGIC - Travel progress animation and completion
      useEffect(() => {
        if (!isTraveling) {
          setTravelProgress(0);
          return;
        }

        let animationId;
        function updateTravelProgress() {
          if (travelStartTime.current) {
            const elapsed = Date.now() - travelStartTime.current;
            const progress = Math.min((elapsed / TRAVEL_DURATION) * 100, 100);
            setTravelProgress(progress);

            // Travel complete
            if (elapsed >= TRAVEL_DURATION) {
              const destination = travelDestination.current;
              setIsTraveling(false);
              travelStartTime.current = null;
              travelDestination.current = null;
              setTravelProgress(0);
              // Update player location
              setPlayer(prev => ({ ...prev, location: destination }));
              setCombatLog(prev => [...prev, `ğŸš¶ Arrived at ${destination.replace(/-/g, " ")}.`]);
              saveGame("location_change");
              return;
            }
          }
          animationId = requestAnimationFrame(updateTravelProgress);
        }

        animationId = requestAnimationFrame(updateTravelProgress);
        return () => cancelAnimationFrame(animationId);
      }, [isTraveling]);

      // Check if a location is adjacent to the current player location (for map navigation)
      const isAdjacentLocation = (targetLoc) => {
        const adjacentLocs = LOCATION_ADJACENCY[player.location] || [];
        return adjacentLocs.includes(targetLoc);
      };

      // TRAVEL TIMER LOGIC - Start travel function
      function startTravel(destination) {
        // If already traveling or already at destination, do nothing
        if (isTraveling || destination === player.location) return;

        // Cancel any active activities before traveling
        setEnemy(null);
        setActiveSkill(null); skillEndTimeRef.current = null;
        skillEndTimeRef.current = null;
        setActiveResource(null);
        skillEndTimeRef.current = null;
        setProgress(0);
        skillEndTimeRef.current = null;
        if (autoCombatInterval.current) clearInterval(autoCombatInterval.current);
        if (respawnTimer.current) clearTimeout(respawnTimer.current);
        if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
        setRespawnCountdown(0);

        // Start travel
        setIsTraveling(true);
        travelStartTime.current = Date.now();
        travelDestination.current = destination;
        setCombatLog(prev => [...prev, `ğŸš¶ Traveling to ${destination.replace(/-/g, " ")}...`]);
      }

      useEffect(() => {
        if (activeSkill && !currentLocation.skills.includes(activeSkill) && activeSkill !== "cooking" && activeSkill !== "herblore") {
          setActiveSkill(null); skillEndTimeRef.current = null; setProgress(0); setActiveResource(null);
          skillEndTimeRef.current = null;
        }
        // Force cleanup of all activities on location change
        setEnemy(null);
        setActiveSkill(null); skillEndTimeRef.current = null;
        skillEndTimeRef.current = null;
        setProgress(0);
        setActiveResource(null);
        skillEndTimeRef.current = null;
        if (autoCombatInterval.current) clearInterval(autoCombatInterval.current);
        if (respawnTimer.current) clearTimeout(respawnTimer.current);
        if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
        setRespawnCountdown(0);
      }, [player.location]);

      // Training loop - uses Date.now() for accurate timing even when tab is backgrounded
      useEffect(() => {
        if (!activeSkill) return;
        let animationFrameId;

        function tick() {
          const now = Date.now();
          if (!startTime.current) startTime.current = now;

          // HARD STOP check on each tick so the skill stops promptly after 1 hour even if browser throttles timers
          if (skillEndTimeRef.current && now >= skillEndTimeRef.current) {
            setCombatLog(prev => [...prev, `â³ Stopped â€” activity ended due to fatigue.`]);
            setActiveSkill(null);
            setActiveResource(null);
            setProgress(0);
            startTime.current = null;
            skillEndTimeRef.current = null;
            return;
          }

          // Calculate interval with tool bonus and potion speed bonus
          let interval = activeResource ? (activeResource.interval || TRAIN_DURATION) : TRAIN_DURATION;
          const toolItem = player.equipment && player.equipment.tool ? ITEMS_DATA[player.equipment.tool] : null;
          if (toolItem && toolItem.bonus && toolItem.bonus.skill === activeSkill) {
            interval *= toolItem.bonus.multiplier;
          }
          // Apply potion speed bonus (reduces interval time)
          const potionBonuses = getPotionBonuses();
          if (potionBonuses.skill_speed_percent > 0) {
            interval *= (1 - potionBonuses.skill_speed_percent / 100);
          }

          // Process multiple completed cycles if tab was backgrounded
          let currentElapsed = now - startTime.current;
          while (currentElapsed >= interval && skillEndTimeRef.current && now < skillEndTimeRef.current) {
            completeSkillCycle(activeSkill);
            // If timer expired during cycle, skillEndTimeRef is now null - stop the loop
            if (!skillEndTimeRef.current) {
              return;
            }
            startTime.current = startTime.current + interval;
            currentElapsed = now - startTime.current;
          }

          // Update progress bar
          setProgress(Math.min((currentElapsed / interval) * 100, 100));

          animationFrameId = requestAnimationFrame(tick);
        }

        animationFrameId = requestAnimationFrame(tick);

        return () => {
          startTime.current = null;
          cancelAnimationFrame(animationFrameId);
        };
      }, [activeSkill, activeResource]);

      // Combat timer animation and cleanup
      useEffect(() => {
        if (!enemy || !autoCombatEnabled) {
          setCombatProgress(0);
          if (autoCombatInterval.current) {
            clearInterval(autoCombatInterval.current);
            autoCombatInterval.current = null;
          }
          return;
        }

        let animationId;
        function updateCombatProgress() {
          if (combatStartTime.current) {
            const elapsed = Date.now() - combatStartTime.current;
            const progress = Math.min((elapsed / 5000) * 100, 100);
            setCombatProgress(progress);
          }
          animationId = requestAnimationFrame(updateCombatProgress);
        }

        animationId = requestAnimationFrame(updateCombatProgress);
        return () => cancelAnimationFrame(animationId);
      }, [enemy, autoCombatEnabled]);

      // Global cleanup when enemy is cleared
      useEffect(() => {
        if (!enemy) {
          if (autoCombatInterval.current) {
            clearInterval(autoCombatInterval.current);
            autoCombatInterval.current = null;
          }
        }
      }, [enemy]);

      // Auto-attack when a new enemy appears
      useEffect(() => {
        if (enemy && autoCombatEnabled && autoCombatInterval.current) {
          // Enemy just appeared, attack immediately
          if (attackEnemyRef.current) {
            attackEnemyRef.current();
          }
        }
      }, [enemy?.name]);

      // Keep attackEnemy ref updated
      useEffect(() => {
        attackEnemyRef.current = attackEnemy;
      });

      // Clean up expired potions every second
      useEffect(() => {
        const interval = setInterval(() => {
          setActivePotions(prev => {
            const now = Date.now();
            const stillActive = prev.filter(p => {
              const expired = (now - p.startedAt) >= p.durationMs;
              if (expired) {
                const potionName = ITEMS_DATA[p.potionId]?.name || p.potionId;
                setCombatLog(prevLog => [...prevLog, `â±ï¸ ${potionName} effect has worn off.`]);
              }
              return !expired;
            });
            return stillActive;
          });
        }, 1000);

        return () => clearInterval(interval);
      }, []);

      function completeSkillCycle(skillName) {
        // HARD STOP: if an end timestamp exists and we've reached it, stop the active skill silently
        if (skillEndTimeRef.current && Date.now() >= skillEndTimeRef.current) {
          setActiveSkill(null); skillEndTimeRef.current = null;
          setActiveResource(null);
          setProgress(0);
          startTime.current = null;
          skillEndTimeRef.current = null;
          setCombatLog(prev => [...prev, `â³ Stopped â€” activity ended due fatigue.`]);
          return;
        }

        setPlayer(prev => {
          const skills = { ...prev.skills };
          const skill = { ...skills[skillName] };
          let inventory = { ...prev.inventory };
          let earnedXp = 25 + skill.level * 3;
          let logLevelUp = [];

          if (activeResource) {
            // Special handling for cooking: consume resources and produce cooked item each cycle; stop when out of resources
            if (skillName === 'cooking' && activeResource && activeResource.cooked) {
              const rawKey = activeResource.raw;
              const cookedKey = activeResource.cooked;
              const woodKey = 'wood';
              const haveRaw = (inventory[rawKey] || 0) > 0;
              const haveWood = (inventory[woodKey] || 0) > 0;
              if (!haveRaw || !haveWood) {
                setCombatLog(prev => [...prev, `âŒ Stopped cooking â€” missing resources.`]);
                setActiveSkill(null); skillEndTimeRef.current = null;
                setActiveResource(null);
                setProgress(0);
                skillEndTimeRef.current = null;
              } else {
                // Random yield 1-3 with matching resource consumption
                const desiredYield = Math.floor(Math.random() * 3) + 1; // 1, 2, or 3
                const availableRaw = inventory[rawKey] || 0;
                const availableWood = inventory[woodKey] || 0;
                const actualYield = Math.min(desiredYield, availableRaw, availableWood);

                // Consume and produce
                inventory[rawKey] = Math.max(0, (inventory[rawKey] || 0) - actualYield);
                inventory[woodKey] = Math.max(0, (inventory[woodKey] || 0) - actualYield);
                inventory[cookedKey] = (inventory[cookedKey] || 0) + actualYield;
                earnedXp = (activeResource.xp || 0) * actualYield;
                const cookedName = ITEMS_DATA[cookedKey]?.name || cookedKey;
                const cookedEntry = { type: 'drop', prefix: `ğŸ”¥`, items: [{ id: cookedKey, name: cookedName, qty: actualYield }], suffix: `(+${earnedXp} XP)` };
                setCombatLog(prev => [...prev, cookedEntry]);
                // keep activeSkill/resource so cooking repeats automatically
                // (progress will reset by the training loop when the next tick starts)
              }
            } else if (skillName === 'herblore' && activeResource && activeResource.name) {
              // Special handling for potion crafting: consume ingredients and produce potion each cycle; stop when out of ingredients
              const potionKey = activeResource.name;
              const recipeCost = activeResource.cost || {};

              // Check if we have all ingredients
              let canCraft = true;
              for (const [ingredientKey, requiredQty] of Object.entries(recipeCost)) {
                if ((inventory[ingredientKey] || 0) < requiredQty) {
                  canCraft = false;
                  break;
                }
              }

              if (!canCraft) {
                setCombatLog(prev => [...prev, `âŒ Stopped crafting â€” missing ingredients.`]);
                setActiveSkill(null); skillEndTimeRef.current = null;
                setActiveResource(null);
                setProgress(0);
                skillEndTimeRef.current = null;
              } else {
                // Consume ingredients
                for (const [ingredientKey, requiredQty] of Object.entries(recipeCost)) {
                  inventory[ingredientKey] = Math.max(0, (inventory[ingredientKey] || 0) - requiredQty);
                }

                // Produce potion
                inventory[potionKey] = (inventory[potionKey] || 0) + 1;
                earnedXp = activeResource.xp || 0;

                // Apply potion XP bonus
                const potionBonuses = getPotionBonuses();
                if (potionBonuses.skill_xp_percent > 0) {
                  earnedXp = Math.floor(earnedXp * (1 + potionBonuses.skill_xp_percent / 100));
                }

                // Log the crafting
                const potionName = ITEMS_DATA[potionKey]?.name || potionKey;
                setCombatLog(prev => [...prev, { type: 'drop', prefix: 'ğŸ§ª Crafted:', items: [{ id: potionKey, name: potionName, qty: 1 }], suffix: `(+${earnedXp} Herblore XP)` }]);

                // keep activeSkill/resource so crafting repeats automatically
              }
            } else {
              earnedXp = activeResource.xp;

              // Get potion bonuses
              const potionBonuses = getPotionBonuses();

              // Apply potion XP bonus
              if (potionBonuses.skill_xp_percent > 0) {
                earnedXp = Math.floor(earnedXp * (1 + potionBonuses.skill_xp_percent / 100));
              }

              // Process drops for gathering-style resources
              let allDroppedItems = [];
              if (activeResource.drops) {
                activeResource.drops.forEach(drop => {
                  if (Math.random() < drop.chance) {
                    let qty = Math.floor(Math.random() * (drop.max - drop.min + 1)) + drop.min;
                    // Apply extra resources bonus
                    if (potionBonuses.extra_resources > 0 && Math.random() < potionBonuses.extra_resources / 100) {
                      qty += 1; // Grant 1 bonus resource
                    }
                    inventory[drop.item] = (inventory[drop.item] || 0) + qty;
                    allDroppedItems.push({ id: drop.item, name: ITEMS_DATA[drop.item]?.name || drop.item, qty });
                  }
                });
              } else {
                let qty = 1;
                // Apply extra resources bonus
                if (potionBonuses.extra_resources > 0 && Math.random() < potionBonuses.extra_resources / 100) {
                  qty += 1; // Grant 1 bonus resource
                }
                inventory[activeResource.id] = (inventory[activeResource.id] || 0) + qty;
                allDroppedItems.push({ id: activeResource.id, name: ITEMS_DATA[activeResource.id]?.name || activeResource.id, qty });
              }

              let verb = "gathered";
              if (skillName === "woodcutting") verb = "chopped";
              if (skillName === "fishing") verb = "caught";
              if (skillName === "mining") verb = "mined";
              if (skillName === "smithing") verb = "smithed";

              if (allDroppedItems.length > 0) {
                setCombatLog(prev => [...prev, { type: 'drop', prefix: `You ${verb}:`, items: allDroppedItems, suffix: `(+${earnedXp} XP)` }]);
                // QUEST PROGRESS - Track gathered resources
                allDroppedItems.forEach(item => {
                  updateQuestProgress('gather', item.id, item.qty);
                });
              }
            }
          }

          if (skillName === "smithing") {
            prev.gold += 15;
            logLevelUp.push(`âš’ï¸ Worked at Blacksmith. Earned 15 Gold! (+${earnedXp} XP)`);
          }

          skill.exp += earnedXp;

          while (skill.exp >= skill.expToNext) {
            skill.exp -= skill.expToNext; skill.level += 1;
            skill.expToNext = Math.floor(skill.expToNext * 1.5);
            logLevelUp.push(`âœ¨ ${skillName.charAt(0).toUpperCase() + skillName.slice(1)} leveled up to ${skill.level}!`);
            if (skillName === "strength" || skillName === "attack") {
              logLevelUp.push(`âš”ï¸ Attack Power increased!`);
            }
            // QUEST PROGRESS - Track skill level ups
            updateQuestProgress('skill_level', skillName, 1);
          }
          if (logLevelUp.length) setCombatLog(prev => [...prev, ...logLevelUp]);
          skills[skillName] = skill;
          return { ...prev, skills, inventory };
        });
        saveGame("skill_complete");
      }

      function completeSkillCycleWithoutProgress(skillName, currentSkill, xp) {
        const newSkill = { ...currentSkill };
        let logLevelUp = [];
        let maxHpIncrease = 0;

        newSkill.exp += xp;
        while (newSkill.exp >= newSkill.expToNext) {
          newSkill.exp -= newSkill.expToNext; newSkill.level += 1;
          newSkill.expToNext = Math.floor(newSkill.expToNext * 1.5);
          logLevelUp.push(`âœ¨ ${skillName.charAt(0).toUpperCase() + skillName.slice(1)} leveled up to ${newSkill.level}!`);

          if (skillName === "health") {
            maxHpIncrease += 100;
            logLevelUp.push(`â¤ï¸ Max HP increased by 100!`);
          }
          if (skillName === "strength" || skillName === "attack") {
            logLevelUp.push(`âš”ï¸ Attack Power increased!`);
          }
          // QUEST PROGRESS - Track combat skill level ups
          updateQuestProgress('skill_level', skillName, 1);
        }
        if (logLevelUp.length) setCombatLog(prev => [...prev, ...logLevelUp]);
        return { skill: newSkill, maxHpIncrease };
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // GAME LOGIC FUNCTIONS
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function startTraining(skillName, resource = null) {
        setEnemy(null);
        setActiveResource(resource);
        setActiveSkill(skillName); setProgress(0);
        // Hard stop: schedule automatic stop 1 hour from start
        skillEndTimeRef.current = Date.now() + (60 * 60 * 1000);
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // QUEST FUNCTIONS
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Accept a quest - move from available to active
      function acceptQuest(questId) {
        setQuests(prev => prev.map(q => {
          if (q.id === questId && q.status === 'available') {
            // For skill_level objectives, set current to player's current level
            const updatedObjectives = q.objectives.map(obj => {
              if (obj.type === 'skill_level') {
                return { ...obj, current: player.skills[obj.skill]?.level || 1 };
              }
              return obj;
            });
            return { ...q, status: 'active', objectives: updatedObjectives };
          }
          return q;
        }));
        setCombatLog(prev => [...prev, `ğŸ“œ Quest accepted: ${quests.find(q => q.id === questId)?.name}`]);
      }

      // Update quest progress for active quests
      function updateQuestProgress(type, target, amount = 1) {
        setQuests(prev => prev.map(q => {
          if (q.status !== 'active') return q;

          let modified = false;
          const updatedObjectives = q.objectives.map(obj => {
            if (obj.type === type) {
              // Match target for kill/gather, or skill for skill_level
              const matches = (type === 'skill_level')
                ? obj.skill === target
                : obj.target === target || obj.target.toLowerCase().replace(/ /g, '_') === target.toLowerCase().replace(/ /g, '_');

              if (matches && obj.current < obj.required) {
                modified = true;
                return { ...obj, current: Math.min(obj.current + amount, obj.required) };
              }
            }
            return obj;
          });

          if (modified) {
            // Check if all objectives are complete
            const allComplete = updatedObjectives.every(obj => obj.current >= obj.required);
            return { ...q, objectives: updatedObjectives, status: allComplete ? 'completed' : 'active' };
          }
          return q;
        }));
      }

      // Check if a quest is complete
      function isQuestComplete(quest) {
        return quest.objectives.every(obj => obj.current >= obj.required);
      }

      // Turn in a completed quest and receive rewards
      function turnInQuest(questId) {
        const quest = quests.find(q => q.id === questId);
        const isComplete = quest?.objectives.every(obj => obj.current >= obj.required);
        if (!quest || !isComplete || quest.status === 'turned_in') return;

        // Give rewards
        setPlayer(prev => {
          const newPlayer = { ...prev };
          const rewards = quest.rewards;

          // Gold reward
          if (rewards.gold) {
            newPlayer.gold = (newPlayer.gold || 0) + rewards.gold;
            setCombatLog(p => [...p, `ğŸ’° Received ${rewards.gold} gold!`]);
          }

          // Wood reward (or any resource)
          if (rewards.wood) {
            newPlayer.inventory = { ...newPlayer.inventory };
            newPlayer.inventory.wood = (newPlayer.inventory.wood || 0) + rewards.wood;
            setCombatLog(p => [...p, `ğŸªµ Received ${rewards.wood} wood!`]);
          }

          // Experience rewards
          if (rewards.exp) {
            newPlayer.skills = { ...newPlayer.skills };
            for (const [skill, xp] of Object.entries(rewards.exp)) {
              if (newPlayer.skills[skill]) {
                newPlayer.skills[skill] = { ...newPlayer.skills[skill] };
                newPlayer.skills[skill].exp += xp;
                while (newPlayer.skills[skill].exp >= newPlayer.skills[skill].expToNext) {
                  newPlayer.skills[skill].exp -= newPlayer.skills[skill].expToNext;
                  newPlayer.skills[skill].level += 1;
                  newPlayer.skills[skill].expToNext = Math.floor(newPlayer.skills[skill].expToNext * 1.5);
                }
                setCombatLog(p => [...p, `âœ¨ Received ${xp} ${skill} XP!`]);
              }
            }
          }

          // Item rewards
          if (rewards.items) {
            newPlayer.inventory = { ...newPlayer.inventory };
            rewards.items.forEach(item => {
              newPlayer.inventory[item.id] = (newPlayer.inventory[item.id] || 0) + item.qty;
              const itemName = ITEMS_DATA[item.id]?.name || item.id;
              setCombatLog(p => [...p, `ğŸ Received ${item.qty}x ${itemName}!`]);
            });
          }

          return newPlayer;
        });

        // Mark quest as turned in
        setQuests(prev => prev.map(q =>
          q.id === questId ? { ...q, status: 'turned_in' } : q
        ));

        setCombatLog(prev => [...prev, `ğŸ† Quest completed: ${quest.name}!`]);
        saveGame("quest_complete");
      }

      // Calculate total combat level from combat skills
      function getCombatLevel() {
        return player.skills.attack.level + player.skills.defense.level + player.skills.health.level + player.skills.strength.level;
      }

      // Check if a familiar slot is unlocked based on combat level
      function isFamiliarSlotUnlocked(slotNum) {
        const combatLevel = getCombatLevel();
        if (slotNum === 1) return combatLevel >= 10;
        if (slotNum === 2) return combatLevel >= 20;
        if (slotNum === 3) return combatLevel >= 30;
        return false;
      }

      // Helper function to get total bonuses from active potions
      function getPotionBonuses() {
        const bonuses = {
          attack_flat: 0,
          attack_percent: 0,
          defense_flat: 0,
          defense_percent: 0,
          damage_reduction: 0,
          max_hp_flat: 0,
          skill_speed_percent: 0,
          skill_xp_percent: 0,
          extra_resources: 0,
          drop_chance_percent: 0,
          afk_extension_ms: 0,
          prevent_interrupts: false
        };

        activePotions.forEach(potion => {
          const effect = potion.effect;
          if (!effect) return;

          if (effect.type === 'combat_flat') {
            if (effect.stat === 'attack') bonuses.attack_flat += effect.value;
            if (effect.stat === 'defense') bonuses.defense_flat += effect.value;
          } else if (effect.type === 'combat_percent') {
            if (effect.stat === 'attack') bonuses.attack_percent += effect.value;
            if (effect.stat === 'defense') bonuses.defense_percent += effect.value;
          } else if (effect.type === 'combat_multi') {
            // Hybrid potions (e.g., battle tonic, berserker draught)
            if (effect.attack) bonuses.attack_flat += effect.attack;
            if (effect.attackPercent) bonuses.attack_percent += effect.attackPercent;
            if (effect.defense) bonuses.defense_flat += effect.defense;
          } else if (effect.type === 'damage_reduction') {
            bonuses.damage_reduction += effect.value;
          } else if (effect.type === 'max_hp') {
            bonuses.max_hp_flat += effect.value;
          } else if (effect.type === 'skill_speed') {
            bonuses.skill_speed_percent += effect.value;
          } else if (effect.type === 'skill_xp') {
            bonuses.skill_xp_percent += effect.value;
          } else if (effect.type === 'extra_resource') {
            bonuses.extra_resources += effect.value;
          } else if (effect.type === 'drop_chance') {
            bonuses.drop_chance_percent += effect.value;
          } else if (effect.type === 'afk_extension') {
            bonuses.afk_extension_ms += effect.value;
          } else if (effect.type === 'prevent_interrupt') {
            bonuses.prevent_interrupts = true;
          }
        });

        return bonuses;
      }

      // Helper function to get effective max HP including potion bonuses
      function getEffectiveMaxHp() {
        const potionBonuses = getPotionBonuses();
        return player.maxHp + potionBonuses.max_hp_flat;
      }

      // Helper function to format potion effect description
      function formatPotionEffect(effect) {
        if (!effect) return "";

        if (effect.type === 'combat_flat') {
          return `+${effect.value} ${effect.stat}`;
        } else if (effect.type === 'combat_percent') {
          return `+${effect.value}% ${effect.stat}`;
        } else if (effect.type === 'combat_multi') {
          const parts = [];
          if (effect.attack) parts.push(`+${effect.attack} attack`);
          if (effect.attackPercent) parts.push(`+${effect.attackPercent}% attack`);
          if (effect.defense) parts.push(`${effect.defense > 0 ? '+' : ''}${effect.defense} defense`);
          return parts.join(', ');
        } else if (effect.type === 'damage_reduction') {
          return `${effect.value}% damage reduction`;
        } else if (effect.type === 'max_hp') {
          return `+${effect.value} max HP`;
        } else if (effect.type === 'skill_speed') {
          return `${effect.value}% faster gathering`;
        } else if (effect.type === 'skill_xp') {
          return `+${effect.value}% XP`;
        } else if (effect.type === 'extra_resource') {
          return `${effect.value}% extra resources`;
        } else if (effect.type === 'drop_chance') {
          return `+${effect.value}% drop chance`;
        } else if (effect.type === 'afk_extension') {
          return `+${Math.floor(effect.value / 60000)}min AFK time`;
        } else if (effect.type === 'prevent_interrupt') {
          return `Prevents interrupts`;
        }
        return "";
      }

      // Helper function to format potion effect for combat UI (compact, abbreviated)
      function formatPotionEffectCompact(effect) {
        if (!effect) return [];

        if (effect.type === 'combat_flat') {
          const stat = effect.stat === 'attack' ? 'ATK' : effect.stat === 'defense' ? 'DEF' : effect.stat.toUpperCase();
          return [`+${effect.value} ${stat}`];
        } else if (effect.type === 'combat_percent') {
          const stat = effect.stat === 'attack' ? 'ATK' : effect.stat === 'defense' ? 'DEF' : effect.stat.toUpperCase();
          return [`+${effect.value}% ${stat}`];
        } else if (effect.type === 'combat_multi') {
          const lines = [];
          if (effect.attack) lines.push(`+${effect.attack} ATK`);
          if (effect.attackPercent) lines.push(`+${effect.attackPercent}% ATK`);
          if (effect.defense) lines.push(`${effect.defense > 0 ? '+' : ''}${effect.defense} DEF`);
          return lines;
        } else if (effect.type === 'damage_reduction') {
          return [`${effect.value}% DMG RED`];
        } else if (effect.type === 'max_hp') {
          return [`+${effect.value} HP`];
        } else if (effect.type === 'skill_speed') {
          return [`${effect.value}% SPEED`];
        } else if (effect.type === 'skill_xp') {
          return [`+${effect.value}% XP`];
        } else if (effect.type === 'extra_resource') {
          return [`${effect.value}% EXTRA`];
        } else if (effect.type === 'drop_chance') {
          return [`+${effect.value}% DROPS`];
        } else if (effect.type === 'afk_extension') {
          return [`+${Math.floor(effect.value / 60000)}m AFK`];
        } else if (effect.type === 'prevent_interrupt') {
          return ['NO INT'];
        }
        return [];
      }

      function calculateStats() {
        const equipmentStats = { attack: 0, defense: 0 };
        Object.entries(player.equipment).forEach(([slot, item]) => {
          if (item && ITEMS_DATA[item]) {
            // Check familiar slot requirements
            if (slot === 'familiar1' && !isFamiliarSlotUnlocked(1)) return;
            if (slot === 'familiar2' && !isFamiliarSlotUnlocked(2)) return;
            if (slot === 'familiar3' && !isFamiliarSlotUnlocked(3)) return;

            if (ITEMS_DATA[item].attack) equipmentStats.attack += ITEMS_DATA[item].attack;
            if (ITEMS_DATA[item].defense) equipmentStats.defense += ITEMS_DATA[item].defense;
          }
        });

        // Get potion bonuses
        const potionBonuses = getPotionBonuses();

        // Scale skill contributions 10x: strength gives +20 per level, attack gives +10 per level
        const baseAttack = player.skills.strength.level * 20 + player.skills.attack.level * 10;
        let totalAttack = Math.max(1, baseAttack + equipmentStats.attack);

        // Apply potion bonuses to attack
        totalAttack += potionBonuses.attack_flat;
        totalAttack = Math.floor(totalAttack * (1 + potionBonuses.attack_percent / 100));

        // Defense: 2% damage reduction per defense level, capped at 50%, plus potion damage reduction
        let damageReduction = Math.min(0.5, 0.02 * player.skills.defense.level);
        damageReduction = Math.min(0.75, damageReduction + potionBonuses.damage_reduction / 100);

        // Apply defense flat bonus
        const totalDefense = equipmentStats.defense + potionBonuses.defense_flat;

        return {
          baseAttack,
          equipmentAttack: equipmentStats.attack,
          totalAttack,
          defenseLevel: player.skills.defense.level,
          damageReductionPct: Math.floor(damageReduction * 100),
          equipmentDefense: totalDefense,
          combatLevel: getCombatLevel(),
          potionBonuses: potionBonuses
        };
      }

      function startCombatTask(enemyData) {
        setActiveSkill(null); skillEndTimeRef.current = null;
        skillEndTimeRef.current = null;
        setActiveResource(null);
        if (respawnTimer.current) clearTimeout(respawnTimer.current);
        if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
        setRespawnCountdown(0);
        setEnemy({ ...enemyData, maxHp: enemyData.hp }); setProgress(0);
        setCombatLog(prev => [...prev, `âš”ï¸ Engaged ${enemyData.name} (Lvl ${enemyData.level})!`]);
        combatStartTime.current = Date.now(); // Start timer for display

        // Clear any existing intervals
        if (autoCombatInterval.current) clearInterval(autoCombatInterval.current);
        if (respawnTimer.current) clearTimeout(respawnTimer.current);

        // Start auto-attack if enabled - every 5 seconds
        if (autoCombatEnabled) {
          autoCombatInterval.current = setInterval(() => {
            if (attackEnemyRef.current) {
              attackEnemyRef.current();
            }
          }, 5000);
        }
      }

      function attackEnemy() {
        if (!enemy) return;

        // Start/reset combat timer
        combatStartTime.current = Date.now();

        const stats = calculateStats();

        // Player attack variance
        const playerPct = PLAYER_ATTACK_MIN_PCT + Math.random() * (PLAYER_ATTACK_MAX_PCT - PLAYER_ATTACK_MIN_PCT);
        const playerHit = Math.max(1, Math.floor(stats.totalAttack * playerPct));

        const newEnemyHp = enemy.hp - playerHit;

        // Log player's hit immediately
        setCombatLog(prev => [...prev, `âš”ï¸ You hit ${enemy.name} for ${playerHit} damage!`]);

        // If enemy died from this hit, handle defeat (enemy does not retaliate)
        if (newEnemyHp <= 0) {
          let inventory = { ...player.inventory };
          let goldDrop = Math.floor(enemy.gold * (0.5 + Math.random()));
          setCombatLog(prev => [...prev, `ğŸ’° You gained ${goldDrop} gold!`, `ğŸ† You gained ${enemy.exp} XP in ${selectedCombatSkill}!`] );

          if (enemy.drops) {
            const droppedItems = [];
            const potionBonuses = getPotionBonuses();
            enemy.drops.forEach(drop => {
              // Apply potion drop chance bonus
              let dropChance = drop.chance;
              if (potionBonuses.drop_chance_percent > 0) {
                dropChance = Math.min(1.0, dropChance * (1 + potionBonuses.drop_chance_percent / 100));
              }
              if (Math.random() < dropChance) {
                const qty = Math.floor(Math.random() * (drop.max - drop.min + 1)) + drop.min;
                inventory[drop.item] = (inventory[drop.item] || 0) + qty;
                droppedItems.push({ id: drop.item, name: ITEMS_DATA[drop.item]?.name || drop.item, qty });
              }
            });
            if (droppedItems.length > 0) {
              setCombatLog(prev => [...prev, { type: 'drop', prefix: 'âœ¨ You found:', items: droppedItems, suffix: '' }]);
            }
          }

          // Apply skill XP and rewards
          setPlayer(prev => {
            // Apply potion XP bonus to combat XP
            const potionBonuses = getPotionBonuses();
            let combatXp = enemy.exp;
            let healthXp = Math.floor(enemy.exp / 3);
            if (potionBonuses.skill_xp_percent > 0) {
              combatXp = Math.floor(combatXp * (1 + potionBonuses.skill_xp_percent / 100));
              healthXp = Math.floor(healthXp * (1 + potionBonuses.skill_xp_percent / 100));
            }
            const combatUpdate = completeSkillCycleWithoutProgress(selectedCombatSkill, prev.skills[selectedCombatSkill], combatXp);

            // If health is the selected combat skill, combine XP instead of overwriting
            if (selectedCombatSkill === "health") {
              const totalHealthXp = combatXp + healthXp;
              const healthUpdate = completeSkillCycleWithoutProgress("health", prev.skills.health, totalHealthXp);
              return {
                ...prev,
                gold: prev.gold + goldDrop,
                skills: { ...prev.skills, health: healthUpdate.skill },
                inventory,
                hp: prev.hp,
                maxHp: prev.maxHp + healthUpdate.maxHpIncrease
              };
            }

            const healthUpdate = completeSkillCycleWithoutProgress("health", prev.skills.health, healthXp);
            return {
              ...prev,
              gold: prev.gold + goldDrop,
              skills: {
                ...prev.skills,
                [selectedCombatSkill]: combatUpdate.skill,
                health: healthUpdate.skill
              },
              inventory,
              hp: prev.hp,
              maxHp: prev.maxHp + combatUpdate.maxHpIncrease + healthUpdate.maxHpIncrease
            };
          });
          saveGame("combat_victory");

          // QUEST PROGRESS - Track enemy kills
          updateQuestProgress('kill', enemy.name, 1);

          // Clear auto-attack interval
          if (autoCombatInterval.current) {
            clearInterval(autoCombatInterval.current);
            autoCombatInterval.current = null;
          }

          setEnemy(null);

          // Auto-respawn logic
          if (autoCombatEnabled) {
            const sameTypeEnemy = currentLocation.enemies.find(e => e.name === enemy.name);
            if (sameTypeEnemy) {
              setCombatLog(prev => [...prev, `â³ Next ${enemy.name} in 20 seconds...`]);
              setRespawnCountdown(20);

              if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
              countdownTimerRef.current = setInterval(() => {
                setRespawnCountdown(prev => {
                  if (prev <= 1) {
                    clearInterval(countdownTimerRef.current);
                    return 0;
                  }
                  return prev - 1;
                });
              }, 1000);

              respawnTimer.current = setTimeout(() => {
                if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
                setRespawnCountdown(0);
                startCombatTask(sameTypeEnemy);
              }, 20000);
            }
          }
          return;
        }

        // Enemy survives and retaliates
        const damageReduction = stats.damageReductionPct / 100;
        const effectiveEquipDef = Math.floor(stats.equipmentDefense * EQUIP_DEFENSE_MULT);
        const enemyPct = ENEMY_ATTACK_MIN_PCT + Math.random() * (ENEMY_ATTACK_MAX_PCT - ENEMY_ATTACK_MIN_PCT);
        const enemyRaw = Math.floor(enemy.attack * enemyPct);
        let enemyDmg = Math.max(1, Math.floor(enemyRaw * (1 - damageReduction)) - effectiveEquipDef);

        const newPlayerHp = player.hp - enemyDmg;

        // Log enemy hit immediately
        setCombatLog(prev => [...prev, `ğŸ”¥ ${enemy.name} hits you for ${enemyDmg} damage!`]);

        if (newPlayerHp <= 0) {
          // Player died from the retaliation
          if (autoCombatInterval.current) {
            clearInterval(autoCombatInterval.current);
            autoCombatInterval.current = null;
          }
          if (respawnTimer.current) {
            clearTimeout(respawnTimer.current);
            respawnTimer.current = null;
          }

          setEnemy(null);
          setPlayer(prev => ({ ...prev, hp: prev.maxHp, location: "starter-village" }));
          setCombatLog(prev => [...prev, `ğŸ’€ You were defeated by ${enemy.name}! Returning to starter village.`]);
          saveGame("player_death");
          return;
        }

        // Both survived this exchange; update HPs
        setEnemy({ ...enemy, hp: newEnemyHp });
        setPlayer({ ...player, hp: newPlayerHp });

        // Auto-eat: consume food if HP drops below threshold during combat
        if (autoEatEnabled && newPlayerHp < (player.maxHp * autoEatThreshold / 100)) {
          const foodItem = ITEMS_DATA[autoEatFood];
          if (foodItem && player.inventory[autoEatFood] > 0 && newPlayerHp < player.maxHp) {
            // Delay slightly so the state update doesn't conflict
            setTimeout(() => useFood(autoEatFood), 50);
          }
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // HOME & FARMING FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Helper: Get total skill level for home tier requirements
      function getTotalLevel() {
        return ALL_SKILLS.reduce((sum, skill) => sum + (player.skills[skill]?.level || 1), 0);
      }

      // Helper: Get home at current location
      function getCurrentHome() {
        return player.homes?.[player.location] || null;
      }

      // Helper: Get home tier configuration
      function getHomeTierConfig(tier) {
        return HOME_TIERS.find(t => t.tier === tier);
      }

      // Helper: Check if player can build a home at specified tier
      function canBuildHome(tier) {
        const config = getHomeTierConfig(tier);
        if (!config) return { canBuild: false, reason: "Invalid tier" };
        const totalLevel = getTotalLevel();
        if (totalLevel < config.totalLevelReq) {
          return { canBuild: false, reason: `Requires total level ${config.totalLevelReq} (you have ${totalLevel})` };
        }
        if ((player.inventory.wood || 0) < config.woodCost) {
          return { canBuild: false, reason: `Requires ${config.woodCost} wood (you have ${player.inventory.wood || 0})` };
        }
        return { canBuild: true };
      }

      // Build a home at current location
      function buildHome(tier) {
        const config = getHomeTierConfig(tier);
        const check = canBuildHome(tier);
        if (!check.canBuild) {
          setCombatLog(prev => [...prev, `Cannot build home: ${check.reason}`]);
          return;
        }
        // Initialize plots array
        const plots = [];
        for (let i = 0; i < config.plots; i++) {
          plots.push({ id: i, seedId: null, plantedAt: null, growthTime: null, ready: false });
        }
        setPlayer(prev => ({
          ...prev,
          inventory: { ...prev.inventory, wood: (prev.inventory.wood || 0) - config.woodCost },
          homes: {
            ...prev.homes,
            [prev.location]: { tier, inventory: {}, inventoryOrder: [], plots }
          }
        }));
        setCombatLog(prev => [...prev, `ğŸ  You built a Tier ${tier} home at ${player.location.replace(/-/g, " ")}!`]);
        saveGame("home_build");
      }

      // Upgrade home at current location
      function upgradeHome() {
        const home = getCurrentHome();
        if (!home) return;
        const nextTier = home.tier + 1;
        if (nextTier > 3) {
          setCombatLog(prev => [...prev, `Home is already at maximum tier!`]);
          return;
        }
        const check = canBuildHome(nextTier);
        if (!check.canBuild) {
          setCombatLog(prev => [...prev, `Cannot upgrade home: ${check.reason}`]);
          return;
        }
        const config = getHomeTierConfig(nextTier);
        const currentConfig = getHomeTierConfig(home.tier);
        // Add additional plots
        const newPlots = [...home.plots];
        for (let i = currentConfig.plots; i < config.plots; i++) {
          newPlots.push({ id: i, seedId: null, plantedAt: null, growthTime: null, ready: false });
        }
        setPlayer(prev => ({
          ...prev,
          inventory: { ...prev.inventory, wood: (prev.inventory.wood || 0) - config.woodCost },
          homes: {
            ...prev.homes,
            [prev.location]: { ...home, tier: nextTier, plots: newPlots }
          }
        }));
        setCombatLog(prev => [...prev, `ğŸ  Upgraded home to Tier ${nextTier}!`]);
        saveGame("home_upgrade");
      }

      // Transfer item from player inventory to home inventory
      function transferToHome(itemId, quantity = 1) {
        const home = getCurrentHome();
        if (!home) return;
        const config = getHomeTierConfig(home.tier);
        const currentSlotCount = Object.keys(home.inventory).filter(k => home.inventory[k] > 0).length;
        const itemExists = (home.inventory[itemId] || 0) > 0;
        // Check slot limit (only if adding new item type)
        if (!itemExists && currentSlotCount >= config.inventorySlots) {
          setCombatLog(prev => [...prev, `Home inventory full! Max ${config.inventorySlots} item types.`]);
          return;
        }
        const available = player.inventory[itemId] || 0;
        const toTransfer = Math.min(quantity, available);
        if (toTransfer <= 0) return;
        setPlayer(prev => {
          const updatedHome = {
            ...home,
            inventory: { ...home.inventory, [itemId]: (home.inventory[itemId] || 0) + toTransfer }
          };
          return {
            ...prev,
            inventory: { ...prev.inventory, [itemId]: (prev.inventory[itemId] || 0) - toTransfer },
            homes: { ...prev.homes, [prev.location]: updatedHome }
          };
        });
        setCombatLog(prev => [...prev, `ğŸ“¦ Stored ${toTransfer}x ${ITEMS_DATA[itemId]?.name || itemId} in home.`]);
        saveGame("home_transfer");
      }

      // Transfer item from home inventory to player inventory
      function transferFromHome(itemId, quantity = 1) {
        const home = getCurrentHome();
        if (!home) return;
        const available = home.inventory[itemId] || 0;
        const toTransfer = Math.min(quantity, available);
        if (toTransfer <= 0) return;
        setPlayer(prev => {
          const newHomeInv = { ...home.inventory, [itemId]: (home.inventory[itemId] || 0) - toTransfer };
          const updatedHome = { ...home, inventory: newHomeInv };
          return {
            ...prev,
            inventory: { ...prev.inventory, [itemId]: (prev.inventory[itemId] || 0) + toTransfer },
            homes: { ...prev.homes, [prev.location]: updatedHome }
          };
        });
        setCombatLog(prev => [...prev, `ğŸ“¦ Retrieved ${toTransfer}x ${ITEMS_DATA[itemId]?.name || itemId} from home.`]);
        saveGame("home_transfer");
      }

      // Plant a seed in a farming plot
      function plantSeed(plotIndex, seedId) {
        const home = getCurrentHome();
        if (!home) return;
        const plot = home.plots[plotIndex];
        if (!plot || plot.seedId) {
          setCombatLog(prev => [...prev, `Plot is already in use!`]);
          return;
        }
        const crop = FARMING_CROPS.find(c => c.seedId === seedId);
        if (!crop) return;
        if (player.skills.farming.level < crop.level) {
          setCombatLog(prev => [...prev, `Requires Farming level ${crop.level}!`]);
          return;
        }
        if ((player.inventory[seedId] || 0) < 1) {
          setCombatLog(prev => [...prev, `You don't have any ${ITEMS_DATA[seedId]?.name || seedId}!`]);
          return;
        }
        const newPlots = [...home.plots];
        newPlots[plotIndex] = {
          ...plot,
          seedId,
          plantedAt: Date.now(),
          growthTime: crop.growthTime,
          ready: false
        };
        setPlayer(prev => ({
          ...prev,
          inventory: { ...prev.inventory, [seedId]: (prev.inventory[seedId] || 0) - 1 },
          homes: { ...prev.homes, [prev.location]: { ...home, plots: newPlots } }
        }));
        setCombatLog(prev => [...prev, `ğŸŒ± Planted ${ITEMS_DATA[seedId]?.name || seedId}!`]);
        setSelectedPlotIndex(null);
        saveGame("farming_plant");
      }

      // Harvest a single crop
      function harvestCrop(plotIndex) {
        const home = getCurrentHome();
        if (!home) return;
        const plot = home.plots[plotIndex];
        if (!plot || !plot.seedId || !plot.ready) {
          setCombatLog(prev => [...prev, `Crop is not ready for harvest!`]);
          return;
        }
        const crop = FARMING_CROPS.find(c => c.seedId === plot.seedId);
        if (!crop) return;
        // Clear the plot
        const newPlots = [...home.plots];
        newPlots[plotIndex] = { id: plot.id, seedId: null, plantedAt: null, growthTime: null, ready: false };
        // Award crop and XP
        setPlayer(prev => {
          const skills = { ...prev.skills };
          const farmingSkill = { ...skills.farming };
          let logLevelUp = [];
          // Add XP
          farmingSkill.exp += crop.xp;
          while (farmingSkill.exp >= farmingSkill.expToNext) {
            farmingSkill.exp -= farmingSkill.expToNext;
            farmingSkill.level += 1;
            farmingSkill.expToNext = Math.floor(farmingSkill.expToNext * 1.5);
            logLevelUp.push(`âœ¨ Farming leveled up to ${farmingSkill.level}!`);
            // QUEST PROGRESS - Track farming level ups
            updateQuestProgress('skill_level', 'farming', 1);
          }
          skills.farming = farmingSkill;
          if (logLevelUp.length) {
            setCombatLog(p => [...p, ...logLevelUp]);
          }
          return {
            ...prev,
            skills,
            inventory: { ...prev.inventory, [crop.cropId]: (prev.inventory[crop.cropId] || 0) + 1 },
            homes: { ...prev.homes, [prev.location]: { ...home, plots: newPlots } }
          };
        });
        setCombatLog(prev => [...prev, { type: 'drop', prefix: 'ğŸŒ¾ Harvested:', items: [{ id: crop.cropId, name: ITEMS_DATA[crop.cropId]?.name || crop.cropId, qty: 1 }], suffix: `(+${crop.xp} Farming XP)` }]);
        saveGame("farming_harvest");
      }

      // Bulk harvest all ready crops
      function harvestAllCrops() {
        const home = getCurrentHome();
        if (!home) return;
        const readyPlots = home.plots.filter(p => p.ready);
        if (readyPlots.length === 0) {
          setCombatLog(prev => [...prev, `No crops ready to harvest!`]);
          return;
        }
        let totalXp = 0;
        const harvestedItems = {};
        const newPlots = home.plots.map(plot => {
          if (plot.ready) {
            const crop = FARMING_CROPS.find(c => c.seedId === plot.seedId);
            if (crop) {
              totalXp += crop.xp;
              harvestedItems[crop.cropId] = (harvestedItems[crop.cropId] || 0) + 1;
            }
            return { id: plot.id, seedId: null, plantedAt: null, growthTime: null, ready: false };
          }
          return plot;
        });
        setPlayer(prev => {
          const skills = { ...prev.skills };
          const farmingSkill = { ...skills.farming };
          let logLevelUp = [];
          farmingSkill.exp += totalXp;
          while (farmingSkill.exp >= farmingSkill.expToNext) {
            farmingSkill.exp -= farmingSkill.expToNext;
            farmingSkill.level += 1;
            farmingSkill.expToNext = Math.floor(farmingSkill.expToNext * 1.5);
            logLevelUp.push(`âœ¨ Farming leveled up to ${farmingSkill.level}!`);
            // QUEST PROGRESS - Track farming level ups
            updateQuestProgress('skill_level', 'farming', 1);
          }
          skills.farming = farmingSkill;
          if (logLevelUp.length) {
            setCombatLog(p => [...p, ...logLevelUp]);
          }
          const newInventory = { ...prev.inventory };
          Object.entries(harvestedItems).forEach(([cropId, qty]) => {
            newInventory[cropId] = (newInventory[cropId] || 0) + qty;
          });
          return {
            ...prev,
            skills,
            inventory: newInventory,
            homes: { ...prev.homes, [prev.location]: { ...home, plots: newPlots } }
          };
        });
        const harvestDropItems = Object.entries(harvestedItems).map(([id, qty]) => ({
          id,
          name: ITEMS_DATA[id]?.name || id,
          qty
        }));
        setCombatLog(prev => [...prev, { type: 'drop', prefix: 'ğŸŒ¾ Harvested:', items: harvestDropItems, suffix: `(+${totalXp} Farming XP)` }]);
        saveGame("farming_harvest");
      }

      // Bulk plant all seeds of a specific type into empty plots
      function plantAllSeeds(seedId) {
        const home = getCurrentHome();
        if (!home) return;
        const crop = FARMING_CROPS.find(c => c.seedId === seedId);
        if (!crop) return;
        if (player.skills.farming.level < crop.level) {
          setCombatLog(prev => [...prev, `Requires Farming level ${crop.level}!`]);
          return;
        }
        const seedCount = player.inventory[seedId] || 0;
        if (seedCount < 1) {
          setCombatLog(prev => [...prev, `You don't have any ${ITEMS_DATA[seedId]?.name || seedId}!`]);
          return;
        }
        // Find empty plots
        const emptyPlotIndices = home.plots
          .map((plot, idx) => (!plot.seedId ? idx : null))
          .filter(idx => idx !== null);
        if (emptyPlotIndices.length === 0) {
          setCombatLog(prev => [...prev, `No empty plots available!`]);
          return;
        }
        // Plant as many as we can (min of seeds owned and empty plots)
        const plantsToMake = Math.min(seedCount, emptyPlotIndices.length);
        const newPlots = [...home.plots];
        for (let i = 0; i < plantsToMake; i++) {
          const plotIndex = emptyPlotIndices[i];
          newPlots[plotIndex] = {
            ...newPlots[plotIndex],
            seedId,
            plantedAt: Date.now(),
            growthTime: crop.growthTime,
            ready: false
          };
        }
        setPlayer(prev => ({
          ...prev,
          inventory: { ...prev.inventory, [seedId]: (prev.inventory[seedId] || 0) - plantsToMake },
          homes: { ...prev.homes, [prev.location]: { ...home, plots: newPlots } }
        }));
        setCombatLog(prev => [...prev, `ğŸŒ± Planted ${plantsToMake}x ${ITEMS_DATA[seedId]?.name || seedId}!`]);
        setSelectedPlotIndex(null);
        saveGame("farming_plant");
      }

      function useFood(foodId) {
        const foodItem = ITEMS_DATA[foodId];
        if (player.inventory[foodId] > 0 && player.hp < player.maxHp) {
          setPlayer(prev => ({
            ...prev,
            hp: Math.min(prev.maxHp, prev.hp + foodItem.heal),
            inventory: { ...prev.inventory, [foodId]: prev.inventory[foodId] - 1 }
          }));
          setCombatLog(prev => [...prev, `ğŸ– Ate ${foodItem.name || foodId}. Healed ${foodItem.heal} HP.`]);
          saveGame("food_eat");
        }
      }

      function usePotion(potionId) {
        // Find the potion recipe to get its effect
        const potionRecipe = POTION_RECIPES.find(r => r.name === potionId);
        if (!potionRecipe || player.inventory[potionId] <= 0) return;

        const potionItem = ITEMS_DATA[potionId];

        // Check if it's a healing potion (has type: "healing")
        if (potionRecipe.type === "healing") {
          // Healing potions work like food
          if (player.hp < player.maxHp) {
            setPlayer(prev => ({
              ...prev,
              hp: Math.min(prev.maxHp, prev.hp + potionItem.heal),
              inventory: { ...prev.inventory, [potionId]: prev.inventory[potionId] - 1 }
            }));
            setCombatLog(prev => [...prev, `ğŸ§ª Drank ${potionItem.name || potionId}. Healed ${potionItem.heal} HP.`]);
            saveGame("potion_use");
          }
        } else if (potionRecipe.type === "buff") {
          // Buff potions add to activePotions (remove any existing potion in same category first)
          setPlayer(prev => ({
            ...prev,
            inventory: { ...prev.inventory, [potionId]: prev.inventory[potionId] - 1 }
          }));

          setActivePotions(prev => {
            // Remove any existing potion in the same category
            const filtered = prev.filter(p => p.category !== potionRecipe.category);

            // Add new potion
            const newPotion = {
              potionId: potionId,
              category: potionRecipe.category,
              startedAt: Date.now(),
              durationMs: potionRecipe.duration,
              effect: potionRecipe.effect
            };

            return [...filtered, newPotion];
          });

          const durationMinutes = Math.floor(potionRecipe.duration / 60000);
          const durationSeconds = Math.floor((potionRecipe.duration % 60000) / 1000);
          const durationStr = durationMinutes > 0 ? `${durationMinutes}m ${durationSeconds}s` : `${durationSeconds}s`;
          setCombatLog(prev => [...prev, `ğŸ§ª Drank ${potionItem.name || potionId}. Effect active for ${durationStr}.`]);
          saveGame("potion_use");
        }
      }

      function openChest(chestId) {
        const chestDef = CHEST_DEFINITIONS[chestId];
        if (!chestDef || !player.inventory[chestId] || player.inventory[chestId] < 1) return;

        // Remove the chest from inventory
        setPlayer(prev => {
          const newInventory = { ...prev.inventory };
          newInventory[chestId] = (newInventory[chestId] || 1) - 1;
          if (newInventory[chestId] <= 0) delete newInventory[chestId];

          // Calculate how many items to reward
          const itemCount = Math.floor(Math.random() * (chestDef.maxItems - chestDef.minItems + 1)) + chestDef.minItems;

          // Calculate total weight for weighted random
          const totalWeight = chestDef.loot.reduce((sum, item) => sum + item.weight, 0);

          // Roll loot items
          const rewards = [];
          for (let i = 0; i < itemCount; i++) {
            let roll = Math.random() * totalWeight;
            for (const lootEntry of chestDef.loot) {
              roll -= lootEntry.weight;
              if (roll <= 0) {
                const qty = Math.floor(Math.random() * (lootEntry.max - lootEntry.min + 1)) + lootEntry.min;
                newInventory[lootEntry.item] = (newInventory[lootEntry.item] || 0) + qty;
                rewards.push({ item: lootEntry.item, qty });
                break;
              }
            }
          }

          // Log the chest opening
          const chestName = chestDef.name;
          const rewardItems = rewards.map(r => ({
            id: r.item,
            name: ITEMS_DATA[r.item]?.name || r.item,
            qty: r.qty
          }));

          setCombatLog(prev => [...prev, { type: 'drop', prefix: `ğŸ Opened ${chestName}! Received:`, items: rewardItems, suffix: '' }]);

          return { ...prev, inventory: newInventory };
        });
        saveGame("chest_open");
      }

      function cookItem(recipe) {
        if (player.skills.cooking.level < recipe.level) {
          setCombatLog(prev => [...prev, `âŒ Need Cooking Level ${recipe.level}`]);
          return;
        }
        if (player.inventory[recipe.raw] > 0 && player.inventory.wood > 0) {
          // Start a repeating cooking task: each 5s tick will consume resources and produce the cooked item.
          setCombatLog(prev => [...prev, `ğŸ”¥ Started cooking ${ITEMS_DATA[recipe.raw].name || recipe.raw} (auto)...`]);
          startTraining("cooking", { ...recipe, resourceName: ITEMS_DATA[recipe.raw]?.name || recipe.raw });
        } else {
          setCombatLog(prev => [...prev, `âŒ Need Wood + Raw ${ITEMS_DATA[recipe.raw].name || recipe.raw}`]);
        }
      }

      function craftPotion(recipe) {
        if (player.skills.herblore.level < recipe.level) {
          setCombatLog(prev => [...prev, `âŒ Need Herblore Level ${recipe.level}`]);
          return;
        }

        // Check if player has all required ingredients
        const recipeCost = recipe.cost || {};
        let canCraft = true;
        let missingIngredients = [];
        for (const [ingredientKey, requiredQty] of Object.entries(recipeCost)) {
          if ((player.inventory[ingredientKey] || 0) < requiredQty) {
            canCraft = false;
            missingIngredients.push(ITEMS_DATA[ingredientKey]?.name || ingredientKey);
          }
        }

        if (canCraft) {
          // Start a repeating crafting task: each tick will consume ingredients and produce the potion
          const potionName = ITEMS_DATA[recipe.name]?.name || recipe.name;
          setCombatLog(prev => [...prev, `ğŸ§ª Started crafting ${potionName} (auto)...`]);
          startTraining("herblore", { ...recipe, resourceName: potionName });
        } else {
          setCombatLog(prev => [...prev, `âŒ Need ingredients: ${missingIngredients.join(', ')}`]);
        }
      }

      // INVENTORY DRAG & DROP - Get items in display order
      function getOrderedInventoryItems() {
        const activeItems = Object.entries(player.inventory)
          .filter(([key, value]) => value > 0)
          .map(([key]) => key);

        // Start with items that are in inventoryOrder (in that order)
        const ordered = (player.inventoryOrder || []).filter(id => activeItems.includes(id));

        // Append any new items not yet in order
        activeItems.forEach(id => {
          if (!ordered.includes(id)) {
            ordered.push(id);
          }
        });

        return ordered;
      }

      // INVENTORY DRAG & DROP - Drag handlers
      function handleInventoryDragStart(e, itemId) {
        setDraggedItem(itemId);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', itemId);
      }

      function handleInventoryDragOver(e, itemId) {
        e.preventDefault();
        if (itemId !== draggedItem) {
          setDragOverItem(itemId);
        }
      }

      function handleInventoryDragLeave(e) {
        setDragOverItem(null);
      }

      function handleInventoryDrop(e, targetItemId) {
        e.preventDefault();
        if (!draggedItem || draggedItem === targetItemId) {
          setDraggedItem(null);
          setDragOverItem(null);
          return;
        }

        // Get current order
        const currentOrder = getOrderedInventoryItems();
        const dragIndex = currentOrder.indexOf(draggedItem);
        const dropIndex = currentOrder.indexOf(targetItemId);

        if (dragIndex === -1 || dropIndex === -1) {
          setDraggedItem(null);
          setDragOverItem(null);
          return;
        }

        // Swap positions
        const newOrder = [...currentOrder];
        newOrder[dragIndex] = targetItemId;
        newOrder[dropIndex] = draggedItem;

        // Update player state with new order
        setPlayer(prev => ({ ...prev, inventoryOrder: newOrder }));

        setDraggedItem(null);
        setDragOverItem(null);
      }

      function handleInventoryDragEnd(e) {
        setDraggedItem(null);
        setDragOverItem(null);
      }

      // HOME INVENTORY DRAG & DROP - Get home items in display order
      function getOrderedHomeInventoryItems(home) {
        if (!home || !home.inventory) return [];
        const activeItems = Object.entries(home.inventory)
          .filter(([key, value]) => value > 0)
          .map(([key]) => key);

        // Start with items that are in inventoryOrder (in that order)
        const ordered = (home.inventoryOrder || []).filter(id => activeItems.includes(id));

        // Append any new items not yet in order
        activeItems.forEach(id => {
          if (!ordered.includes(id)) {
            ordered.push(id);
          }
        });

        return ordered;
      }

      // HOME INVENTORY DRAG & DROP - Drag handlers
      function handleHomeDragStart(e, itemId) {
        setDraggedHomeItem(itemId);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', itemId);
      }

      function handleHomeDragOver(e, itemId) {
        e.preventDefault();
        if (itemId !== draggedHomeItem) {
          setDragOverHomeItem(itemId);
        }
      }

      function handleHomeDragLeave(e) {
        setDragOverHomeItem(null);
      }

      function handleHomeDrop(e, targetItemId) {
        e.preventDefault();
        if (!draggedHomeItem || draggedHomeItem === targetItemId) {
          setDraggedHomeItem(null);
          setDragOverHomeItem(null);
          return;
        }

        const home = getCurrentHome();
        if (!home) {
          setDraggedHomeItem(null);
          setDragOverHomeItem(null);
          return;
        }

        // Get current order
        const currentOrder = getOrderedHomeInventoryItems(home);
        const dragIndex = currentOrder.indexOf(draggedHomeItem);
        const dropIndex = currentOrder.indexOf(targetItemId);

        if (dragIndex === -1 || dropIndex === -1) {
          setDraggedHomeItem(null);
          setDragOverHomeItem(null);
          return;
        }

        // Swap positions
        const newOrder = [...currentOrder];
        newOrder[dragIndex] = targetItemId;
        newOrder[dropIndex] = draggedHomeItem;

        // Update player state with new home inventory order
        setPlayer(prev => ({
          ...prev,
          homes: {
            ...prev.homes,
            [prev.location]: {
              ...prev.homes[prev.location],
              inventoryOrder: newOrder
            }
          }
        }));

        setDraggedHomeItem(null);
        setDragOverHomeItem(null);
      }

      function handleHomeDragEnd(e) {
        setDraggedHomeItem(null);
        setDragOverHomeItem(null);
      }

      function equipItem(itemName) {
        const itemData = ITEMS_DATA[itemName.toLowerCase()] || ITEMS_DATA[itemName];
        if (!itemData || !itemData.slot) return;

        let slot = itemData.slot;
        
        // Handle familiar slot assignment
        if (slot === "familiar") {
          const combatLevel = player.skills.attack.level + player.skills.defense.level + player.skills.health.level + player.skills.strength.level;
          // Find first available unlocked familiar slot
          if (combatLevel >= 10 && !player.equipment.familiar1) {
            slot = "familiar1";
          } else if (combatLevel >= 20 && !player.equipment.familiar2) {
            slot = "familiar2";
          } else if (combatLevel >= 30 && !player.equipment.familiar3) {
            slot = "familiar3";
          } else if (combatLevel >= 10 && player.equipment.familiar1) {
            slot = "familiar1"; // Replace first slot if all are full
          } else {
            setCombatLog(prev => [...prev, `âŒ No familiar slots unlocked! Need Combat Lvl 10 (current: ${combatLevel})`]);
            return;
          }
        }
        
        setPlayer(prev => {
          // Requirement Check
          if (itemData.reqAtk && prev.skills.attack.level < itemData.reqAtk) {
            setCombatLog(prev => [...prev, `âŒ Requires Attack Level ${itemData.reqAtk}`]);
            return prev;
          }
          if (itemData.reqDef && prev.skills.defense.level < itemData.reqDef) {
            setCombatLog(prev => [...prev, `âŒ Requires Defense Level ${itemData.reqDef}`]);
            return prev;
          }
          if (itemData.reqSkill) {
            const skillName = Object.keys(itemData.reqSkill)[0];
            const reqLevel = itemData.reqSkill[skillName];
            if (prev.skills[skillName].level < reqLevel) {
              // Allow equipping tools even if skill requirement not met, but warn the player
              if (itemData.slot === 'tool') {
                setCombatLog(prev => [...prev, `âš ï¸ Equipped ${itemData.name || itemName}, but requires ${skillName.charAt(0).toUpperCase() + skillName.slice(1)} Level ${reqLevel} for full effect.`]);
              } else {
                setCombatLog(prev => [...prev, `âŒ Requires ${skillName.charAt(0).toUpperCase() + skillName.slice(1)} Level ${reqLevel}`]);
                return prev;
              }
            }
          }

          const newInventory = { ...prev.inventory };
          const newEquipment = { ...prev.equipment };

          // Remove 1 from inventory
          if (!newInventory[itemName] || newInventory[itemName] < 1) return prev;
          newInventory[itemName]--;

          // If slot has item, unequip it first (swap)
          if (newEquipment[slot]) {
            const unequipped = newEquipment[slot];
            newInventory[unequipped] = (newInventory[unequipped] || 0) + 1;
          }

          newEquipment[slot] = itemName;
          return { ...prev, inventory: newInventory, equipment: newEquipment };
        });
        saveGame("equip_change");
      }

      function unequipItem(slot) {
        setPlayer(prev => {
          const item = prev.equipment[slot];
          if (!item) return prev;

          const newEquipment = { ...prev.equipment };
          newEquipment[slot] = null;

          const newInventory = { ...prev.inventory };
          newInventory[item] = (newInventory[item] || 0) + 1;

          return { ...prev, inventory: newInventory, equipment: newEquipment };
        });
        saveGame("equip_change");
      }

      function buyItem(itemName) {
        const item = ITEMS_DATA[itemName];
        const cost = item ? item.value * shopQuantity : 0;
        if (!item || player.gold < cost) return;
        setPlayer(prev => ({
          ...prev,
          gold: prev.gold - cost,
          inventory: { ...prev.inventory, [itemName]: (prev.inventory[itemName] || 0) + shopQuantity }
        }));
        saveGame("shop_transaction");
      }

      function sellItem(itemName) {
        const item = ITEMS_DATA[itemName];
        if (!item || !player.inventory[itemName] || player.inventory[itemName] < 1) return;

        const amountToSell = Math.min(player.inventory[itemName], shopQuantity);
        const sellPrice = Math.floor(item.value / 2) * amountToSell;

        setPlayer(prev => ({
          ...prev,
          gold: prev.gold + sellPrice,
          inventory: { ...prev.inventory, [itemName]: prev.inventory[itemName] - amountToSell }
        }));
        saveGame("shop_transaction");
      }

      function craftItem(recipe) {
        // Check requirements
        if (player.skills.smithing.level < recipe.level) {
          setCombatLog(prev => [...prev, `âŒ Need Smithing Level ${recipe.level}`]);
          return;
        }
        const costKeys = Object.keys(recipe.cost);
        for (let key of costKeys) {
          if ((player.inventory[key] || 0) < recipe.cost[key]) {
            setCombatLog(prev => [...prev, `âŒ Not enough ${key}`]);
            return;
          }
        }

        setPlayer(prev => {
          const newInventory = { ...prev.inventory };
          costKeys.forEach(key => {
            newInventory[key] -= recipe.cost[key];
          });
          newInventory[recipe.name] = (newInventory[recipe.name] || 0) + 1;

          const smithingUpdate = completeSkillCycleWithoutProgress("smithing", prev.skills.smithing, recipe.xp);

          return { ...prev, inventory: newInventory, skills: { ...prev.skills, smithing: smithingUpdate.skill } };
        });
        const craftedName = ITEMS_DATA[recipe.name]?.name || recipe.name;
        setCombatLog(prev => [...prev, { type: 'drop', prefix: 'ğŸ”¨ Crafted:', items: [{ id: recipe.name, name: craftedName, qty: 1 }], suffix: `(+${recipe.xp} Smithing XP)` }]);
        saveGame("craft_item");
      }

      const equipmentStats = calculateStats();

      /* ============================================
         REUSABLE UI COMPONENTS
         ============================================ */
      
      // Progress bar component
      const ProgressBar = ({ progress, color = "bg-amber-500", label, sublabel, height = "h-1.5" }) => (
        <div className="w-full">
          {(label || sublabel) && (
            <div className="flex justify-between text-[10px] mb-1">
              <span className="text-gray-300">{label}</span>
              <span className="text-gray-500 font-mono">{sublabel}</span>
            </div>
          )}
          <div className={`stat-bar ${height}`}>
            <div className={`stat-fill ${color}`} style={{ width: `${progress}%` }} />
          </div>
        </div>
      );

      /* ============================================
         LOGIN SCREEN COMPONENT
         ============================================ */
      const renderLoginScreen = () => (
        <div className="fixed inset-0 bg-[#1a1a1f] flex items-center justify-center z-50">
          <div className="panel p-8 max-w-md w-full mx-4">
            <div className="text-center mb-6">
              <h1 className="text-2xl font-bold text-[#d4a84b] mb-2">Realm of Eternity</h1>
              <p className="text-gray-400 text-sm">
                {authView === "login" ? "Sign in to your account" : "Create a new account"}
              </p>
            </div>

            {authError && (
              <div className="bg-red-900/30 border border-red-700 text-red-300 px-3 py-2 rounded mb-4 text-sm">
                {authError}
              </div>
            )}

            <div className="space-y-4">
              {authView === "register" && (
                <div>
                  <label className="block text-gray-400 text-xs mb-1">Display Name</label>
                  <input
                    type="text"
                    value={registerDisplayName}
                    onChange={e => setRegisterDisplayName(e.target.value)}
                    className="w-full bg-[#1a1a1f] border border-[#333] rounded px-3 py-2 text-gray-200 focus:border-[#d4a84b] focus:outline-none"
                    placeholder="Your character name"
                  />
                </div>
              )}
              <div>
                <label className="block text-gray-400 text-xs mb-1">Email</label>
                <input
                  type="email"
                  value={loginEmail}
                  onChange={e => setLoginEmail(e.target.value)}
                  className="w-full bg-[#1a1a1f] border border-[#333] rounded px-3 py-2 text-gray-200 focus:border-[#d4a84b] focus:outline-none"
                  placeholder="email@example.com"
                />
              </div>
              <div>
                <label className="block text-gray-400 text-xs mb-1">Password</label>
                <input
                  type="password"
                  value={loginPassword}
                  onChange={e => setLoginPassword(e.target.value)}
                  className="w-full bg-[#1a1a1f] border border-[#333] rounded px-3 py-2 text-gray-200 focus:border-[#d4a84b] focus:outline-none"
                  placeholder="********"
                />
              </div>
            </div>

            <div className="mt-6 space-y-3">
              {authView === "login" ? (
                <button
                  onClick={() => handleLogin(loginEmail, loginPassword)}
                  className="w-full bg-gradient-to-b from-[#d4a84b] to-[#a07830] text-black font-bold py-2 rounded hover:from-[#f0c060] hover:to-[#d4a84b] transition-all"
                >
                  Sign In
                </button>
              ) : (
                <button
                  onClick={() => handleRegister(loginEmail, loginPassword, registerDisplayName)}
                  className="w-full bg-gradient-to-b from-[#d4a84b] to-[#a07830] text-black font-bold py-2 rounded hover:from-[#f0c060] hover:to-[#d4a84b] transition-all"
                >
                  Create Account
                </button>
              )}

              <button
                onClick={skipLogin}
                className="w-full bg-[#2a2a32] text-gray-300 py-2 rounded hover:bg-[#353540] transition-all border border-[#333]"
              >
                Play Offline
              </button>
            </div>

            <div className="mt-4 text-center">
              {authView === "login" ? (
                <button
                  onClick={() => { setAuthView("register"); setAuthError(null); }}
                  className="text-[#d4a84b] text-sm hover:underline"
                >
                  Don't have an account? Register
                </button>
              ) : (
                <button
                  onClick={() => { setAuthView("login"); setAuthError(null); }}
                  className="text-[#d4a84b] text-sm hover:underline"
                >
                  Already have an account? Sign In
                </button>
              )}
            </div>
          </div>
        </div>
      );

      /* ============================================
         PLAYERS HERE PANEL - Shows other players at location
         ============================================ */
      const renderPlayersHere = () => {
        if (!isAuthenticated || playersHere.length === 0) return null;

        return (
          <div className="panel mb-3 p-3">
            <div className="text-[11px] text-gray-400 font-bold mb-2 uppercase tracking-wide">
              Players Here ({playersHere.length})
            </div>
            <div className="space-y-1 max-h-32 overflow-y-auto">
              {playersHere.map((p, i) => (
                <div key={p.playerId || i} className="flex items-center justify-between text-[10px]">
                  <span className="flex items-center gap-1">
                    <span className={`w-2 h-2 rounded-full ${p.online ? 'bg-green-500' : 'bg-gray-500'}`} />
                    <span className="text-gray-300">{p.displayName}</span>
                    <span className="text-gray-500">(Lvl {p.totalLevel})</span>
                  </span>
                  <span className="text-gray-500 italic">{p.activity}</span>
                </div>
              ))}
            </div>
          </div>
        );
      };

      /* ============================================
         SCENE IMAGE PANEL - Visual state indicator
         Shows: Idle, Traveling, Combat, Skilling scenes
         Supports custom background images from SCENE_IMAGES config
         ============================================ */
      const [sceneImgError, setSceneImgError] = React.useState({});
      
      const renderScenePanel = () => {
        // Determine current scene state and image
        const getSceneContent = () => {
          // TRAVELING STATE - Always use default traveling image
          if (isTraveling && travelDestination.current) {
            const remaining = Math.max(0, Math.ceil((TRAVEL_DURATION - (Date.now() - travelStartTime.current)) / 1000));
            const dest = travelDestination.current;
            return {
              icon: "ğŸš¶",
              title: `Traveling to ${dest.replace(/-/g, " ")}`,
              gradient: "from-indigo-900/60 via-purple-900/50 to-blue-900/60",
              borderColor: "border-indigo-500/30",
              showProgress: true,
              progressLabel: `${remaining}s remaining`,
              progressValue: travelProgress,
              image: SCENE_IMAGES.traveling["default"],
              imageKey: "travel-default"
            };
          }
          // COMBAT STATE
          if (enemy) {
            // Try enemy-specific image, then default combat image
            const imagePath = SCENE_IMAGES.combat[enemy.name] || SCENE_IMAGES.combat["default"];
            return {
              icon: enemy.icon,
              title: `Fighting ${enemy.name}`,
              subtitle: `Level ${enemy.level}`,
              gradient: "from-red-900/60 via-orange-900/50 to-red-900/60",
              borderColor: "border-red-500/30",
              image: imagePath,
              imageKey: `combat-${enemy.name}`
            };
          }
          // SKILLING STATE
          if (activeSkill) {
            const skillIcons = {
              mining: "â›ï¸", woodcutting: "ğŸª“", fishing: "ğŸ£", cooking: "ğŸ”¥", smithing: "ğŸ”¨",
              herblore: "ğŸ§ª", farming: "ğŸŒ¾",
              attack: "âš”ï¸", defense: "ğŸ›¡ï¸", strength: "ğŸ’ª", health: "â¤ï¸"
            };
            const imagePath = SCENE_IMAGES.skilling[activeSkill];
            return {
              icon: skillIcons[activeSkill] || "ğŸ”¨",
              title: `Training ${activeSkill.charAt(0).toUpperCase() + activeSkill.slice(1)}`,
              subtitle: activeResource ? (activeResource.resourceName || getItemName(activeResource.id)) : null,
              gradient: "from-green-900/60 via-emerald-900/50 to-green-900/60",
              borderColor: "border-green-500/30",
              image: imagePath,
              imageKey: `skill-${activeSkill}`
            };
          }
          // IDLE STATE - Location image
          const imagePath = SCENE_IMAGES.locations[player.location];
          return {
            icon: "ğŸ ",
            title: `${player.location.replace(/-/g, " ")}`,
            subtitle: "Select an activity below",
            gradient: "from-gray-800/60 via-gray-900/50 to-gray-800/60",
            borderColor: "border-gray-600/30",
            image: imagePath,
            imageKey: `location-${player.location}`
          };
        };

        const scene = getSceneContent();
        const hasValidImage = scene.image && !sceneImgError[scene.imageKey];

        return (
          <div className="panel mb-3 overflow-hidden">
            {/* SCENE IMAGE CENTERING FIX - Square aspect ratio container with flex centering */}
            <div 
              className={`scene-panel rounded-lg border ${scene.borderColor}`}
              style={{ 
                boxShadow: 'inset 0 2px 12px rgba(0,0,0,0.6)',
                maxHeight: '500px',
                minHeight: '350px'
              }}
            >
              {/* SCENE IMAGE CENTERING FIX - Image container with flex centering */}
              {hasValidImage && (
                <div className="scene-image-container">
                  <img 
                    src={scene.image}
                    alt={scene.title}
                    className="scene-image"
                    style={{ filter: 'brightness(0.85) saturate(1.1)' }}
                    onError={() => setSceneImgError(prev => ({ ...prev, [scene.imageKey]: true }))}
                  />
                </div>
              )}
              
              {/* Gradient Overlay - Only when no image */}
              {!hasValidImage && (
                <div 
                  className={`absolute inset-0 bg-gradient-to-b ${scene.gradient}`}
                />
              )}
              
              {/* Bottom gradient for text readability */}
              <div 
                className="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-black/80 via-black/40 to-transparent pointer-events-none"
              />
              
              {/* Vignette Effect */}
              <div 
                className="absolute inset-0 pointer-events-none"
                style={{ boxShadow: 'inset 0 0 80px rgba(0,0,0,0.4)' }}
              />
              
              {/* Grid Pattern Overlay (only when no image) */}
              {!hasValidImage && (
                <div 
                  className="absolute inset-0 opacity-5" 
                  style={{ 
                    backgroundImage: 'url("data:image/svg+xml,%3Csvg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M0 0h20v20H0z\" fill=\"none\"/%3E%3Cpath d=\"M10 0v20M0 10h20\" stroke=\"%23fff\" stroke-width=\"0.5\"/%3E%3C/svg%3E")', 
                    backgroundSize: '20px 20px' 
                  }} 
                />
              )}
              
              {/* Fallback Icon - Only shown when no image */}
              {!hasValidImage && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <div 
                    className="text-8xl opacity-30"
                    style={{ textShadow: '0 4px 16px rgba(0,0,0,0.5)' }}
                  >
                    {scene.icon}
                  </div>
                </div>
              )}
              
              {/* Content Layer - Bottom aligned */}
              <div className="relative z-10 w-full p-4 text-center">
                {/* Scene Title */}
                <div 
                  className="text-lg font-bold text-white uppercase tracking-wider"
                  style={{ textShadow: '0 2px 6px rgba(0,0,0,0.9)' }}
                >
                  {scene.title}
                </div>
                
                {/* Scene Subtitle */}
                {scene.subtitle && (
                  <div 
                    className="text-[12px] text-gray-300 mt-1"
                    style={{ textShadow: '0 1px 3px rgba(0,0,0,0.9)' }}
                  >
                    {scene.subtitle}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      /* ============================================
         TOP BAR - MAP / LOCATION NAVIGATION
         Always visible, shows all destinations
         ============================================ */
      const renderTopBar = () => (
        <header className="top-bar">
          <div className="flex items-center justify-between gap-4 max-w-[1600px] mx-auto">
            {/* Current Location */}
            <div className="flex items-center gap-2 shrink-0">
              <span className="text-[10px] text-gray-500 uppercase font-bold">Location:</span>
              <span className="text-sm font-bold text-amber-400 capitalize">{player.location.replace(/-/g, " ")}</span>
            </div>
            
            {/* Destination Buttons - TRAVEL TIMER: Uses startTravel instead of instant location change */}
            <nav className="flex flex-wrap gap-1.5 justify-center flex-1">
              {Object.keys(locations).map(loc => (
                <button 
                  key={loc} 
                  onClick={() => startTravel(loc)}
                  disabled={isTraveling}
                  className={`px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-tight transition-all ${
                    player.location === loc 
                      ? 'bg-amber-500/90 text-black' 
                      : isTraveling 
                        ? 'bg-[#1a1a1e] text-gray-600 border border-[#2a2a30] cursor-not-allowed'
                        : travelDestination.current === loc
                          ? 'bg-indigo-500/50 text-indigo-200 border border-indigo-500/50'
                          : 'bg-[#2a2a30] hover:bg-[#35353c] text-gray-400 border border-[#3a3a42]'
                  }`}
                >
                  {loc.replace(/-/g, " ")}
                </button>
              ))}
            </nav>

            {/* Gold Display */}
            <div className="flex items-center gap-1.5 px-2.5 py-1 bg-[#2a2a30] border border-[#3a3a42] rounded shrink-0">
              <span className="text-amber-400">ğŸ’°</span>
              <span className="text-sm font-bold text-amber-300">{player.gold}</span>
            </div>

            {/* Account Status */}
            <div className="flex items-center gap-2 shrink-0">
              {isAuthenticated ? (
                <>
                  <span className="text-[10px] text-green-400 font-bold">{user?.displayName || "Online"}</span>
                  <button
                    onClick={handleLogout}
                    className="px-2 py-1 text-[9px] font-bold uppercase bg-[#2a2a30] hover:bg-[#35353c] text-gray-400 border border-[#3a3a42] rounded"
                  >
                    Logout
                  </button>
                </>
              ) : (
                <>
                  <span className="text-[10px] text-gray-500 font-bold">Offline</span>
                  <button
                    onClick={() => { localStorage.removeItem("playingOffline"); setPlayingOffline(false); setAuthLoading(false); }}
                    className="px-2 py-1 text-[9px] font-bold uppercase bg-[#d4a84b] hover:bg-[#f0c060] text-black rounded"
                  >
                    Login
                  </button>
                </>
              )}
            </div>
          </div>
        </header>
      );

      /* ============================================
         LEFT COLUMN - PLAYER PANEL
         Contains: HP, Stats, Skills, Equipment
         ============================================ */
      const renderPlayerPanel = () => (
        <div className="space-y-3">
          <div className="mobile-side-by-side">
          {/* Adventurer Panel with Info/Map Toggle */}
          <div className="panel">
            {/* Toggle Header */}
            <div className="panel-header flex items-center justify-between">
              <span className="text-[10px] font-bold text-gray-400 uppercase">Adventurer</span>
              <div className="flex gap-1">
                {['info', 'map'].map(view => (
                  <button
                    key={view}
                    onClick={() => setAdventurerView(view)}
                    className={`px-3 py-1 rounded text-[11px] font-bold uppercase ${
                      adventurerView === view
                        ? 'bg-amber-600/80 text-black'
                        : 'bg-[#2a2a30] text-gray-500 hover:text-gray-300'
                    }`}
                  >
                    {view === 'info' ? 'ğŸ‘¤ Info' : 'ğŸ—ºï¸ Map'}
                  </button>
                ))}
              </div>
            </div>

            <div className="panel-body">
              {/* INFO VIEW - Player Stats */}
              {adventurerView === 'info' && (
                <>
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded bg-[#2a2a30] border border-[#3a3a42] flex items-center justify-center text-xl">ğŸ‘¤</div>
                    <div>
                      <h2 className="font-bold text-base text-gray-100 font-heading">{user?.displayName || "Adventurer"}</h2>
                      <div className="text-[9px] text-gray-500 uppercase font-bold">Combat Lvl {equipmentStats.combatLevel}</div>
                    </div>
                  </div>

                  {/* Location, Gold, Online Status Row */}
                  <div className="grid grid-cols-3 gap-2 mb-3 text-[10px]">
                    <div className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30] text-center">
                      <div className="text-gray-500 text-[8px] uppercase mb-0.5">Location</div>
                      <div className="font-bold text-indigo-400 capitalize truncate" title={player.location.replace(/-/g, " ")}>
                        ğŸ“ {player.location.replace(/-/g, " ")}
                      </div>
                    </div>
                    <div className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30] text-center">
                      <div className="text-gray-500 text-[8px] uppercase mb-0.5">Gold</div>
                      <div className="font-bold text-amber-400">ğŸ’° {player.gold.toLocaleString()}</div>
                    </div>
                    <div className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30] text-center">
                      <div className="text-gray-500 text-[8px] uppercase mb-0.5">Status</div>
                      <div className={`font-bold ${user ? 'text-green-400' : 'text-gray-500'}`}>
                        {user ? 'ğŸŸ¢ Online' : 'âš« Offline'}
                      </div>
                    </div>
                  </div>

                  {/* Login/Logout Button */}
                  <div className="mb-3">
                    {isAuthenticated ? (
                      <button
                        onClick={handleLogout}
                        className="w-full px-3 py-2 text-[10px] font-bold uppercase bg-[#2a2a30] hover:bg-[#35353c] text-gray-400 border border-[#3a3a42] rounded transition-colors"
                      >
                        ğŸšª Logout
                      </button>
                    ) : (
                      <button
                        onClick={() => { localStorage.removeItem("playingOffline"); setPlayingOffline(false); setAuthLoading(false); }}
                        className="w-full px-3 py-2 text-[10px] font-bold uppercase bg-[#d4a84b] hover:bg-[#f0c060] text-black rounded transition-colors"
                      >
                        ğŸ”‘ Login
                      </button>
                    )}
                  </div>

                  {/* HP Bar */}
                  <div className="mb-3">
                    <div className="flex justify-between text-[10px] mb-1">
                      <span className="text-red-400 font-bold">â¤ï¸ Health</span>
                      <span className="text-gray-400">{player.hp} / {player.maxHp}</span>
                    </div>
                    <div className="stat-bar h-2">
                      <div className="stat-fill bg-red-500" style={{ width: `${(player.hp / player.maxHp) * 100}%` }} />
                    </div>
                  </div>

                  {/* Active Potions */}
                  {activePotions.length > 0 && (
                    <div className="mb-3 p-2 bg-purple-900/20 border border-purple-700/30 rounded">
                      <div className="text-[9px] text-purple-400 font-bold mb-1">ACTIVE BUFFS</div>
                      <div className="space-y-1.5">
                        {activePotions.map((potion, idx) => {
                          const remaining = potion.durationMs - (Date.now() - potion.startedAt);
                          const remainingMin = Math.floor(remaining / 60000);
                          const remainingSec = Math.floor((remaining % 60000) / 1000);
                          const potionName = ITEMS_DATA[potion.potionId]?.name || potion.potionId;
                          const effectDesc = formatPotionEffect(potion.effect);
                          return (
                            <div key={idx} className="bg-purple-900/10 p-1 rounded border border-purple-700/20">
                              <div className="flex items-center justify-between text-[8px]">
                                <span className="text-purple-300 font-bold flex items-center gap-1"><ItemIcon itemId={potion.potionId} size="text-xs" /> {potionName}</span>
                                <span className="text-purple-400 font-mono">{remainingMin}:{remainingSec.toString().padStart(2, '0')}</span>
                              </div>
                              <div className="text-[7px] text-purple-400/80 mt-0.5">{effectDesc}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {/* Combat Stats Row */}
                  <div className="grid grid-cols-2 gap-2 text-[10px]">
                    <div className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30]">
                      <div className="text-gray-500 text-[9px] uppercase mb-0.5">Attack</div>
                      <div className="font-bold text-amber-300">âš”ï¸ {equipmentStats.totalAttack}</div>
                      <div className="text-[8px] text-gray-600">{equipmentStats.baseAttack} + {equipmentStats.equipmentAttack}</div>
                    </div>
                    <div className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30]">
                      <div className="text-gray-500 text-[9px] uppercase mb-0.5">Defense</div>
                      <div className="font-bold text-blue-300">ğŸ›¡ï¸ {equipmentStats.equipmentDefense}</div>
                      <div className="text-[8px] text-gray-600">{equipmentStats.damageReductionPct}% reduction</div>
                    </div>
                  </div>
                </>
              )}

              {/* MAP VIEW - Island Navigation */}
              {adventurerView === 'map' && (
                <div className="space-y-2">
                  {/* Current Location Label */}
                  <div className="text-center text-[10px] text-gray-400">
                    Currently at: <span className="text-amber-400 font-bold capitalize">{player.location.replace(/-/g, " ")}</span>
                  </div>

                  {/* Travel Status */}
                  {isTraveling && (
                    <div className="text-center text-[10px] text-indigo-400 font-bold animate-pulse">
                      ğŸš¶ Traveling to {travelDestination.current?.replace(/-/g, " ")}...
                    </div>
                  )}

                  {/* Island Map */}
                  <div className="island-map">
                    {/* SVG Connection Lines */}
                    <svg className="map-connections" viewBox="0 0 100 100" preserveAspectRatio="none">
                      {Object.entries(LOCATION_ADJACENCY).map(([locA, adjacents]) =>
                        adjacents.map(locB => {
                          if (locA >= locB) return null;
                          const posA = LOCATION_MAP_DATA[locA]?.position;
                          const posB = LOCATION_MAP_DATA[locB]?.position;
                          if (!posA || !posB) return null;
                          const isActiveRoute =
                            (player.location === locA && isAdjacentLocation(locB)) ||
                            (player.location === locB && isAdjacentLocation(locA));
                          return (
                            <line
                              key={`${locA}-${locB}`}
                              x1={parseFloat(posA.left)}
                              y1={parseFloat(posA.top)}
                              x2={parseFloat(posB.left)}
                              y2={parseFloat(posB.top)}
                              className={isActiveRoute ? 'map-connection-line-active' : 'map-connection-line'}
                            />
                          );
                        })
                      )}
                    </svg>

                    {/* Location Nodes */}
                    {Object.entries(LOCATION_MAP_DATA).map(([locId, locData]) => {
                      const isCurrent = player.location === locId;
                      const isAdjacent = isAdjacentLocation(locId);
                      const isDestination = isTraveling && travelDestination.current === locId;
                      const canTravel = !isTraveling && isAdjacent && !isCurrent;

                      let nodeClass = 'map-node';
                      if (isCurrent) {
                        nodeClass += ' map-node-current';
                      } else if (isDestination) {
                        nodeClass += ' map-node-destination';
                      } else if (isTraveling) {
                        nodeClass += ' map-node-traveling';
                      } else if (isAdjacent) {
                        nodeClass += ' map-node-adjacent';
                      } else {
                        nodeClass += ' map-node-disabled';
                      }

                      return (
                        <button
                          key={locId}
                          onClick={() => canTravel && startTravel(locId)}
                          disabled={!canTravel}
                          className={nodeClass}
                          style={{
                            top: locData.position.top,
                            left: locData.position.left
                          }}
                          title={`${locData.name}${isCurrent ? ' (You are here)' : isAdjacent ? ' - Click to travel' : ' - Not adjacent'}`}
                        >
                          <span>{locData.icon}</span>
                          <span className="map-node-label">{locData.name}</span>
                        </button>
                      );
                    })}
                  </div>

                  {/* Legend */}
                  <div className="flex justify-center gap-3 text-[8px] text-gray-500 mt-2">
                    <span><span className="inline-block w-2 h-2 rounded-full bg-amber-500 mr-1"></span>Current</span>
                    <span><span className="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Adjacent</span>
                    <span><span className="inline-block w-2 h-2 rounded-full bg-gray-600 mr-1"></span>Distant</span>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Skills/Quests Section */}
          <div className="space-y-2">
          {/* SKILLS / QUESTS TABS */}
          <div className="flex gap-1 mb-2">
            {['skills', 'quests'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveLeftTab(tab)}
                className={`flex-1 px-2 py-1.5 rounded text-[10px] font-bold uppercase tracking-wide transition-colors ${
                  activeLeftTab === tab
                    ? 'bg-amber-600/80 text-black'
                    : 'bg-[#2a2a30] text-gray-500 hover:text-gray-300 hover:bg-[#35353d]'
                }`}
              >
                {tab}
              </button>
            ))}
          </div>

          {/* Skills Panel - shown when Skills tab is active */}
          {activeLeftTab === 'skills' && (
            <div className="panel">
              <div className="panel-header">
                <div className="flex justify-between items-center">
                  <span className="text-[10px] font-bold text-gray-400 uppercase">Skills</span>
                  <span className="text-[9px] text-gray-500">Total: <span className="text-gray-300">{ALL_PLAYER_SKILLS.reduce((sum, skill) => sum + player.skills[skill].level, 0)}</span></span>
                </div>
              </div>
              <div className="panel-body space-y-2">
                {/* Combat Level Display */}
                <div className="flex justify-between items-center bg-[#1e1e22] p-2 rounded border border-[#2a2a30] mb-2">
                  <span className="text-[10px] text-amber-400 font-bold">âš”ï¸ Combat Level</span>
                  <span className="text-[12px] font-bold text-amber-300">{equipmentStats.combatLevel}</span>
                </div>

                {/* Combat Skills */}
                <div className="text-[9px] text-amber-400/70 uppercase font-bold mb-1">Combat</div>
                {[...COMBAT_STATS, "strength"].map(skill => {
                  const s = player.skills[skill];
                  return (
                    <div key={skill} className="flex items-center gap-2">
                      <span className="text-[10px] w-16 capitalize text-amber-300/80">{skill}</span>
                      <span className="text-[10px] font-bold text-white w-5">{s.level}</span>
                      <div className="flex-1 stat-bar h-1">
                        <div className="stat-fill bg-amber-500/70" style={{ width: `${(s.exp / s.expToNext) * 100}%` }} />
                      </div>
                      <span className="text-[8px] text-gray-500 w-14 text-right">{s.exp}/{s.expToNext}</span>
                    </div>
                  );
                })}

                {/* Gathering Skills */}
                <div className="text-[9px] text-gray-400/70 uppercase font-bold mt-3 mb-1">Gathering</div>
                {ALL_SKILLS.filter(s => s !== "strength").map(skill => {
                  const s = player.skills[skill];
                  return (
                    <div key={skill} className="flex items-center gap-2">
                      <span className="text-[10px] w-16 capitalize text-gray-400">{skill}</span>
                      <span className="text-[10px] font-bold text-white w-5">{s.level}</span>
                      <div className="flex-1 stat-bar h-1">
                        <div className="stat-fill bg-gray-500" style={{ width: `${(s.exp / s.expToNext) * 100}%` }} />
                      </div>
                      <span className="text-[8px] text-gray-500 w-14 text-right">{s.exp}/{s.expToNext}</span>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* QUEST UI (LEFT PANEL) - shown when Quests tab is active */}
          {activeLeftTab === 'quests' && (
            <div className="space-y-3">
              {/* Available Quests */}
              {quests.filter(q => q.status === 'available').length > 0 && (
                <div className="panel">
                  <div className="panel-header">
                    <span className="text-[10px] font-bold text-amber-300/80 uppercase">Available Quests</span>
                  </div>
                  <div className="panel-body space-y-2">
                    {quests.filter(q => q.status === 'available').map(quest => (
                      <div key={quest.id} className="bg-[#1e1e22] p-2 rounded border border-[#2a2a30]">
                        <div className="text-[11px] font-bold text-gray-200 mb-1">{quest.name}</div>
                        <div className="text-[9px] text-gray-500 mb-2">{quest.description}</div>
                        <div className="text-[8px] text-gray-400 mb-2">
                          {quest.objectives.map((obj, idx) => (
                            <div key={idx}>
                              {obj.type === 'kill' && `â€¢ Kill ${obj.required} ${obj.target}`}
                              {obj.type === 'gather' && `â€¢ Gather ${obj.required} ${ITEMS_DATA[obj.target]?.name || obj.target}`}
                              {obj.type === 'skill_level' && `â€¢ Reach ${obj.skill} level ${obj.required}`}
                            </div>
                          ))}
                        </div>
                        <button
                          onClick={() => acceptQuest(quest.id)}
                          className="w-full px-2 py-1 bg-amber-600/80 hover:bg-amber-500/80 text-black text-[9px] font-bold rounded transition-colors"
                        >
                          Accept Quest
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Active Quests */}
              {quests.filter(q => q.status === 'active' || q.status === 'completed').length > 0 && (
                <div className="panel">
                  <div className="panel-header">
                    <span className="text-[10px] font-bold text-emerald-300/80 uppercase">Active Quests</span>
                  </div>
                  <div className="panel-body space-y-2">
                    {quests.filter(q => q.status === 'active' || q.status === 'completed').map(quest => (
                      <div key={quest.id} className={`bg-[#1e1e22] p-2 rounded border ${quest.status === 'completed' ? 'border-emerald-500/50' : 'border-[#2a2a30]'}`}>
                        <div className="flex justify-between items-start mb-1">
                          <div className="text-[11px] font-bold text-gray-200">{quest.name}</div>
                          {quest.objectives.every(obj => obj.current >= obj.required) && <span className="text-[8px] text-emerald-400 font-bold">COMPLETE</span>}
                        </div>
                        <div className="space-y-1 mb-2">
                          {quest.objectives.map((obj, idx) => {
                            const isComplete = obj.current >= obj.required;
                            return (
                              <div key={idx}>
                                <div className="flex justify-between text-[9px] mb-0.5">
                                  <span className={isComplete ? 'text-emerald-400' : 'text-gray-400'}>
                                    {isComplete && 'âœ“ '}
                                    {obj.type === 'kill' && `Kill ${obj.target}`}
                                    {obj.type === 'gather' && `Gather ${ITEMS_DATA[obj.target]?.name || obj.target}`}
                                    {obj.type === 'skill_level' && `Reach ${obj.skill} level ${obj.required}`}
                                  </span>
                                  <span className={isComplete ? 'text-emerald-400' : 'text-gray-500'}>
                                    {obj.current}/{obj.required}
                                  </span>
                                </div>
                                <div className="stat-bar h-1">
                                  <div
                                    className={`stat-fill ${isComplete ? 'bg-emerald-500' : 'bg-amber-500/70'}`}
                                    style={{ width: `${Math.min(100, (obj.current / obj.required) * 100)}%` }}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        {quest.objectives.every(obj => obj.current >= obj.required) && (
                          <button
                            onClick={() => turnInQuest(quest.id)}
                            className="w-full px-2 py-1 bg-emerald-600/80 hover:bg-emerald-500/80 text-black text-[9px] font-bold rounded transition-colors"
                          >
                            Turn In Quest
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Completed Quests */}
              {quests.filter(q => q.status === 'turned_in').length > 0 && (
                <div className="panel">
                  <div className="panel-header">
                    <span className="text-[10px] font-bold text-gray-500 uppercase">Completed Quests</span>
                  </div>
                  <div className="panel-body space-y-1">
                    {quests.filter(q => q.status === 'turned_in').map(quest => (
                      <div key={quest.id} className="flex items-center gap-2 text-[10px] text-gray-500">
                        <span className="text-emerald-600">âœ“</span>
                        <span>{quest.name}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Empty state */}
              {quests.filter(q => q.status !== 'turned_in').length === 0 && quests.filter(q => q.status === 'turned_in').length === 0 && (
                <div className="panel">
                  <div className="panel-body text-center text-[10px] text-gray-500 py-4">
                    No quests available
                  </div>
                </div>
              )}
            </div>
          )}
          </div>{/* End skills/quests section */}

          {/* Equipment Panel - always visible */}
          <div className="panel">
            <div className="panel-header">
              <span className="text-[10px] font-bold text-gray-400 uppercase">Equipment</span>
            </div>
            <div className="panel-body">
              <div className="grid grid-cols-4 gap-1">
                {['weapon', 'head', 'body', 'legs', 'boots', 'offhand', 'accessory', 'tool'].map(slot => {
                  const item = player.equipment[slot];
                  const itemData = item ? ITEMS_DATA[item] : null;
                  return (
                    <button
                      key={slot}
                      onClick={() => item && unequipItem(slot)}
                      className="item-slot group"
                      title={item ? `${getItemName(item)} - Click to unequip` : slot}
                    >
                      {item ? (
                        <ItemIcon itemId={item} size="text-xl" />
                      ) : (
                        <span className="text-[8px] text-gray-600 uppercase">{slot.slice(0, 3)}</span>
                      )}
                      {item && (
                        <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-black/90 rounded flex items-center justify-center transition-opacity z-10">
                          <div className="text-[7px] text-center p-1">
                            <div className="text-gray-200">{getItemName(item)}</div>
                            {itemData?.attack && <div className="text-amber-400">+{itemData.attack} ATK</div>}
                            {itemData?.defense && <div className="text-blue-400">+{itemData.defense} DEF</div>}
                            {itemData && itemData.bonus && itemData.bonus.skill && (
                              <div className="text-yellow-400 mt-0.5">Reduces {itemData.bonus.skill} time by {Math.round((1 - itemData.bonus.multiplier) * 100)}%</div>
                            )}
                          </div>
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>

              {/* Familiars */}
              <div className="text-[9px] text-purple-400/70 uppercase font-bold mt-3 mb-1">Familiars</div>
              <div className="grid grid-cols-3 gap-1">
                {[1, 2, 3].map(slotNum => {
                  const slot = `familiar${slotNum}`;
                  const item = player.equipment[slot];
                  const itemData = item ? ITEMS_DATA[item] : null;
                  const isUnlocked = isFamiliarSlotUnlocked(slotNum);
                  const reqLevel = slotNum * 10;
                  return (
                    <button
                      key={slot}
                      onClick={() => item && isUnlocked && unequipItem(slot)}
                      disabled={!isUnlocked}
                      className={`item-slot group ${!isUnlocked ? 'opacity-40 bg-red-900/20' : ''}`}
                      title={!isUnlocked ? `Requires Combat Lvl ${reqLevel}` : item ? getItemName(item) : 'Empty'}
                    >
                      {!isUnlocked ? (
                        <span className="text-[8px] text-red-400">ğŸ”’{reqLevel}</span>
                      ) : item ? (
                        <ItemIcon itemId={item} size="text-xl" />
                      ) : (
                        <span className="text-[8px] text-gray-600">F{slotNum}</span>
                      )}
                      {item && (
                        <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-black/90 rounded flex items-center justify-center transition-opacity z-10">
                          <div className="text-[7px] text-center p-1">
                            <div className="text-gray-200">{getItemName(item)}</div>
                            {itemData?.attack && <div className="text-amber-400">+{itemData.attack} ATK</div>}
                            {itemData?.defense && <div className="text-blue-400">+{itemData.defense} DEF</div>}
                          </div>
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
          </div>{/* End mobile-side-by-side */}
        </div>
      );

      /* ============================================
         CENTER COLUMN - WORLD / ACTIVITY PANEL
         Contains: Activity Status, Combat, Skilling, Shop, Blacksmith
         ============================================ */
      const renderWorldPanel = () => (
        <div className="space-y-3">
          {/* SCENE IMAGE PANEL - Visual state indicator */}
          {renderScenePanel()}

          {/* PLAYERS HERE PANEL - Shows other players at this location */}
          {renderPlayersHere()}

          {/* Current Activity Status */}
          <div className="panel">
            <div className="panel-body">
              <div className="text-[10px] text-gray-500 uppercase font-bold mb-2">Current Activity</div>
              {isTraveling ? (
                <>
                  <div className="text-indigo-400 font-bold">ğŸš¶ Traveling to {travelDestination.current?.replace(/-/g, " ")}...</div>
                  <div className="mt-3">
                    <ProgressBar
                      progress={travelProgress}
                      color="bg-indigo-500"
                      label={`Traveling to ${travelDestination.current?.replace(/-/g, " ")}...`}
                      sublabel={`${Math.ceil((TRAVEL_DURATION * (1 - travelProgress / 100)) / 1000)}s`}
                    />
                  </div>
                </>
              ) : enemy ? (
                <div className="text-amber-400 font-bold">âš”ï¸ Fighting {enemy.name}</div>
              ) : activeSkill ? (
                // Show raw resource being cooked (e.g., "Cooking Shrimp") when cooking
                activeSkill === 'cooking' && activeResource ? (
                  <div className="text-green-400 font-bold">ğŸ”¥ Cooking {activeResource.resourceName || getItemName(activeResource.raw || activeResource.id)}</div>
                ) : activeSkill === 'herblore' && activeResource && activeResource.name ? (
                  <div className="text-green-400 font-bold">ğŸ§ª Crafting {activeResource.resourceName}</div>
                ) : (
                  <div className="text-green-400 font-bold">ğŸ”¨ {activeSkill.charAt(0).toUpperCase() + activeSkill.slice(1)}{activeResource ? ` - ${activeResource.resourceName || getItemName(activeResource.id)}` : ''}</div>
                )
              ) : respawnCountdown > 0 ? (
                <div className="text-gray-400">â³ Waiting for respawn... {respawnCountdown}s</div>
              ) : (
                <div className="text-gray-500 italic">Idle - Select an activity below</div>
              )}

              {/* Skilling Progress */}
              {activeSkill && !enemy && !isTraveling && (
                <div className="mt-3">
                  <ProgressBar
                    progress={progress}
                    color="bg-green-500"
                    label={(() => {
                      const toolItem = player.equipment && player.equipment.tool ? ITEMS_DATA[player.equipment.tool] : null;
                      const bonusPct = toolItem && toolItem.bonus && toolItem.bonus.skill === activeSkill ? Math.round((1 - toolItem.bonus.multiplier) * 100) : null;
                      const baseLabel = activeSkill === 'cooking' && activeResource
                        ? `ğŸ”¥ Cooking ${activeResource.resourceName || getItemName(activeResource.raw || activeResource.id)}...`
                        : activeSkill === 'herblore' && activeResource && activeResource.name
                        ? `ğŸ§ª Crafting ${activeResource.resourceName}...`
                        : (activeResource ? `Gathering ${activeResource.resourceName || getItemName(activeResource.id)}...` : `Training ${activeSkill}...`);
                      return (
                        <span className="flex items-center justify-between">
                          <span>{baseLabel}</span>
                          {bonusPct ? <span className="text-[10px] text-yellow-300">Tool: -{bonusPct}%</span> : null}
                        </span>
                      );
                    })()}
                    sublabel={`${Math.ceil(((activeResource?.interval || TRAIN_DURATION) * ((player.equipment && player.equipment.tool && ITEMS_DATA[player.equipment.tool] && ITEMS_DATA[player.equipment.tool].bonus && ITEMS_DATA[player.equipment.tool].bonus.skill === activeSkill) ? ITEMS_DATA[player.equipment.tool].bonus.multiplier : 1) / 1000) * (1 - progress / 100))}s`}
                  />
                </div>
              )}
            </div>
          </div>

          {/* Combat Section - Disabled during travel */}
          <div className={`panel combat-panel ${isTraveling ? 'opacity-50 pointer-events-none' : ''}`}>
            <div className="panel-header flex justify-between items-center bg-red-900/10">
              <span className="text-[10px] font-bold text-red-400 uppercase">Combat</span>
              <div className="flex items-center gap-2">
                <select
                  value={selectedCombatSkill}
                  onChange={e => setSelectedCombatSkill(e.target.value)}
                  className="bg-[#1a1a1e] text-white text-[11px] px-2 py-1 rounded border border-[#3a3a42] outline-none"
                >
                  {COMBAT_STATS.concat("strength").map(stat => (
                    <option key={stat} value={stat}>{stat.charAt(0).toUpperCase() + stat.slice(1)}</option>
                  ))}
                </select>
                <button
                  onClick={() => setAutoCombatEnabled(!autoCombatEnabled)}
                  className={`px-3 py-1 rounded text-[11px] font-bold border ${
                    autoCombatEnabled
                      ? 'bg-green-900/30 text-green-400 border-green-700/50'
                      : 'bg-[#2a2a30] text-gray-500 border-[#3a3a42]'
                  }`}
                >
                  Auto: {autoCombatEnabled ? 'ON' : 'OFF'}
                </button>
                <button
                  onClick={() => setAutoEatEnabled(!autoEatEnabled)}
                  className={`px-3 py-1 rounded text-[11px] font-bold border ${
                    autoEatEnabled
                      ? 'bg-green-900/30 text-green-400 border-green-700/50'
                      : 'bg-[#2a2a30] text-gray-500 border-[#3a3a42]'
                  }`}
                  title="Toggle auto-eat during combat"
                >
                  Eat: {autoEatEnabled ? 'ON' : 'OFF'}
                </button>
                {autoEatEnabled && (
                  <>
                    <select
                      value={autoEatFood}
                      onChange={(e) => setAutoEatFood(e.target.value)}
                      className="bg-[#1a1a1e] text-white text-[9px] px-1.5 py-0.5 rounded border border-[#3a3a42] outline-none"
                      title="Select food to auto-eat"
                    >
                      <option value="cooked_shrimp">Shrimp (200)</option>
                      <option value="cooked_trout">Trout (500)</option>
                      <option value="minor_healing_potion">Minor Healing Potion (500)</option>
                      <option value="cooked_frog_legs">Frog Legs (800)</option>
                      <option value="cooked_salmon">Salmon (1000)</option>
                    </select>
                    <input
                      type="number"
                      value={autoEatThreshold}
                      onChange={(e) => setAutoEatThreshold(Math.max(1, Math.min(100, parseInt(e.target.value) || 60)))}
                      min="1"
                      max="100"
                      className="bg-[#1a1a1e] text-white text-[9px] px-1.5 py-0.5 rounded border border-[#3a3a42] outline-none w-12"
                      placeholder="%"
                      title="HP % threshold to trigger auto-eat"
                    />
                    <span className="text-[9px] text-gray-400">%</span>
                  </>
                )}
              </div>
            </div>

            <div className="panel-body">
              {enemy ? (
                /* Active Combat */
                <div className="space-y-3">
                  {/* HP Bars */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-[10px] text-gray-400 mb-1">ğŸ‘¤ You</div>
                      <ProgressBar progress={(player.hp / player.maxHp) * 100} color="bg-red-500" sublabel={`${player.hp}/${player.maxHp}`} />
                    </div>
                    <div className="text-right">
                      <div className="text-[10px] text-gray-400 mb-1">{enemy.name} (Lvl {enemy.level})</div>
                      <ProgressBar progress={(enemy.hp / enemy.maxHp) * 100} color="bg-red-600" sublabel={`${enemy.hp}/${enemy.maxHp}`} />
                    </div>
                  </div>

                  {/* Attack Timer */}
                  {autoCombatEnabled && combatStartTime.current && (
                    <ProgressBar progress={combatProgress} color="bg-amber-400" label="Next Attack" />
                  )}

                  {/* Combat Actions */}
                  <div className="flex gap-2">
                    <button onClick={attackEnemy} className="flex-1 btn-primary py-2 rounded text-[11px] font-bold uppercase">
                      âš”ï¸ Attack
                    </button>
                    <button onClick={() => setEnemy(null)} className="px-4 py-2 btn-action rounded text-[11px] font-bold text-gray-400">
                      Run
                    </button>
                  </div>

                  {/* Healing Items */}
                  <div className="flex flex-wrap gap-1.5 pt-2 border-t border-[#2a2a30]">
                    {Object.keys(player.inventory)
                      .filter(k => ITEMS_DATA[k]?.heal && player.inventory[k] > 0)
                      .sort((a, b) => (ITEMS_DATA[a]?.heal || 0) - (ITEMS_DATA[b]?.heal || 0))
                      .map(foodKey => {
                        const healAmount = ITEMS_DATA[foodKey]?.heal || 0;
                        const isPotion = POTION_RECIPES.some(r => r.name === foodKey) || foodKey === 'minor_healing_potion';
                        return (
                          <button
                            key={foodKey}
                            onClick={() => isPotion ? usePotion(foodKey) : useFood(foodKey)}
                            disabled={player.hp === player.maxHp}
                            className="flex flex-col items-center justify-center gap-0.5 rounded text-[8px] font-bold disabled:opacity-30 bg-orange-900/20 border border-orange-700/30 text-orange-300 w-[56px] h-[56px]"
                          >
                            <div className="flex items-center gap-1">
                              <ItemIcon itemId={foodKey} size="text-sm" /> {player.inventory[foodKey]}
                            </div>
                            <div className="text-[9px] font-bold text-green-400">+{healAmount}</div>
                          </button>
                        );
                      })}
                  </div>

                  {/* Combat Buff Potions Section (excludes skilling potions) */}
                  {Object.keys(player.inventory).filter(k => {
                    const potionRecipe = POTION_RECIPES.find(r => r.name === k);
                    const isSkilling = ['skill_speed', 'skill_xp', 'skill_efficiency'].includes(potionRecipe?.category);
                    return potionRecipe && potionRecipe.type === 'buff' && !isSkilling && player.inventory[k] > 0;
                  }).length > 0 && (
                    <div className="flex flex-wrap gap-1.5 pt-3 mt-3 border-t border-[#2a2a30]">
                      <div className="w-full text-[8px] text-purple-400 font-bold mb-1">COMBAT POTIONS</div>
                      {Object.keys(player.inventory)
                        .filter(k => {
                          const potionRecipe = POTION_RECIPES.find(r => r.name === k);
                          const isSkilling = ['skill_speed', 'skill_xp', 'skill_efficiency'].includes(potionRecipe?.category);
                          return potionRecipe && potionRecipe.type === 'buff' && !isSkilling && player.inventory[k] > 0;
                        })
                        .map(potionKey => {
                          const potionRecipe = POTION_RECIPES.find(r => r.name === potionKey);
                          const durationMin = Math.floor(potionRecipe.duration / 60000);
                          const effectLines = formatPotionEffectCompact(potionRecipe.effect);
                          const potionName = ITEMS_DATA[potionKey]?.name || potionKey;
                          const effectDesc = formatPotionEffect(potionRecipe.effect);
                          return (
                            <button
                              key={potionKey}
                              onClick={() => usePotion(potionKey)}
                              className="flex flex-col items-center gap-0.5 px-1.5 py-1 rounded text-[8px] font-bold bg-purple-900/20 border border-purple-700/30 text-purple-300 hover:bg-purple-900/30 w-[56px] h-[56px]"
                              title={`${potionName}: ${effectDesc}`}
                            >
                              <div className="flex items-center gap-1">
                                <ItemIcon itemId={potionKey} size="text-sm" /> {player.inventory[potionKey]}
                              </div>
                              <div className="text-[7px] text-purple-400 text-center leading-[8px] font-mono">
                                {effectLines.map((line, idx) => (
                                  <div key={idx}>{line}</div>
                                ))}
                              </div>
                              <div className="text-[6px] font-bold text-purple-500 mt-0.5">{durationMin}m</div>
                            </button>
                          );
                        })}
                    </div>
                  )}
                </div>
              ) : (
                /* Enemy Selection */
                <div>
                  {currentLocation.enemies.length === 0 ? (
                    <div className="text-center py-6 text-gray-500 text-[11px] italic">
                      ğŸŒ¿ This area is peaceful. No enemies here.
                    </div>
                  ) : (
                    <div className="space-y-1.5">
                      {currentLocation.enemies.map((e, i) => (
                        <button 
                          key={i}
                          onClick={() => startCombatTask(e)}
                          className="w-full btn-action p-2 rounded flex items-center justify-between group"
                        >
                          <div className="flex items-center gap-2">
                            <div className="text-left">
                              <div className="text-[11px] font-bold text-gray-200 group-hover:text-amber-400">{e.name}</div>
                              <div className="text-[9px] text-gray-500">Lvl {e.level} â€¢ HP {e.hp}</div>
                            </div>
                          </div>
                          <div className="text-[9px] text-gray-500">+{e.exp} XP</div>
                        </button>
                      ))}
                    </div>
                  )}

                  {/* Respawn Countdown */}
                  {respawnCountdown > 0 && autoCombatEnabled && (
                    <div className="mt-3 p-2 bg-[#1e1e22] rounded border border-[#2a2a30]">
                      <ProgressBar progress={((20 - respawnCountdown) / 20) * 100} color="bg-gray-500" label="Respawning..." sublabel={`${respawnCountdown}s`} />
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>

          {/* Skilling Activities (if location has skills) - Disabled during travel */}
          {currentLocation.skills.length > 0 && (
            <div className={`panel ${isTraveling ? 'opacity-50 pointer-events-none' : ''}`}>
              <div className="panel-header">
                <span className="text-[10px] font-bold text-gray-400 uppercase">Gathering</span>
              </div>
              <div className="panel-body space-y-3">
                {currentLocation.skills.map(skill => (
                  <div key={skill} className="bg-[#1e1e22] p-3 rounded border border-[#2a2a30]">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-[11px] font-bold capitalize text-gray-200">{skill}</span>
                      <span className="text-[9px] text-gray-500">Lvl {player.skills[skill].level}</span>
                    </div>

                    {RESOURCE_TIERS[skill] ? (
                      <div className="grid grid-cols-3 gap-1.5">
                        {RESOURCE_TIERS[skill].map(tier => {
                          const isLocked = player.skills[skill].level < tier.level;
                          const isActive = activeSkill === skill && activeResource?.id === tier.id && activeResource?.resourceName === tier.resourceName;
                          return (
                            <button
                              key={tier.resourceName || tier.id}
                              disabled={isLocked}
                              onClick={() => startTraining(skill, tier)}
                              className={`btn-action p-1.5 rounded text-left ${isLocked ? 'opacity-40' : ''} ${isActive ? 'ring-1 ring-amber-500' : ''}`}
                            >
                              <div className="text-[10px] font-bold text-gray-300">{tier.resourceName || getItemName(tier.id)}</div>
                              <div className="text-[8px] text-gray-500">{isLocked ? `Lvl ${tier.level}` : `+${tier.xp} XP`}</div>
                            </button>
                          );
                        })}
                      </div>
                    ) : (
                      <button onClick={() => startTraining(skill)} className="w-full btn-primary py-2 rounded text-[11px] font-bold">
                        Start {skill}
                      </button>
                    )}
                  </div>
                ))}

                {/* Skilling Potions Section */}
                {Object.keys(player.inventory).filter(k => {
                  const potionRecipe = POTION_RECIPES.find(r => r.name === k);
                  const isSkilling = ['skill_speed', 'skill_xp', 'skill_efficiency'].includes(potionRecipe?.category);
                  return potionRecipe && potionRecipe.type === 'buff' && isSkilling && player.inventory[k] > 0;
                }).length > 0 && (
                  <div className="flex flex-wrap gap-1.5 pt-3 mt-3 border-t border-[#2a2a30]">
                    <div className="w-full text-[8px] text-green-400 font-bold mb-1">SKILLING POTIONS</div>
                    {Object.keys(player.inventory)
                      .filter(k => {
                        const potionRecipe = POTION_RECIPES.find(r => r.name === k);
                        const isSkilling = ['skill_speed', 'skill_xp', 'skill_efficiency'].includes(potionRecipe?.category);
                        return potionRecipe && potionRecipe.type === 'buff' && isSkilling && player.inventory[k] > 0;
                      })
                      .sort((a, b) => {
                        const recipeA = POTION_RECIPES.find(r => r.name === a);
                        const recipeB = POTION_RECIPES.find(r => r.name === b);
                        return (recipeA?.level || 0) - (recipeB?.level || 0);
                      })
                      .map(potionKey => {
                        const potionRecipe = POTION_RECIPES.find(r => r.name === potionKey);
                        const durationMin = Math.floor(potionRecipe.duration / 60000);
                        const effectLines = formatPotionEffectCompact(potionRecipe.effect);
                        const potionName = ITEMS_DATA[potionKey]?.name || potionKey;
                        const effectDesc = formatPotionEffect(potionRecipe.effect);
                        return (
                          <button
                            key={potionKey}
                            onClick={() => usePotion(potionKey)}
                            className="flex flex-col items-center gap-0.5 px-1.5 py-1 rounded text-[8px] font-bold bg-green-900/20 border border-green-700/30 text-green-300 hover:bg-green-900/30 w-[56px] h-[56px]"
                            title={`${potionName}: ${effectDesc}`}
                          >
                            <div className="flex items-center gap-1">
                              <ItemIcon itemId={potionKey} size="text-sm" /> {player.inventory[potionKey]}
                            </div>
                            <div className="text-[7px] text-green-400 text-center leading-[8px] font-mono">
                              {effectLines.map((line, idx) => (
                                <div key={idx}>{line}</div>
                              ))}
                            </div>
                            <div className="text-[6px] font-bold text-green-500 mt-0.5">{durationMin}m</div>
                          </button>
                        );
                      })}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Village Shop */}
          {player.location === "starter-village" && (
            <div className="panel">
              <div className="panel-header flex justify-between items-center">
                <span className="text-[10px] font-bold text-gray-400 uppercase">Village Shop</span>
                <div className="flex gap-1">
                  {[1, 5, 10, 100].map(qty => (
                    <button
                      key={qty}
                      onClick={() => setShopQuantity(qty)}
                      className={`px-3 py-1 rounded text-[11px] font-bold ${
                        shopQuantity === qty
                          ? 'bg-amber-500/80 text-black'
                          : 'bg-[#2a2a30] text-gray-500'
                      }`}
                    >
                      x{qty}
                    </button>
                  ))}
                </div>
              </div>
              <div className="panel-body">
                <div className="grid grid-cols-2 gap-4">
                  {/* Buy Section */}
                  <div>
                    <div className="text-[9px] text-gray-500 uppercase font-bold mb-2">Buy</div>
                    <div className="space-y-1 max-h-[200px] overflow-y-auto">
                      {["minor_healing_potion", "sword", "bronze_shield", "iron_shield", "bronze_helmet", "bronze_platelegs", "bronze_platebody", "bronze_pickaxe", "iron_pickaxe", "bronze_axe", "iron_axe"].map(item => (
                        <button 
                          key={item} 
                          onClick={() => buyItem(item)} 
                          className="w-full btn-action p-1.5 rounded flex items-center justify-between text-left"
                        >
                          <div className="flex items-center gap-2">
                            <ItemIcon itemId={item} size="text-sm" />
                            <span className="text-[10px] text-gray-300">{getItemName(item)}</span>
                          </div>
                          <span className="text-[9px] text-amber-400">-{ITEMS_DATA[item].value * shopQuantity}g</span>
                        </button>
                      ))}
                    </div>
                  </div>
                  {/* Sell Section */}
                  <div>
                    <div className="text-[9px] text-gray-500 uppercase font-bold mb-2">Sell</div>
                    <div className="space-y-1 max-h-[200px] overflow-y-auto">
                      {Object.keys(player.inventory).filter(k => player.inventory[k] > 0).map(item => (
                        <button 
                          key={item} 
                          onClick={() => sellItem(item)} 
                          className="w-full btn-action p-1.5 rounded flex items-center justify-between text-left"
                        >
                          <div className="flex items-center gap-2">
                            <ItemIcon itemId={item} size="text-sm" />
                            <span className="text-[10px] text-gray-300">{getItemName(item)} <span className="text-gray-600">x{player.inventory[item]}</span></span>
                          </div>
                          <span className="text-[9px] text-green-400">+{Math.floor(ITEMS_DATA[item].value / 2) * Math.min(player.inventory[item], shopQuantity)}g</span>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Blacksmith */}
          {player.location === "blacksmith" && (
            <div className="panel">
              <div className="panel-header flex justify-between items-center">
                <span className="text-[10px] font-bold text-gray-400 uppercase">Blacksmith - Crafting</span>
                <select 
                  value={craftCategory} 
                  onChange={(e) => setCraftCategory(e.target.value)}
                  className="bg-[#1a1a1e] text-white text-[9px] px-2 py-1 rounded border border-[#3a3a42] outline-none"
                >
                  {["sword", "shield", "head", "chest", "legs", "boots", "amulet", "tool"].map(cat => (
                    <option key={cat} value={cat}>{cat === "sword" ? "Bronze Sword" : cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
                  ))}
                </select>
              </div>
              <div className="panel-body space-y-2 max-h-[300px] overflow-y-auto">
                {CRAFTING_RECIPES.filter(r => r.type === craftCategory).sort((a, b) => a.level - b.level).map(recipe => (
                  <div key={recipe.name} className="flex items-center justify-between bg-[#1e1e22] p-2 rounded border border-[#2a2a30]">
                    <div>
                      <div className="text-[11px] font-bold text-gray-200">{getItemName(recipe.name)} <span className="text-[9px] text-gray-500 font-normal">Lvl {recipe.level}</span></div>
                      <div className="text-[9px] text-gray-500">{Object.entries(recipe.cost).map(([k, v]) => `${v}x ${getItemName(k)}`).join(", ")}</div>
                    </div>
                    <button 
                      onClick={() => craftItem(recipe)} 
                      className="px-3 py-1 bg-orange-600 hover:bg-orange-500 rounded text-[10px] font-bold text-white"
                    >
                      Craft
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Home Section - Available in all locations */}
          <div className="panel home-panel">
            <div className="panel-header flex justify-between items-center bg-emerald-900/10">
              <div>
                <span className="text-[10px] font-bold text-emerald-400 uppercase">Home</span>
                {getCurrentHome() && (
                  <span className="text-[9px] text-gray-500 ml-2">ğŸ“ {player.location.replace(/-/g, " ")}</span>
                )}
              </div>
              {getCurrentHome() && (
                <div className="flex gap-1">
                  {["overview", "inventory", "farming"].map(view => (
                    <button
                      key={view}
                      onClick={() => setHomeView(view)}
                      className={`px-3 py-1 rounded text-[11px] font-bold ${
                        homeView === view
                          ? 'bg-emerald-500/80 text-black'
                          : 'bg-[#2a2a30] text-gray-500 hover:text-gray-300'
                      }`}
                    >
                      {view.charAt(0).toUpperCase() + view.slice(1)}
                    </button>
                  ))}
                </div>
              )}
            </div>
            <div className="panel-body">
              {(() => {
                const home = getCurrentHome();

                // No home - show build options
                if (!home) {
                  return (
                    <div className="space-y-2">
                      <div className="text-[11px] text-gray-400 mb-3">
                        Build a home here to unlock storage and farming plots.
                      </div>
                      {HOME_TIERS.map(tier => {
                        const check = canBuildHome(tier.tier);
                        return (
                          <div key={tier.tier} className={`p-3 rounded border ${check.canBuild ? 'border-emerald-600/50 bg-emerald-900/10' : 'border-gray-700/50 bg-gray-900/10 opacity-60'}`}>
                            <div className="flex justify-between items-center">
                              <div>
                                <div className="text-[12px] font-bold text-gray-200">Tier {tier.tier} Home</div>
                                <div className="text-[9px] text-gray-500">
                                  {tier.plots} plots | {tier.inventorySlots} storage slots
                                </div>
                                <div className="text-[9px] text-amber-400">
                                  Requires: Total Lvl {tier.totalLevelReq}, {tier.woodCost} Wood
                                </div>
                              </div>
                              <button
                                onClick={() => buildHome(tier.tier)}
                                disabled={!check.canBuild}
                                className={`px-3 py-1 rounded text-[10px] font-bold ${
                                  check.canBuild
                                    ? 'bg-emerald-600 hover:bg-emerald-500 text-white'
                                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                }`}
                              >
                                Build
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                }

                const config = getHomeTierConfig(home.tier);

                // Overview view
                if (homeView === "overview") {
                  const nextTier = home.tier < 3 ? getHomeTierConfig(home.tier + 1) : null;
                  const upgradeCheck = nextTier ? canBuildHome(home.tier + 1) : { canBuild: false };
                  const usedSlots = Object.keys(home.inventory).filter(k => home.inventory[k] > 0).length;
                  const activePlots = home.plots.filter(p => p.seedId).length;
                  const readyPlots = home.plots.filter(p => p.ready).length;

                  return (
                    <div className="space-y-3">
                      <div className="text-[14px] font-bold text-emerald-400">Tier {home.tier} Home</div>

                      <div className="grid grid-cols-2 gap-2 text-[10px]">
                        <div className="bg-[#1e1e22] p-2 rounded">
                          <div className="text-gray-500">Storage</div>
                          <div className="text-gray-200">{usedSlots} / {config.inventorySlots} slots</div>
                        </div>
                        <div className="bg-[#1e1e22] p-2 rounded">
                          <div className="text-gray-500">Farm Plots</div>
                          <div className="text-gray-200">
                            {activePlots} / {config.plots} in use
                            {readyPlots > 0 && <span className="text-green-400 ml-1">({readyPlots} ready!)</span>}
                          </div>
                        </div>
                      </div>

                      {nextTier && (
                        <div className="pt-2 border-t border-[#2a2a30]">
                          <div className="text-[10px] text-gray-400 mb-2">Upgrade to Tier {nextTier.tier}</div>
                          <div className="text-[9px] text-gray-500 mb-2">
                            {nextTier.plots} plots | {nextTier.inventorySlots} storage | Cost: {nextTier.woodCost} wood
                          </div>
                          <button
                            onClick={upgradeHome}
                            disabled={!upgradeCheck.canBuild}
                            className={`w-full py-2 rounded text-[11px] font-bold ${
                              upgradeCheck.canBuild
                                ? 'bg-emerald-600 hover:bg-emerald-500 text-white'
                                : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                            }`}
                          >
                            Upgrade Home
                          </button>
                        </div>
                      )}
                    </div>
                  );
                }

                // Inventory view
                if (homeView === "inventory") {
                  const usedSlots = Object.keys(home.inventory).filter(k => home.inventory[k] > 0).length;

                  return (
                    <div className="space-y-3 mobile-grid-2col">
                      <div className="col-span-full text-center mb-1">
                        <div className="text-[10px] text-gray-400">Home Storage ({usedSlots}/{config.inventorySlots} slots)</div>
                      </div>

                      {/* Player Inventory - Transfer TO Home */}
                      <div className="bg-[#1e1e22] p-2 rounded home-inv-section">
                        <div className="text-[9px] text-amber-400 font-bold mb-1">Your Inventory (Click to Store)</div>
                        <div className="inventory-grid max-h-[200px] overflow-y-auto">
                          {Object.entries(player.inventory).filter(([k, v]) => v > 0).map(([key, value]) => {
                            const itemData = ITEMS_DATA[key];
                            const isEquippable = itemData && itemData.slot;
                            const potionRecipe = POTION_RECIPES.find(r => r.name === key);
                            return (
                              <button
                                key={key}
                                onClick={() => transferToHome(key, 1)}
                                onContextMenu={(e) => { e.preventDefault(); transferToHome(key, value); }}
                                className="item-slot group relative"
                              >
                                <ItemIcon itemId={key} size="text-xl" />
                                <span className="absolute bottom-0 right-0 px-1 bg-black/80 text-[8px] font-bold text-gray-300 rounded-tl">{value}</span>
                                {/* Hover Tooltip */}
                                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-black/95 rounded flex items-center justify-center transition-opacity z-20 p-1">
                                  <div className="text-[7px] text-center leading-tight">
                                    <div className="text-gray-200 font-bold">{getItemName(key)}</div>
                                    {isEquippable && itemData.attack && <div className="text-amber-400">+{itemData.attack} ATK</div>}
                                    {isEquippable && itemData.defense && <div className="text-blue-400">+{itemData.defense} DEF</div>}
                                    {itemData?.heal && <div className="text-green-400">Heals {itemData.heal}</div>}
                                    {potionRecipe && potionRecipe.type === "buff" && (
                                      <div className="text-purple-400">{formatPotionEffect(potionRecipe.effect)}</div>
                                    )}
                                    {itemData?.value && <div className="text-gray-500">{itemData.value}g</div>}
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>

                      {/* Home Inventory - Transfer FROM Home */}
                      {/* HOME INVENTORY DRAG & DROP - Use ordered items */}
                      <div className="bg-[#1e1e22] p-2 rounded home-inv-section">
                        <div className="text-[9px] text-emerald-400 font-bold mb-1">Home Storage (Click to Retrieve, Drag to Reorder)</div>
                        <div className="inventory-grid max-h-[200px] overflow-y-auto">
                          {getOrderedHomeInventoryItems(home).map(key => {
                            const value = home.inventory[key];
                            if (value === 0) return null;
                            const itemData = ITEMS_DATA[key];
                            const isEquippable = itemData && itemData.slot;
                            const potionRecipe = POTION_RECIPES.find(r => r.name === key);
                            return (
                              <button
                                key={key}
                                draggable="true"
                                onDragStart={(e) => handleHomeDragStart(e, key)}
                                onDragOver={(e) => handleHomeDragOver(e, key)}
                                onDragLeave={handleHomeDragLeave}
                                onDrop={(e) => handleHomeDrop(e, key)}
                                onDragEnd={handleHomeDragEnd}
                                onClick={() => transferFromHome(key, 1)}
                                onContextMenu={(e) => { e.preventDefault(); transferFromHome(key, value); }}
                                className={`item-slot group relative ${draggedHomeItem === key ? 'dragging' : ''} ${dragOverHomeItem === key ? 'drag-over' : ''}`}
                              >
                                <ItemIcon itemId={key} size="text-xl" />
                                <span className="absolute bottom-0 right-0 px-1 bg-black/80 text-[8px] font-bold text-gray-300 rounded-tl">{value}</span>
                                {/* Hover Tooltip */}
                                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-black/95 rounded flex items-center justify-center transition-opacity z-20 p-1">
                                  <div className="text-[7px] text-center leading-tight">
                                    <div className="text-gray-200 font-bold">{getItemName(key)}</div>
                                    {isEquippable && itemData.attack && <div className="text-amber-400">+{itemData.attack} ATK</div>}
                                    {isEquippable && itemData.defense && <div className="text-blue-400">+{itemData.defense} DEF</div>}
                                    {itemData?.heal && <div className="text-green-400">Heals {itemData.heal}</div>}
                                    {potionRecipe && potionRecipe.type === "buff" && (
                                      <div className="text-purple-400">{formatPotionEffect(potionRecipe.effect)}</div>
                                    )}
                                    {itemData?.value && <div className="text-gray-500">{itemData.value}g</div>}
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                          {getOrderedHomeInventoryItems(home).length === 0 && (
                            <div className="col-span-full text-center text-gray-600 text-[10px] py-4">Empty</div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                }

                // Farming view
                if (homeView === "farming") {
                  const readyCount = home.plots.filter(p => p.ready).length;

                  return (
                    <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <div className="text-[10px] text-gray-400">
                          Farming Plots ({config.plots} total) | Farming Lvl {player.skills.farming?.level || 1}
                        </div>
                        {readyCount > 0 && (
                          <button
                            onClick={harvestAllCrops}
                            className="px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-[9px] font-bold text-white"
                          >
                            Harvest All ({readyCount})
                          </button>
                        )}
                      </div>

                      {/* Plot Grid */}
                      <div className="grid gap-[2px] max-h-[220px] overflow-y-auto p-1" style={{gridTemplateColumns: 'repeat(auto-fill, 64px)'}}>
                        {home.plots.map((plot, idx) => {
                          const isSelected = selectedPlotIndex === idx;

                          if (!plot.seedId) {
                            // Empty plot
                            return (
                              <button
                                key={idx}
                                onClick={() => setSelectedPlotIndex(isSelected ? null : idx)}
                                className={`aspect-square bg-[#1e1e22] border rounded flex items-center justify-center text-[10px] ${
                                  isSelected ? 'border-emerald-500 bg-emerald-900/20' : 'border-[#2a2a30] hover:border-[#3a3a40]'
                                }`}
                              >
                                <span className="text-gray-600 text-[8px]">+</span>
                              </button>
                            );
                          }

                          const crop = FARMING_CROPS.find(c => c.seedId === plot.seedId);

                          if (plot.ready) {
                            // Ready to harvest
                            return (
                              <button
                                key={idx}
                                onClick={() => harvestCrop(idx)}
                                className="aspect-square bg-green-900/30 border border-green-600/50 rounded flex items-center justify-center text-[11px] animate-pulse"
                                title={`Click to harvest ${ITEMS_DATA[crop?.cropId]?.name || 'crop'}`}
                              >
                                <ItemIcon itemId={crop?.cropId} size="text-sm" />
                              </button>
                            );
                          }

                          // Growing
                          const elapsed = Date.now() - plot.plantedAt;
                          const progress = Math.min((elapsed / plot.growthTime) * 100, 100);
                          const remaining = Math.max(0, plot.growthTime - elapsed);
                          const remainingMin = Math.ceil(remaining / 60000);

                          return (
                            <div
                              key={idx}
                              className="aspect-square bg-[#1e1e22] border border-amber-600/30 rounded flex flex-col items-center justify-center relative overflow-hidden"
                              title={`${ITEMS_DATA[plot.seedId]?.name || plot.seedId} - ${remainingMin}m remaining`}
                            >
                              <ItemIcon itemId={plot.seedId} size="text-sm" />
                              <div className="text-[6px] text-amber-400">{remainingMin}m</div>
                              {/* Progress bar at bottom */}
                              <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-800">
                                <div className="h-full bg-green-500" style={{ width: `${progress}%` }} />
                              </div>
                            </div>
                          );
                        })}
                      </div>


                      {/* Quick Plant Section - Always visible */}
                      {(() => {
                        const emptyPlotsCount = home.plots.filter(p => !p.seedId).length;
                        const availableSeeds = FARMING_CROPS.filter(crop => {
                          const hasSeeds = (player.inventory[crop.seedId] || 0) > 0;
                          const levelMet = (player.skills.farming?.level || 1) >= crop.level;
                          return hasSeeds && levelMet;
                        });
                        if (emptyPlotsCount > 0 && availableSeeds.length > 0) {
                          return (
                            <div className="bg-[#1e1e22] p-2 rounded border border-emerald-600/30 mb-2">
                              <div className="text-[9px] text-emerald-400 font-bold mb-2">Quick Plant ({emptyPlotsCount} empty plots)</div>
                              <div className="grid grid-cols-3 gap-1">
                                {FARMING_CROPS.map(crop => {
                                  const seedCount = player.inventory[crop.seedId] || 0;
                                  const hasSeeds = seedCount > 0;
                                  const levelMet = (player.skills.farming?.level || 1) >= crop.level;
                                  const canPlant = hasSeeds && levelMet;
                                  const plantCount = Math.min(seedCount, emptyPlotsCount);
                                  return (
                                    <button
                                      key={crop.seedId}
                                      onClick={() => plantAllSeeds(crop.seedId)}
                                      disabled={!canPlant}
                                      className={`p-1.5 rounded text-left ${canPlant ? 'bg-[#252528] hover:bg-emerald-900/40 border border-emerald-600/20' : 'opacity-40 bg-[#1a1a1e] cursor-not-allowed'}`}
                                    >
                                      <div className="text-[8px] font-bold text-gray-300">{ITEMS_DATA[crop.seedId]?.name?.replace(' Seed', '') || crop.seedId}</div>
                                      <div className="text-[7px] text-gray-500 flex justify-between">
                                        <span>{!levelMet ? `Lvl ${crop.level}` : `${Math.floor(crop.growthTime / 60000)}m`}</span>
                                        {hasSeeds && <span className="text-emerald-400">x{plantCount}</span>}
                                      </div>
                                    </button>
                                  );
                                })}
                              </div>
                              <div className="text-[7px] text-gray-500 mt-1 text-center">Click to plant all of that seed type</div>
                            </div>
                          );
                        }
                        return null;
                      })()}

                      {/* Single Plot Seed Selection (when plot selected) */}
                      {selectedPlotIndex !== null && !home.plots[selectedPlotIndex]?.seedId && (
                        <div className="bg-[#1e1e22] p-2 rounded border border-amber-600/30">
                          <div className="text-[9px] text-amber-400 font-bold mb-2">Plant Single Seed in Plot #{selectedPlotIndex + 1}</div>
                          <div className="grid grid-cols-3 gap-1">
                            {FARMING_CROPS.map(crop => {
                              const hasSeeds = (player.inventory[crop.seedId] || 0) > 0;
                              const levelMet = (player.skills.farming?.level || 1) >= crop.level;
                              return (
                                <button
                                  key={crop.seedId}
                                  onClick={() => plantSeed(selectedPlotIndex, crop.seedId)}
                                  disabled={!hasSeeds || !levelMet}
                                  className={`p-1.5 rounded text-left ${hasSeeds && levelMet ? 'bg-[#252528] hover:bg-[#2a2a30]' : 'opacity-40 bg-[#1a1a1e] cursor-not-allowed'}`}
                                >
                                  <div className="text-[9px] font-bold text-gray-300">{ITEMS_DATA[crop.seedId]?.name || crop.seedId}</div>
                                  <div className="text-[7px] text-gray-500">
                                    {!levelMet ? `Lvl ${crop.level}` : `${Math.floor(crop.growthTime / 60000)}m`}
                                    {hasSeeds && <span className="text-amber-400 ml-1">x{player.inventory[crop.seedId]}</span>}
                                  </div>
                                </button>
                              );
                            })}
                          </div>
                          <button
                            onClick={() => setSelectedPlotIndex(null)}
                            className="w-full mt-2 py-1 text-[9px] text-gray-500 hover:text-gray-300"
                          >
                            Cancel
                          </button>
                        </div>
                      )}
                    </div>
                  );
                }

                return null;
              })()}
            </div>
          </div>
        </div>
      );

      /* ============================================
         RIGHT COLUMN - INVENTORY + EVENT LOG
         ============================================ */
      
      // Helper to render log entries with item icons
      const renderLogEntry = (entry) => {
        if (typeof entry === 'string') return entry;
        if (entry.type === 'drop') {
          return (
            <span className="inline-flex items-center gap-1 flex-wrap">
              <span>{entry.prefix}</span>
              {entry.items.map((item, idx) => (
                <span key={idx} className="inline-flex items-center gap-0.5 bg-[#2a2a30] px-1 rounded">
                  <ItemIcon itemId={item.id} size="text-sm" />
                  <span className="text-amber-300">{item.name} x{item.qty}</span>
                  {idx < entry.items.length - 1 && <span>,</span>}
                </span>
              ))}
              {entry.suffix && <span>{entry.suffix}</span>}
            </span>
          );
        }
        return entry;
      };

      const renderRightPanel = () => (
        <div className="space-y-3 flex flex-col h-full lg:max-h-[calc(100vh-60px)]">
          <div className="mobile-side-by-side-2col">
          {/* Event Log */}
          <div className="panel flex flex-col h-[250px] lg:h-[280px] shrink-0">
            <div className="panel-header flex justify-between items-center">
              <span className="text-[10px] font-bold text-gray-400 uppercase">Event Log</span>
              <button onClick={() => setCombatLog([])} className="text-[9px] text-gray-500 hover:text-gray-300">Clear</button>
            </div>
            <div className="flex-1 overflow-y-auto p-2 flex flex-col text-[10px] text-gray-300 font-mono leading-relaxed">
              {combatLog.length === 0 ? (
                <div className="text-gray-600 italic text-center py-4">Waiting for action...</div>
              ) : (
                [...combatLog].reverse().map((entry, i) => (
                  <div key={i} className="py-1 border-b border-[#2a2a30] last:border-0">
                    {renderLogEntry(entry)}
                  </div>
                ))
              )}
            </div>
          </div>

          <div className="panel flex-1 flex flex-col min-h-0">
            <div className="panel-header flex gap-1">
              <button
                onClick={() => setActiveTab('inventory')}
                className={`flex-1 text-[10px] font-bold uppercase ${activeTab === 'inventory' ? 'text-amber-400' : 'text-gray-500'}`}
              >
                Inventory
              </button>
              <button
                onClick={() => setActiveTab('campfire')}
                className={`flex-1 text-[10px] font-bold uppercase ${activeTab === 'campfire' ? 'text-orange-400' : 'text-gray-500'}`}
              >
                Campfire
              </button>
              <button
                onClick={() => setActiveTab('herblore')}
                className={`flex-1 text-[10px] font-bold uppercase ${activeTab === 'herblore' ? 'text-purple-400' : 'text-gray-500'}`}
              >
                Herblore
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-2">
              {activeTab === 'inventory' && (
                <div className="inventory-grid">
                {/* INVENTORY DRAG & DROP - Use ordered items */}
                {getOrderedInventoryItems().map(key => {
                  const value = player.inventory[key];
                  if (value === 0) return null;
                  const itemData = ITEMS_DATA[key];
                  const isEquippable = itemData && itemData.slot;
                  const potionRecipe = POTION_RECIPES.find(r => r.name === key);
                  const isPotion = potionRecipe || key === "minor_healing_potion";
                  const isFood = itemData && itemData.heal && !isPotion;
                  const isChest = itemData && itemData.isChest;

                  return (
                    <button
                      key={key}
                      draggable="true"
                      onDragStart={(e) => handleInventoryDragStart(e, key)}
                      onDragOver={(e) => handleInventoryDragOver(e, key)}
                      onDragLeave={handleInventoryDragLeave}
                      onDrop={(e) => handleInventoryDrop(e, key)}
                      onDragEnd={handleInventoryDragEnd}
                      onClick={() => {
                        if (isEquippable) equipItem(key);
                        else if (isPotion) usePotion(key);
                        else if (isFood) useFood(key);
                        else if (isChest) openChest(key);
                      }}
                      className={`item-slot group ${draggedItem === key ? 'dragging' : ''} ${dragOverItem === key ? 'drag-over' : ''}`}
                    >
                      <ItemIcon itemId={key} size="text-xl" />
                      <span className="absolute bottom-0 right-0 px-1 bg-black/80 text-[8px] font-bold text-gray-300 rounded-tl">{value}</span>
                      {isEquippable && <div className="absolute top-0 right-0 w-1.5 h-1.5 bg-blue-400 rounded-full" />}
                      {isChest && <div className="absolute top-0 right-0 w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse" />}
                      {isPotion && <div className="absolute top-0 right-0 w-1.5 h-1.5 bg-purple-400 rounded-full" />}

                      {/* Hover Tooltip */}
                      <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-black/95 rounded flex items-center justify-center transition-opacity z-20 p-1">
                        <div className="text-[7px] text-center leading-tight">
                          <div className="text-gray-200 font-bold">{getItemName(key)}</div>
                          {isEquippable && (
                            <>
                              {itemData.attack && <div className="text-amber-400">+{itemData.attack} ATK</div>}
                              {itemData.defense && <div className="text-blue-400">+{itemData.defense} DEF</div>}
                              <div className="text-green-400 mt-0.5">Click to equip</div>
                            </>
                          )}
                          {itemData && itemData.bonus && itemData.bonus.skill && (
                            <div className="text-yellow-400 mt-0.5">Reduces {itemData.bonus.skill} time by {Math.round((1 - itemData.bonus.multiplier) * 100)}%</div>
                          )}
                          {isChest && <div className="text-amber-400">Click to open!</div>}
                          {potionRecipe && potionRecipe.type === "healing" && itemData?.heal && (
                            <>
                              <div className="text-green-400">Heals {itemData.heal} HP</div>
                              <div className="text-purple-300 mt-0.5">Click to drink</div>
                            </>
                          )}
                          {potionRecipe && potionRecipe.type === "buff" && (
                            <>
                              <div className="text-purple-400">{formatPotionEffect(potionRecipe.effect)}</div>
                              <div className="text-purple-300 mt-0.5">{Math.floor(potionRecipe.duration / 60000)}min duration</div>
                              <div className="text-purple-300 mt-0.5">Click to drink</div>
                            </>
                          )}
                          {!isPotion && itemData?.heal && <div className="text-green-400">Heals {itemData.heal}</div>}
                          {!isEquippable && !itemData?.heal && !isChest && !isPotion && <div className="text-gray-500">{itemData?.value}g</div>}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
              )}

              {/* Cooking Section */}
              {activeTab === 'campfire' && (
                <div>
                <div className="text-[9px] text-orange-400 uppercase font-bold mb-2">ğŸ”¥ Campfire</div>
                <div className="mobile-grid-2col">
                {[...COOKING_RECIPES].sort((a, b) => a.level - b.level).map(recipe => {
                  const hasRaw = player.inventory[recipe.raw] > 0;
                  const hasWood = player.inventory.wood > 0;
                  return (
                    <button
                      key={recipe.cooked}
                      onClick={() => cookItem(recipe)}
                      disabled={!hasRaw || !hasWood}
                      className={`p-1.5 rounded ${
                        hasRaw && hasWood
                          ? 'bg-[#1e1e22] hover:bg-[#252528] text-gray-300'
                          : 'opacity-40 text-gray-600'
                      }`}
                    >
                      <div className="flex items-center justify-between text-[10px]">
                        <span className="flex items-center gap-1">
                          <ItemIcon itemId={recipe.cooked} size="text-sm" />
                          <span>Cook {getItemName(recipe.raw)}</span>
                          <span className="text-[8px] text-gray-500">(Lvl {recipe.level})</span>
                        </span>
                        <span className="text-orange-400 font-bold">x{player.inventory[recipe.raw] || 0}</span>
                      </div>
                      <div className="flex items-center gap-1 mt-0.5 text-[7px] text-gray-500">
                        <span>Needs:</span>
                        <span className={hasRaw ? 'text-green-500' : 'text-red-500'}>1x {getItemName(recipe.raw)},</span>
                        <span className={hasWood ? 'text-green-500' : 'text-red-500'}>1x Wood</span>
                      </div>
                      <div className="text-[7px] text-green-400 mt-0.5">
                        Heals {ITEMS_DATA[recipe.cooked]?.heal || 0} HP
                      </div>
                    </button>
                  );
                })}
                </div>
              </div>
              )}

              {/* Herblore Potion Crafting Section */}
              {activeTab === 'herblore' && (
                <div>
                <div className="text-[9px] text-purple-400 uppercase font-bold mb-2">ğŸ§ª Herblore - Potion Crafting</div>
                <div className="mobile-grid-2col">
                {[...POTION_RECIPES].sort((a, b) => a.level - b.level).map(recipe => {
                  // Check if player has all ingredients
                  const recipeCost = recipe.cost || {};
                  let canCraft = true;
                  for (const [ingredientKey, requiredQty] of Object.entries(recipeCost)) {
                    if ((player.inventory[ingredientKey] || 0) < requiredQty) {
                      canCraft = false;
                      break;
                    }
                  }

                  // Format ingredients list
                  const ingredientsList = Object.entries(recipeCost).map(([ing, qty]) => {
                    const hasEnough = (player.inventory[ing] || 0) >= qty;
                    const ingName = ITEMS_DATA[ing]?.name || ing;
                    return { ing, qty, hasEnough, ingName };
                  });

                  return (
                    <button
                      key={recipe.name}
                      onClick={() => craftPotion(recipe)}
                      disabled={!canCraft}
                      className={`p-1.5 rounded ${
                        canCraft
                          ? 'bg-[#1e1e22] hover:bg-[#252528] text-gray-300'
                          : 'opacity-40 text-gray-600'
                      }`}
                    >
                      <div className="flex items-center justify-between text-[10px]">
                        <span className="flex items-center gap-1">
                          <ItemIcon itemId={recipe.name} size="text-sm" />
                          <span>{ITEMS_DATA[recipe.name]?.name || recipe.name}</span>
                          <span className="text-[8px] text-gray-500">(Lvl {recipe.level})</span>
                        </span>
                        <span className="text-purple-400 font-bold">x{player.inventory[recipe.name] || 0}</span>
                      </div>
                      <div className="flex items-center gap-1 mt-0.5 text-[7px] text-gray-500">
                        <span>Needs:</span>
                        {ingredientsList.map(({ ing, qty, hasEnough, ingName }, idx) => (
                          <span key={ing} className={hasEnough ? 'text-green-500' : 'text-red-500'}>
                            {qty}x {ingName}{idx < ingredientsList.length - 1 ? ',' : ''}
                          </span>
                        ))}
                      </div>
                      <div className="text-[7px] mt-0.5">
                        {recipe.type === 'healing' ? (
                          <span className="text-green-400">Heals {ITEMS_DATA[recipe.name]?.heal || 0} HP</span>
                        ) : recipe.effect ? (
                          <span className="text-purple-400">{formatPotionEffect(recipe.effect)} ({Math.floor(recipe.duration / 60000)}min)</span>
                        ) : null}
                      </div>
                    </button>
                  );
                })}
                </div>
              </div>
              )}

            </div>
          </div>
          </div>{/* Close mobile-side-by-side-2col wrapper */}
        </div>
      );

      /* ============================================
         MAIN RENDER - 3-COLUMN LAYOUT
         Top: Map/Navigation Bar
         Left: Player Panel (Stats, Skills, Equipment)
         Center: World Panel (Combat, Activities, Shop)
         Right: Inventory + Event Log
         ============================================ */

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // UI RENDERING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Show loading screen while checking auth
      if (authLoading) {
        return (
          <div className="fixed inset-0 bg-[#1a1a1f] flex items-center justify-center">
            <div className="text-center">
              <div className="text-2xl text-[#d4a84b] mb-2">Realm of Eternity</div>
              <div className="text-gray-400 text-sm">Loading...</div>
            </div>
          </div>
        );
      }

      // Show login screen if not authenticated, not playing offline, and authLoading is done
      if (!isAuthenticated && !playingOffline && !authLoading) {
        return renderLoginScreen();
      }

      return (
        <div className="game-root">
          {/* TOP BAR removed - navigation moved to Adventurer panel Map view */}

          {/* MAIN 3-COLUMN CONTENT */}
          <div className="main-content">
            {/* LEFT COLUMN - Player Panel */}
            <aside className="col-left scrollable-col">
              {renderPlayerPanel()}
            </aside>

            {/* CENTER COLUMN - World / Activity Panel */}
            <main className="col-center scrollable-col">
              {renderWorldPanel()}
            </main>

            {/* RIGHT COLUMN - Inventory + Event Log */}
            <aside className="col-right">
              {renderRightPanel()}
            </aside>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Game />);
  </script>
</body>

</html>